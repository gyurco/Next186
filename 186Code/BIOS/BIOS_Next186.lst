Microsoft (R) Macro Assembler Version 6.14.8444		    04/08/22 23:25:16
BIOS_Next186.asm					     Page 1 - 1


				; This file is part of the Next186 SoC PC project
				; http://opencores.org/project,next186

				; Filename: BIOS_Next186.asm
				; Description: Part of the Next186 SoC PC project, ROM BIOS code
				; Version 1.0
				; Creation date: Feb-Jun 2013

				; Author: Nicolae Dumitrache 
				; e-mail: ndumitrache@opencores.org

				; -------------------------------------------------------------------------------------
				 
				; Copyright (C) 2013 Nicolae Dumitrache
				 
				; This source file may be used and distributed without 
				; restriction provided that this copyright statement is not 
				; removed from the file and that any derivative work contains 
				; the original copyright notice and the associated disclaimer.
				 
				; This source file is free software; you can redistribute it 
				; and/or modify it under the terms of the GNU Lesser General 
				; Public License as published by the Free Software Foundation;
				; either version 2.1 of the License, or (at your option) any 
				; later version. 
				 
				; This source is distributed in the hope that it will be 
				; useful, but WITHOUT ANY WARRANTY; without even the implied 
				; warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR 
				; PURPOSE. See the GNU Lesser General Public License for more 
				; details. 
				 
				; You should have received a copy of the GNU Lesser General 
				; Public License along with this source; if not, download it 
				; from http://www.opencores.org/lgpl.shtml 
				 
				; -----------------------------------------------------------------------

				; Additional Comments: 
				; Assembled with MASM v6.14.8444
				; Next186 SoC PC have no ROM, only RAM. The bootstrap code is the initial value of cache 
				;  (last half 1K = 4 lines of 256bytes each), initially marked as "dirty", in order to
				;  be saved in RAM at first flush
				; The bootstrap code may load the BIOS from SD, or from RS232, and place it at F000:E000



				.186
				.model tiny
 0000				.code

 = 0001				SCANCODE1   equ 1

				;-------------------------- BIOS data area (BDA) -----------------
				;40:0000   2  Base port address of first RS-232 adapter (COM1) See COM Ports
				;40:0002   2  Port of COM2
				;40:0004   2  Port of COM3
				;40:0006   2  Port of COM4
				;40:0008   2  Base port addr of first parallel printer (LPT1)  Printer Ports
				;40:000A   2  Port of LPT2
				;40:000C   2  Port of LPT3
				;40:000E   2  Port of LPT4
				;40:0010   2  Equipment/hardware installed/active; see Equipment List
				;40:0012   1  Errors in PCjr infrared keyboard link
				;40:0013   2  Total memory in K-bytes (same as obtained via INT 12H)
				;40:0015   2  Scratch pad for manufacturing error tests
				;
				;40:0017   2  Keyboard status bits; see Keyboard Shift Status Flags
				;40:0019   1  Current (accumulating) value of Alt+numpad pseudo-key input;
				;             normally 0.  When [Alt] is released, value is stored in
				;             keyboard buffer at 001e.
				;40:001a   2  Addr of keyboard buffer head (keystroke at that addr is next)
				;40:001c   2  Address of keyboard buffer tail
				;40:001e  32  Keyboard buffer.  BIOS stores keystrokes here (head and tail
				;             point to addresses from 041eH to 043dH inclusive).
				;
				;40:003e   1  Diskette drive needs recalibration (bit 0=A, bit 1=B, etc.)
				;             bits 4-5 indicate which drive is currently selected
				;40:003f   1  Diskette motor is running (bit 0=drive A, bit 1=B, etc.)
				;40:0040   1  Time until motor off. INT 08H turns motor off when this is 0.
				;40:0041   1  Diskette error status; same as status returned by INT 13H
				;40:0042   7  Diskette controller status information area
				;
				;40:0049   1  Current active video mode.  See Video Modes and INT 10H.
				;40:004a   2  Screen width in text columns
				;40:004c   2  Length (in bytes) of video area (regen size)
				;40:004e   2  Offset from video segment of active video memory page
				;40:0050  16  Cursor location (8 byte-pairs; low byte=clm, hi byte=row)
				;40:0060   2  Cursor size/shape.  Low byte=end scan line; hi byte=start line.
				;40:0062   1  Current active video page number
				;40:0063   2  Port address for 6845 video controller chip; see CGA I/O Ports
				;40:0065   1  Current value of 6845 video ctrlr CRT_MODE (port 3x8H register)
				;40:0066   1  Current value of 6845 video ctrlr CRT_PALETTE (port 3x9H reg)
				;
				;40:0067   5  Cassette data area or POST data area
				;               40:0067: 1 byte mouse buffer counter (DataCounter)
				;               40:0068: 1 byte mouse packet size (PacketSize): 0 for 3 bytes, 1 for 4 bytes (Intellimouse)
				;				40:0069: 2 bytes palette offset during set video mode	
				;
				;40:006c   4  Timer tick counter (count of 55ms ticks since CPU reset)
				;40:0070   1  Timer overflow flag (timer has rolled over 24 hr)
				;40:0071   1  Ctrl-Break flag.  Bit 7=1 when break was pressed.  This never
				;             gets reset unless you do it yourself.
				;
				;40:0072   2  1234H means Ctrl+Alt+Del reboot is in progress.  BIOS checks
				;             this to avoid doing a "cold boot" with the time-consuming POST
				;             4321H means reset, preserving memory
				;             5678H, 9abcH, and abcdH (are internal PC Convertible codes)
				;
				;40:0074   4  PCjr diskette or AT hard disk control area
				;  (0074)   1 Status of last fixed-disk drive operation
				;  (0075)   1 Number of hard disk drives for AT
				;  (0077)   1 Hard disk port for XT.  See XT Hard Disk Ports.
				;40:0078   4  Printer time-out values (478H=Lpt1, 478H=Lpt2...)
				;40:007c   4  RS-232 time-out values  (47cH=Com1, 47dH=Com2...)
				;
				;40:0080   2  AT PS/2 keyboard buffer offset start address (usually 01eH)
				;40:0082   2                                   end address (usually 003eH)
				;
				;40:0084   1  EGA text rows-1  (maximum valid row value)
				;40:0085   2  EGA bytes per character (scan-lines/char used in active mode)
				;40:0087   1  EGA flags; see EgaMiscInfoRec
				;40:0088   1  EGA flags; see EgaMiscInfo2Rec
				;40:0089   1  VGA flags; see VgaFlagsRec
				;             See also:  EGA/VGA Data Areas
				;
				;40:008b   1  AT PS/2 Media control: data rate, step rate
				;40:008c   1  AT PS/2 Hard disk drive controller status
				;40:008d   1  AT PS/2 Hard disk drive error status
				;40:008e   1  AT PS/2 Hard disk drive interrupt control
				;
				;40:0090   1  AT PS/2 Disk media state bits for drive 0
				;40:0091   1                                for drive 1
				;40:0092   1  AT PS/2 Disk operation started flag for drive 0
				;40:0093   1                                      for drive 1

				;40:0094   1  AT PS/2 Present cylinder number for drive 0
				;40:0095   1                                  for drive 1
						; 2 - Number of 512bytes sectors of HD0
				;
				;40:0096   1  AT Keyboard flag bit 4=1 (10H) if 101-key keyboard is attached
				;40:0097   1  AT Keyboard flag for LED 'key lock' display
				;             bits 0-2 are ScrollLock, NumLock, CapsLock
				;
				;40:0098   4  AT Pointer to 8-bit user wait flag; see INT 15H 86H
				;40:009c   4  AT Microseconds before user wait is done
				;40:00a0   1  AT User wait activity flag:
				;                01H=busy, 80H=posted, 00H=acknowledged
				;
				;40:00a1   7  AT Reserved for network adapters
				;               40:00a1: 4 bytes far pointer to mouse callback (HandlerPtr)
				;               40:00a5: 3 bytes mouse buffer (DataBuffer)
				;
				;40:00a8   4  EGA Address of table of pointers; see EgaSavePtrRec
				;40:00ac  68  Reserved
				;40:00f0  16  (IAC) Inter-Aapplication Communication area.  Programs may use
				;             this area to store status, etc.  Might get overwritten by
				;             another program.

				; http://www.ctyme.com/intr/int.htm

				; video memory: 8 physical segments at 0a000h, 0b000h, 0c000h, 0d000h, 0e000h, 0f000h, 10000h, 11000h
				; Memory segments mapping
				; 1Mb virtual seg address   physical seg address
				;       0000h                   0000h
				;       1000h                   1000h
				;       2000h                   2000h
				;       3000h                   3000h
				;       4000h                   4000h
				;       5000h                   5000h
				;       6000h                   6000h
				;       7000h                   7000h
				;       8000h                   8000h
				;       9000h                   9000h
				;       a000h                   a000h       - video
				;       b000h                   b000h       - video
				;       c000h                   12000h
				;       d000h                   13000h
				;       e000h                   14000h
				;       f000h                   15000h


 = 0200				RAMSize   equ    200h        ; 64KB segments

				; Graphics character set
 = bios - 800h			font8x8		equ	bios - 800h        
 = font8x8 - 1000h		font8x16	equ	font8x8 - 1000h    
 = font8x16 - 0e00h		font8x14	equ	font8x16 - 0e00h


						org 0e000h
 E000				bios:        
 E000 4E 65 78 74 31 38		biosmsg     db 'Next186 MiST SoC PC BIOS (C) 2017 Nicolae Dumitrache', 0
       36 20 4D 69 53 54
       20 53 6F 43 20 50
       43 20 42 49 4F 53
       20 28 43 29 20 32
       30 31 37 20 4E 69
       63 6F 6C 61 65 20
       44 75 6D 69 74 72
       61 63 68 65 00
 E035 4D 42 20 53 44 20		msgmb       db 'MB SD Card', 13, 10, 0
       43 61 72 64 0D 0A
       00
 E042 50 53 32 20 4B 42		msgkb       db 'PS2 KB detected', 13, 10, 0
       20 64 65 74 65 63
       74 65 64 0D 0A 00

						org 0e05bh
 E05B				coldboot:
 E05B				warmboot:
 E05B  FA					cli
 E05C  FC					cld
 E05D  B8 0030					mov     ax, 30h
 E060  8E D0					mov     ss, ax
 E062  BC 0100					mov     sp, 100h
						
 E065  6A 00					push    0
 E067  9D					popf
						
 E068  B0 36					mov     al, 36h
 E06A  E6 43					out     43h, al
 E06C  33 C0					xor     ax, ax
 E06E  E7 07			        out     7, ax       ; NMIonIORQ_HI = 0
 E070  E6 40					out     40h, al
 E072  E6 40					out     40h, al      ; 18Hz PIT CH0
 E074  E6 61					out     61h, al      ; speaker off
 E076  F6 D0					not     al
 E078  E6 21					out     21h, al      ; disable all interrupts
 E07A  E6 A1					out		0a1h, al
 E07C  E7 06			        out     6, ax       ; NMIonIORQ_LO = 255 -> disabled
						

				; ------------------ MAP init
 E07E  B8 0015					mov     ax, 15h     ; BIOS physical segment 15h mapped on virtual segment 0ch
 E081  E7 8C					out     8ch, ax
 E083  68 C000					push    0c000h
 E086  07					pop     es
 E087  68 F000					push    0f000h
 E08A  1F					pop     ds
 E08B  33 F6					xor     si, si
 E08D  33 FF					xor     di, di
 E08F  B9 8000					mov     cx, 8000h
 E092  F3/ A5					rep     movsw       ; copy BIOS virtual segment 0fh over physical segment 15h

 E094  BA 0080					mov     dx, 80h      
 E097  33 C0					xor     ax, ax
 E099				mapi:        
 E099  EF					out     dx, ax
 E09A  40					inc     ax
 E09B  42					inc     dx
 E09C  3C 0C					cmp     al, 0ch
 E09E  75 02					jne     short mapi1
 E0A0  04 06					add     al, 6
 E0A2				mapi1:        
 E0A2  3C 16					cmp     al, 16h
 E0A4  75 F3					jne     short mapi
						
				; -------------------- Interrupt table init
 E0A6  6A 00					push    0
 E0A8  1F					pop     ds
 E0A9  1E					push    ds
 E0AA  07					pop     es
 E0AB  33 F6					xor     si, si
 E0AD  BF 0004					mov     di, 4
 E0B0  C7 04 F78B R				mov     word ptr [si], offset defint
 E0B4  8C 4C 02					mov     word ptr [si+2], cs
 E0B7  B9 00FE					mov     cx, 256-2
 E0BA  F3/ A5					rep     movsw
 E0BC  C7 06 001C E2F1 R			mov     word ptr ds:[7*4], offset int07
 E0C2  C7 06 0020 E321 R			mov     word ptr ds:[8*4], offset int08
 E0C8  C7 06 0024 E377 R			mov     word ptr ds:[9*4], offset int09
 E0CE  C7 06 0040 E59A R			mov     word ptr ds:[10h*4], offset int10        
 E0D4  C7 06 0044 EFCB R			mov     word ptr ds:[11h*4], offset int11        
 E0DA  C7 06 0048 EFD4 R			mov     word ptr ds:[12h*4], offset int12        
 E0E0  C7 06 004C EFDD R			mov     word ptr ds:[13h*4], offset int13        
 E0E6  C7 06 0050 F1CA R			mov     word ptr ds:[14h*4], offset int14        
 E0EC  C7 06 0054 F315 R			mov     word ptr ds:[15h*4], offset int15
 E0F2  C7 06 0058 F4CF R			mov     word ptr ds:[16h*4], offset int16
 E0F8  C7 06 0060 F5BA R			mov     word ptr ds:[18h*4], offset int18
 E0FE  C7 06 0064 F636 R			mov     word ptr ds:[19h*4], offset int19
 E104  C7 06 0068 F650 R			mov     word ptr ds:[1ah*4], offset int1a
 E10A  C7 06 01C0 F67C R			mov     word ptr ds:[70h*4], offset int70
 E110  C7 06 01D0 F6B4 R			mov     word ptr ds:[74h*4], offset int74

				; ------------------- BDA init
 E116  6A 40					push    40h
 E118  1F					pop     ds
 E119  1E					push    ds
 E11A  07					pop     es
 E11B  33 FF					xor     di, di
 E11D  33 F6					xor     si, si
 E11F  33 C0					xor     ax, ax
 E121  B1 80					mov     cl, 80h
 E123  F3/ AB					rep     stosw
 E125  C7 04 03F8				mov		word ptr [si+00h], 3f8h	 ; COM1 base port address
 E129  C7 44 08 0378				mov		word ptr [si+08h], 378h	 ; LPT1 base port address
 E12E  C6 44 10 24				mov     byte ptr [si+10h], 24h   ; equipment word (color 80x25, PS2 mouse present)
 E132  C7 44 13 0280				mov     word ptr [si+13h], 640   ; memory size in KB
 E137  83 44 1A 1E				add     word ptr [si+1ah], 1eh   ; next char pointer in kb buffer
 E13B  83 44 1C 1E				add     word ptr [si+1ch], 1eh   ; last char pointer in kb buffer
 E13F  C7 44 60 0E0F				mov     word ptr [si+60h], 0e0fh ; cursor shape
 E144  C7 44 63 03D4				mov     word ptr [si+63h], 3d4h  ; video port address
 E149  83 84 0080 1E				add     word ptr [si+80h], 1eh   ; start kb buffer
 E14E  83 84 0082 3E				add     word ptr [si+82h], 3eh   ; end kb buffer
 E153  C7 84 0087 0940				mov     word ptr [si+87h], 0940h ; video adapter options (512Kb video)
 E159  C7 84 0089 0B71				mov     word ptr [si+89h], 0b71h ; VGA video flags: 400 line text mode, default palette loading on (0), blinking on
 E15F  C6 84 0096 10				mov     byte ptr [si+96h], 10h   ; 101 keyboard installed
				 
				; ------------------- Graph mode init
 E164  B8 0003					mov     ax, 3
 E167  CD 10					int     10h

				 ; ------------------- KB init ----------------
 E169  B0 AE					mov     al, 0aeh
 E16B  E6 64					out     64h, al     ; enable kb
 E16D  B0 A7					mov     al, 0a7h
 E16F  E6 64					out     64h, al     ; disable mouse
 E171  B9 0019					mov     cx, 25
 E174				kbi1:       
 E174  E8 15DD					call    getps2byte
 E177  E2 FB					loop    short kbi1  ; wait for kb timeout
 E179  B4 FF					mov     ah, 0ffh    ; reset kb
 E17B  F8					clc                 ; kb command
 E17C  E8 15EF					call    sendcmd   
 E17F  72 31					jc      short nokb
 E181  B1 19					mov     cl, 25
 E183				kbi2:        
 E183  49					dec     cx
 E184  E3 2C					jcxz    short nokb
 E186  E8 15CB					call    getps2byte
 E189  72 F8					jc      short kbi2  ; wait for BAT
 E18B  3C AA					cmp     al, 0aah
 E18D  75 23					jne     short nokb
 E18F  B4 F2					mov     ah, 0f2h    ; kb id
 E191  E8 15DA					call    sendcmd     ; CF = 0
 E194  72 1C					jc      short nokb
 E196  E8 15BB					call    getps2byte
 E199  3C AB					cmp     al, 0abh
 E19B  75 15					jne     short nokb
 E19D  E8 15B4					call    getps2byte
 E1A0  3C 83					cmp     al, 83h
				; set scan code 1
				IFDEF SCANCODE1
 E1A2  75 0E					jne     short nokb
 E1A4  B4 F0					mov     ah, 0f0h    ; kb scan set
 E1A6  E8 15C5					call    sendcmd   
 E1A9  72 07					jc      short nokb
 E1AB  B4 01					mov     ah, 1       ; scan set 1
 E1AD  E8 15BE					call    sendcmd   
 E1B0  73 05					jnc     short kbok
				ELSE
				ENDIF        

 E1B2				nokb:   
 E1B2  C6 06 0096 00				mov     byte ptr KbdFlags3, 0   ; kb not present
 E1B7				kbok:
 E1B7  B0 AD					mov     al, 0adh
 E1B9  E6 64					out     64h, al      ; disable kb interface

				; ------------------- Mouse init ----------------
 E1BB  B0 A8					mov     al, 0a8h
 E1BD  E6 64					out     64h, al      ; enable mouse
 E1BF				mousei0:        
 E1BF  E8 1592					call    getps2byte
 E1C2  73 FB					jnc     short mousei0
 E1C4  B4 FF					mov     ah, 0ffh
 E1C6  E8 15A5					call    sendcmd      ; reset mouse (CF = 1)
 E1C9  72 15					jc      short nomouse
 E1CB  B1 19					mov     cl, 25
 E1CD				mousei1:        
 E1CD  49					dec     cx
 E1CE  E3 10					jcxz    short nomouse
 E1D0  E8 1581					call    getps2byte
 E1D3  72 F8					jc      short mousei1
 E1D5  3C AA					cmp     al, 0aah     ; BAT
 E1D7  75 07					jne     short nomouse
 E1D9  E8 1578					call    getps2byte
 E1DC  3C 00					cmp     al, 0        ; mouse ID
 E1DE  74 09					je      short mouseok
 E1E0				nomouse:
 E1E0  B0 A7					mov     al, 0a7h        
 E1E2  E6 64					out     64h, al      ; disable mouse
 E1E4  80 26 0010 FB				and     byte ptr EquipmentWord, not 4 ; ps2 mouse not present in equipement word
 E1E9				mouseok:
 E1E9  E8 1593					call    enableKbIfPresent

 E1EC  B0 20					mov     al, 20h
 E1EE  E6 64					out     64h, al
 E1F0  E4 60					in      al, 60h
 E1F2  0C 03					or      al, 3
 E1F4  8A E0					mov     ah, al
 E1F6  B0 60					mov     al, 60h
 E1F8  E6 64					out     64h, al
 E1FA  8A C4					mov     al, ah
 E1FC  E6 60					out     60h, al     ; enable 8042 mouse and kb interrupts

 E1FE  B8 0000					mov     ax, 0		; 1000-1   ; 1ms
 E201  E7 70					out     70h, ax     ; set RTC frequency (stop)

				;		mov     al, 0
 E203  E6 21					out     21h, al     ; enable all PIC interrupts (8h, 9h, 0ch)
 E205  E6 A1					out		0a1h, al	; enable all PIC interrupts (70h, 74h)
 E207  E6 01					out		1, al		; intialize COM mux
 E209  FB					sti                 ; enable CPU interrupts

				; ---------------------- COM flush
 E20A  B4 03			        mov     ah, 3       ; get serial port status
 E20C  33 D2			        xor     dx, dx      ; COM1
 E20E				COMFlush:
 E20E  CD 14			        int     14h
 E210  D0 EC			        shr     ah, 1
 E212  B4 02			        mov     ah, 2
 E214  72 F8			        jc      short COMFlush

				; ---------------------   HDD init
 E216  E8 173C					call    sdinit
 E219  A3 0094					mov     HDSize, ax
 E21C  0E					push    cs
 E21D  07					pop     es
 E21E  BE E000 R				mov     si, offset biosmsg
 E221  E8 1581					call    prts
 E224  BE E275 R				mov     si, offset bioscont
 E227  E8 157B					call    prts
 E22A  A1 0094					mov     ax, HDSize
 E22D  D1 E8					shr     ax, 1
 E22F  E8 155A					call    dispAX
 E232  BE E035 R				mov     si, offset msgmb
 E235  E8 156D					call    prts
 E238  F6 06 0096 10				test    byte ptr KbdFlags3, 10h
 E23D  74 06					jz      nokbmsg
 E23F  BE E042 R				mov     si, offset msgkb
 E242  E8 1560					call    prts
 E245				nokbmsg:
 E245  F6 06 0010 04				test    byte ptr EquipmentWord, 4
 E24A  74 06					jz      nomousemsg
 E24C  BE E260 R				mov     si, offset msgmouse
 E24F  E8 1553					call    prts
 E252				nomousemsg:

				;-------------- HD bootstrap
 E252  B8 00E3					mov		ax, 00e3h
 E255  CD 14					int		14h		; init COM to 9.6K, 8n1
 E257  B8 0305					mov     ax, 305h
 E25A  33 DB					xor     bx, bx
 E25C  CD 16					int     16h     ; set typematic rate and delay to fastest
 E25E  CD 19					int     19h

 E260 50 53 32 20 4D 6F		msgmouse    db 'PS2 Mouse detected', 13, 10, 0        
       75 73 65 20 64 65
       74 65 63 74 65 64
       0D 0A 00
 E275 0D 0A 43 50 55 3A		bioscont    db 13, 10, 'CPU: 80186 50Mhz (50MIPS, 100Mhz 32bit bus)', 13, 10
       20 38 30 31 38 36
       20 35 30 4D 68 7A
       20 28 35 30 4D 49
       50 53 2C 20 31 30
       30 4D 68 7A 20 33
       32 62 69 74 20 62
       75 73 29 0D 0A
 E2A4  52 41 4D 3A 20 33	            db 'RAM: 32MB SDR 100Mhz 16bit', 13, 10
       32 4D 42 20 53 44
       52 20 31 30 30 4D
       68 7A 20 31 36 62
       69 74 0D 0A
 E2C0  43 61 63 68 65 3A	            db 'Cache: 8KB, 4-way, 128x64 bytes data/inst', 13, 10
       20 38 4B 42 2C 20
       34 2D 77 61 79 2C
       20 31 32 38 78 36
       34 20 62 79 74 65
       73 20 64 61 74 61
       2F 69 6E 73 74 0D
       0A
 E2EB  48 44 30 3A 20 00				db 'HD0: ', 0

				; ---------------------------- INT 07 ---------------------
 E2F1				int07 proc near ; coprocessor ESC sequence
 E2F1  50					push    ax
 E2F2  53					push    bx
 E2F3  1E					push    ds
 E2F4  55					push    bp
 E2F5  8B EC					mov     bp, sp
 E2F7  C5 5E 08					lds     bx, [bp+8]  
 E2FA				int07_pfx:        
 E2FA  8A 07					mov     al, [bx]
 E2FC  43					inc     bx
 E2FD  24 F8					and     al, 0f8h
 E2FF  3C D8					cmp     al, 0d8h        ; ESC code
 E301  75 F7					jne     short int07_pfx
							  
 E303  80 3F C0					cmp     byte ptr [bx], 0c0h ; mod reg r/m of ESC 8087 instruction
 E306  1A C0					sbb     al, al
 E308  22 07					and     al, [bx]
 E30A  25 00C7					and     ax, 0c7h
 E30D  3C 06					cmp     al, 6
 E30F  75 02					jne     int072
 E311  B0 80					mov     al, 80h
 E313				int072:
 E313  C0 E8 06					shr     al, 6
 E316  40					inc     ax
 E317  03 C3					add     ax, bx
 E319  89 46 08					mov     [bp+8], ax
 E31C  5D					pop     bp
 E31D  1F					pop     ds
 E31E  5B					pop     bx
 E31F  58					pop     ax
 E320  CF					iret
 E321				int07 endp


				; ---------------------------- INT 08 ---------------------
 E321				int08 proc near
 E321  1E					push    ds
 E322  53					push    bx
 E323  6A 40					push    40h
 E325  1F					pop     ds

 E326  BB 0040					mov     bx, 40h
 E329  83 3F 00					cmp     word ptr [bx], 0
 E32C  74 02					jz      int08_nodec
 E32E  FF 0F					dec     word ptr [bx]
 E330				int08_nodec:
 E330  50					push    ax
 E331  B0 20					mov     al, 20h
 E333  E6 20					out     20h, al
 E335  58					pop     ax
 E336  BB 006C					mov     bx, 6ch
 E339  83 07 01					add     word ptr [bx], 1
 E33C  83 57 02 00				adc     word ptr [bx+2], 0
 E340  83 7F 02 18				cmp     word ptr [bx+2], 18h
 E344  75 13					jne     short int081
 E346  81 3F 00B0				cmp     word ptr [bx], 0b0h
 E34A  75 0D					jne     short int081
 E34C  C7 07 0000				mov     word ptr [bx], 0
 E350  C7 47 02 0000				mov     word ptr [bx+2], 0
 E355  C6 47 04 01				mov     byte ptr [bx+4], 1
 E359				int081:
 E359  CD 1C					int     1ch
 E35B  FB					sti
 E35C  50					push    ax
 E35D  B4 04					mov     ah, 4
 E35F				kloop:        
 E35F  E4 64					in      al, 64h
 E361  A8 01					test    al, 1
 E363  74 0E					jz      short nokey
 E365  FE CC					dec     ah
 E367  75 F6					jnz     short kloop
 E369  A8 20					test    al, 20h
 E36B  74 04					jz      short kbdata
 E36D  CD 74					int     74h
 E36F  EB 02					jmp     short nokey
 E371				kbdata:
 E371  CD 09					int     9h        
 E373				nokey:
 E373  58					pop     ax
 E374  5B					pop     bx
 E375  1F					pop     ds
 E376  CF					iret
 E377				int08 endp

				; --------------------- INT 09 - keyboard ------------------
 = ds:[17h]			KbdFlags1       equ     <ds:[17h]>
 = ds:[18h]			KbdFlags2       equ     <ds:[18h]>
 = ds:[19h]			AltKpd          equ     <ds:[19h]>
 = ds:[71h]			CtrlBreak       equ     <ds:[71h]>
 = ds:[96h]			KbdFlags3       equ     <ds:[96h]>
 = ds:[97h]			KbdFlags4       equ     <ds:[97h]>

				; Bits for the KbdFlags1
 = 0001				RShfDown        equ     1
 = 0002				LShfDown        equ     2
 = 0004				CtrlDown        equ     4
 = 0008				AltDown         equ     8
 = 0010				ScrLock         equ     10h
 = 0020				NumLock         equ     20h
 = 0040				CapsLock        equ     40h
 = 0080				Insert          equ     80h

				; Bits for the KbdFlags2
 = 0001				LCtrDown        equ     1
 = 0002				LAltDown        equ     2
 = 0004				SysReqDown      equ     4
 = 0008				Pause           equ     8
 = 0010				ScrLockDown     equ     10h
 = 0020				NumLockDown     equ     20h
 = 0040				CapsLockDown    equ     40h
 = 0080				InsDown         equ     80h
				 
				; Bits for the KbdFlags3
 = 0001				LastE1          equ     1
 = 0002				LastE0          equ     2
 = 0004				RCtrDown        equ     4
 = 0008				RAltDown        equ     8
 = 0020				LastF0          equ     20h

				; Bits for the KbdFlags4
 = 0001				ScrLockLED      equ     1
 = 0002				NumLockLED      equ     2
 = 0004				CapsLockLED     equ     4
 = 0008				SetRepeat       equ     8       ; Set auto repeat command in progress
 = 0010				AckReceived     equ     10h
 = 0040				LEDUpdate       equ     40h

				IFDEF SCANCODE1

 E377				int09 proc near
 E377  60					pusha
 E378  1E					push    ds
 E379  06					push    es
 E37A  6A 40					push    40h
 E37C  1F					pop     ds
 E37D  E4 60					in      al, 60h         ; al contains the scan code
 E37F  8B 16 0017				mov     dx, KbdFlags1
 E383  8B 0E 0096				mov     cx, KbdFlags3
 E387  3C FA					cmp     al, 0fah        ; ACK
 E389  75 1F					jne     short noACK
				; ------------ manage ACK response
 E38B  F6 C5 40					test    ch, LEDUpdate
 E38E  74 14					jz      short ToggleACK ; no LED update
 E390  F6 C5 10					test    ch, AckReceived
 E393  75 0C					jnz     short SecondACK ; second ACK received
 E395  8A E5					mov     ah, ch          ; LED update command sent, ACK received, need to send second byte
 E397  80 E4 07					and     ah, ScrLockLED or NumLockLED or CapsLockLED
 E39A  B3 00					mov     bl, 0
 E39C  E8 1390					call    sendps2byte
 E39F  EB 03					jmp     short ToggleACK
 E3A1				SecondACK:        
 E3A1  80 F5 40					xor     ch, LEDUpdate   ; second ACK, clear LED update bit
 E3A4				ToggleACK:
 E3A4  80 F5 10					xor     ch, AckReceived ; toggle ACK bit 
 E3A7				SetFlags1:                                  
 E3A7  E9 01AF					jmp     SetFlags               
						
				; ------------ no ACK
 E3AA				noACK:
 E3AA  B4 4F					mov     ah,4fh
 E3AC  F9					stc
 E3AD  CD 15					int     15h
 E3AF  72 03 E9 01C8				jnc     int09Exit
 E3B4  3C E0					cmp     al, 0e0h
 E3B6  75 05					jne     short noE0
 E3B8  80 C9 02					or      cl, LastE0
 E3BB  EB EA					jmp     short SetFlags1
 E3BD				noE0:
 E3BD  3C E1					cmp     al, 0e1h
 E3BF  75 05					jne     short noE1
 E3C1  80 C9 01					or      cl, LastE1
 E3C4  EB E1					jmp     short SetFlags1
 E3C6				noE1:   
 E3C6  3C 53					cmp     al, 53h     ; is DEL?
 E3C8  75 18					jne     short noDEL
 E3CA  8A E2					mov     ah, dl
 E3CC  80 E4 0C					and     ah, CtrlDown or AltDown
 E3CF  80 FC 0C					cmp     ah, CtrlDown or AltDown
 E3D2  74 03 E9 010F				jne     NormalKey   ; is DEL, but no CTRL+ALt+DEL
 E3D7  C7 06 0072 1234				mov     word ptr ds:[72h], 1234h    ; warm boot flag
 E3DD  EA					db      0eah
 E3DE  0000 FFFF				dw      0, 0ffffh       ; reboot
 E3E2				noDEL:
 E3E2  F6 C1 02					test    cl, LastE0
 E3E5  75 24					jnz     short noRSUp    ; ignore fake shifts
 E3E7  3C 2A					cmp     al, 2ah         ; left shift
 E3E9  75 05					jne     short noLSDown
 E3EB  80 CA 02					or      dl, LShfDown
 E3EE  EB 63					jmp     short SetFlagsKey2
 E3F0				noLSDown:
 E3F0  3C AA					cmp     al, 2ah or 80h
 E3F2  75 05					jne     short noLSUp
 E3F4  80 E2 FD					and     dl, not LShfDown
 E3F7  EB 5A					jmp     short SetFlagsKey2
 E3F9				noLSUp:
 E3F9  3C 36					cmp     al, 36h         ; right shift
 E3FB  75 05					jne     short noRSDown
 E3FD  80 CA 01					or      dl, RShfDown
 E400  EB 51					jmp     short SetFlagsKey2
 E402				noRSDown:
 E402  3C B6					cmp     al, 36h or 80h
 E404  75 05					jne     short noRSUP
 E406  80 E2 FE					and     dl, not RShfDown
 E409  EB 48					jmp     short SetFlagsKey2
 E40B				noRSUp:
 E40B  3C 38					cmp     al, 38h         ; ALT
 E40D  75 13					jne     short noALTDown
 E40F  F6 C1 02					test    cl, LastE0
 E412  74 08					jz      short LALTDn
 E414  80 C9 08					or      cl, RAltDown
 E417  80 CA 08					or      dl, AltDown
 E41A  EB 37					jmp     short SetFlagsKey2
 E41C				LALTDn:
 E41C  81 CA 0208				or      dx, (LAltDown shl 8) or AltDown
 E420  EB 31					jmp     short SetFlagsKey2
 E422				noALTDown:
 E422  3C B8					cmp     al, 38h or 80h
 E424  75 1E					jne     short noALTUp
 E426  F6 C1 02					test    cl, LastE0
 E429  74 08					jz      short LALTUp
 E42B  80 E1 F7					and     cl, not RAltDown
 E42E  80 E2 F7					and     dl, not AltDown
 E431  EB 04					jmp     short ALTup
 E433				LALTUp:
 E433  81 E2 FDF7				and     dx, not ((LAltDown shl 8) or AltDown)
 E437				ALTUp:
 E437  33 C0					xor     ax, ax
 E439  86 06 0019				xchg    al, AltKpd
 E43D  84 C0					test    al, al
 E43F  74 12					jz      short SetFlagsKey2     
 E441  E9 0107					jmp     pushKey
 E444				noALTUp:
 E444  3C 1D					cmp     al, 1dh         ; CTL
 E446  75 13					jne     short noCTLDown
 E448  F6 C1 02					test    cl, lastE0
 E44B  74 08					jz      short LCTLDn
 E44D  80 C9 04					or      cl, RCtrDown
 E450  80 CA 04					or      dl, CtrlDown
 E453				SetFlagsKey2:        
 E453  EB 79					jmp     short SetFlagsKey1
 E455				LCTLDn:
 E455  81 CA 0104				or      dx, (LCtrDown shl 8) or CtrlDown
 E459  EB 73					jmp     short SetFlagsKey1
 E45B				noCTLDown:
 E45B  3C 9D					cmp     al, 1dh or 80h
 E45D  75 13					jne     short noCTLUp
 E45F  F6 C1 02					test    cl, LastE0
 E462  74 08					jz      short LCTLUp
 E464  80 E1 FB					and     cl, not RCtrDown
 E467  80 E2 FB					and     dl, not CtrlDown
 E46A  EB 62					jmp     short SetFlagsKey1
 E46C				LCTLUp:
 E46C  81 E2 FEFB				and     dx,  not ((LCtrDown shl 8) or CtrlDown)
 E470  EB 5C					jmp     short SetFlagsKey1
 E472				noCTLUp:
 E472  BB 3A40					mov     bx, 3a00h + CapsLock
 E475  E8 010C					call    KeyLock
 E478  73 54					jnc     short SetFlagsKey1
						
 E47A  BB 4610					mov     bx, 4600h + ScrLock
 E47D  52					push    dx          ; save ScrLock state bit (dl)
 E47E  E8 0103					call    KeyLock
 E481  5B					pop     bx          ; restore ScrLock state bit (bl)
 E482  72 21					jc      short noScrLock
 E484  F6 C2 04					test    dl, CtrlDown
 E487  74 45					jz      short SetFlagsKey1; no break, just ScollLock
 E489  8A D3					mov     dl, bl      ; restore ScrLock flag
 E48B  F6 C7 10					test    bh, ScrLockDown
 E48E  75 3E					jnz     short SetFlagsKey1 
 E490  C6 06 0071 80				mov     byte ptr CtrlBreak, 80h   ; CTRL+BREAK flag
 E495  A1 0080					mov     ax, Buffer
 E498  A3 001A					mov     HeadPtr, ax
 E49B  A3 001C					mov     TailPtr, ax
 E49E  CD 1B					int     1bh
 E4A0  33 C0					xor     ax, ax
 E4A2  E9 00A6					jmp     pushkey
 E4A5				noScrLock:        
 E4A5  F6 C1 02					test    cl, LastE0  ; INS
 E4A8  75 0A					jnz     short testINS
 E4AA  F6 C2 03					test    dl, RShfDown or LShfDown
 E4AD  75 05					jnz     short testINS
 E4AF  F6 C2 20					test    dl, NumLock
 E4B2  75 06					jnz     short NoIns      
 E4B4				testINS:
 E4B4  BB 5280					mov     bx, 5200h + Insert
 E4B7  E8 00CA					call    KeyLock  
 E4BA				noIns:
 E4BA  BB 4520					mov     bx, 4500h + NumLock
 E4BD  52					push    dx          ; save NumLock state bit (dl)
 E4BE  E8 00C3					call    KeyLock
 E4C1  5B					pop     bx          ; restore NumLock state bit (bl)
 E4C2  72 22					jc      short NormalKey   ; CTRL+NumLock = Pause
 E4C4  F6 C2 04					test    dl, CtrlDown
 E4C7  74 05					jz      short SetFlagsKey1
 E4C9  8A D3					mov     dl, bl      ; restore NumLock flag
 E4CB  80 CE 08					or      dh, Pause   ; set Pause bit
 E4CE				SetFlagsKey1:
 E4CE  E9 0085					jmp     SetFlagsKey
 E4D1				E0Key:
 E4D1  BF FCE5 R				mov     di, offset E0KeyList
 E4D4  51					push    cx
 E4D5  B9 000C					mov     cx, E0KeyIndex - E0KeyList
 E4D8  FC					cld
 E4D9  0E					push    cs
 E4DA  07					pop     es
 E4DB  F2/ AE					repne   scasb
 E4DD  59					pop     cx
 E4DE  75 76					jne     short SetFlagsKey
 E4E0  26: 8A 45 0B				mov     al, es:[di + E0KeyIndex - E0KeyList - 1]
 E4E4  EB 14					jmp     short KeyDown
 E4E6				NormalKey:
 E4E6  A8 80					test    al, 80h
 E4E8  75 6C					jnz     short SetFlagsKey ; key up
 E4EA  F6 C1 02					test    cl, LastE0
 E4ED  75 E2					jnz     short E0Key
 E4EF  3C 59					cmp     al, 59h
 E4F1  1A E4					sbb     ah, ah
 E4F3  22 C4					and     al, ah
 E4F5  BB FC8C R				mov     bx, offset KeyIndex
 E4F8  2E: D7					xlat    cs:[bx]
 E4FA				KeyDown:
 E4FA  33 DB					xor     bx, bx 
 E4FC  F6 C2 03					test    dl, RShfDown or LShfDown
 E4FF  74 02					jz      short noShift
 E501  B3 02					mov     bl, 2
 E503				noShift:
 E503  3C 1A					cmp     al, 26
 E505  77 0A					ja      short noCaps
 E507  F6 C2 40					test    dl, CapsLock
 E50A  74 13					jz      short noNum
 E50C  80 F3 02					xor     bl, 2
 E50F  EB 0E					jmp     short noNum 
 E511				noCaps:
 E511  3C 25					cmp     al, 37
 E513  77 0A					ja      short noNum
 E515  F6 C2 20					test    dl, NumLock
 E518  75 02					jnz     short NumDown
 E51A  B3 02					mov     bl, 2
 E51C				NumDown:
 E51C  80 F3 02					xor     bl, 2
 E51F				noNum:        
 E51F  F6 C2 04					test    dl, CtrlDown
 E522  74 02					jz      short noCtrl
 E524  B3 04					mov     bl, 4
 E526				noCtrl:
 E526  F6 C2 08					test    dl, AltDown
 E529  74 02					jz      short noAlt
 E52B  B3 06					mov     bl, 6
 E52D				noAlt:
 E52D  98					cbw
 E52E  C1 E0 03					shl     ax, 3
 E531  03 D8					add     bx, ax
 E533  2E: 8B 87 FCFD R				mov     ax, cs:KeyCode[bx]
 E538  83 F8 0A					cmp     ax, 000ah
 E53B  77 0E					ja      short pushKey
 E53D  48					dec     ax
 E53E  78 16					js      short SetFlagsKey     ; ax was 0
 E540  8A 26 0019				mov     ah, AltKpd
 E544  D5 0A					aad
 E546  A2 0019					mov     AltKpd, al
 E549  EB 0B					jmp     short SetFlagsKey
 E54B				pushKey:                
 E54B  51					push    cx
 E54C  8B C8					mov     cx, ax
 E54E  B4 05					mov     ah, 5
 E550  CD 16					int     16h
 E552  59					pop     cx
 E553  80 E6 F7					and     dh, not Pause    ; clear Pause bit
 E556				SetFlagsKey:
 E556  80 E1 FC					and     cl, not (LastE0 or LastE1)    ; not prefix key code, clear all prefixes
 E559				SetFlags:
 E559  8A C2					mov     al, dl
 E55B  C0 E8 04					shr     al, 4
 E55E  32 C5					xor     al, ch
 E560  24 07					and     al, 7
 E562  74 10					jz      short SF1   ; no LEDs to update
 E564  F6 C5 58					test    ch, SetRepeat or AckReceived or LEDUpdate
 E567  75 0B					jnz     short SF1   ; can not update LEDS, so just write the flags and exit
 E569  0C 40					or      al, LEDUpdate
 E56B  32 E8					xor     ch, al      ; insert the LEDs in KbdFlags4
 E56D  B4 ED					mov     ah, 0edh    ; set LED
 E56F  B3 00					mov     bl, 0
 E571  E8 11BB					call    sendps2byte
 E574				SF1:        
 E574  89 16 0017				mov     KbdFlags1, dx
 E578  89 0E 0096				mov     KbdFlags3, cx
						
 E57C				int09Exit:
 E57C  B0 20					mov     al, 20h
 E57E  E6 20					out     20h, al
 E580  07					pop     es
 E581  1F					pop     ds
 E582  61					popa
 E583  CF					iret
 E584				int09 endp

				ELSE    ; SCANCODE2
				ENDIF

 E584				KeyLock proc near   ; input: BH = expected scan code, al = scan code, BL = key lock flag. Returns CF=1 to continue, CF=0 to exit
 E584  32 F8					xor     bh, al
 E586  75 09					jnz     short s2
 E588  8A E6					mov     ah, dh
 E58A  0A F3					or      dh, bl      ; set flag
 E58C  32 E6					xor     ah, dh      ; get flag difference
 E58E  32 D4					xor     dl, ah      ; toggle only if key was not already down
 E590  C3					ret
 E591  80 FF 80			s2:     cmp     bh, 80h
 E594  F9					stc
 E595  75 02					jne     short exit
 E597  32 F3					xor     dh, bl      ; key up
 E599				exit:
 E599  C3					ret
 E59A				KeyLock endp


				; --------------------- INT 10h - Video ----------------
 = ds:[49h]			ActiveVideoMode     equ <ds:[49h]>  ; 1  byte
 = ds:[4ah]			ScreenWidth         equ <ds:[4ah]>  ; 2  Screen width in text columns
 = ds:[4ch]			RegenLength         equ <ds:[4ch]>  ; 2  Length (in bytes) of video area (regen size)
 = ds:[4eh]			PageOffset          equ <ds:[4eh]>  ; 2  Offset from video segment of active video memory page
 = ds:[50h]			CursorPos           equ <ds:[50h]>  ; 16 Cursor location (8 byte-pairs; low byte=col, hi byte=row)
 = ds:[60h]			CursorShape         equ <ds:[60h]>  ; 2  Cursor size/shape.  Low byte=end scan line; hi byte=start line.
 = ds:[62h]			ActivePage          equ <ds:[62h]>  ; 1  Current active video page number
 = ds:[63h]			PortAddress         equ <ds:[63h]>  ; 2  Port address for 6845 video controller chip; see CGA I/O Ports
 = ds:[65h]			CrtMode             equ <ds:[65h]>  ; 1  Current value of 6845 video ctrlr CRT_MODE (port 3x8H register)
 = ds:[66h]			CrtPalette          equ <ds:[66h]>  ; 1  Current value of 6845 video ctrlr CRT_PALETTE (port 3x9H reg)
 = ds:[84h]			ScreenRows          equ <ds:[84h]>  ; 1  EGA text rows-1  (maximum valid row value)
 = ds:[85h]			ScanLinesChar       equ <ds:[85h]>  ; 2  EGA bytes per character (scan-lines/char used in active mode)
 = ds:[87h]			EgaMiscInfo         equ <ds:[87h]>  ; 1  EGA flags; see EgaMiscInfoRec
 = ds:[88h]			EgaMiscInfo2        equ <ds:[88h]>  ; 1  EGA flags; see EgaMiscInfo2Rec
 = ds:[89h]			VgaFlags            equ <ds:[89h]>  ; 1  VGA flags; see VgaFlagsRec
 = ds:[8ah]			VgaFlags2           equ <ds:[8ah]>  ; 1  VGA flags2
 = ds:[69h]			PalOffset			equ <ds:[69h]>  ; 2  current palette offset (temporary during the video mode set)


 E59A				int10 proc near     
 E59A  FB					sti                     ; no interrupt reentrant
 E59B  FC					cld
 E59C  1E					push    ds
 E59D  56					push    si
 E59E  6A 40					push    40h
 E5A0  1F					pop     ds
 E5A1  80 FC 4F					cmp     ah, 4fh
 E5A4  74 16					je      short svga
 E5A6  80 FC 1C					cmp     ah, 1ch
 E5A9  77 0E					ja      short exit
 E5AB  8B F0					mov     si, ax
 E5AD  C1 EE 07					shr     si, 7
 E5B0  81 E6 01FE				and     si, 1feh
 E5B4  2E: FF 94 EF91 R				call    cs:vidtbl[si]
 E5B9				exit:        
 E5B9  5E					pop     si
 E5BA  1F					pop     ds
 E5BB  CF					iret
 E5BC				svga:
 E5BC  3C 05					cmp     al, 5
 E5BE  74 77					je      short VESAMemControl
 E5C0  3C 01					cmp     al, 1
 E5C2  72 0D					jb      short VESAGetInfo
 E5C4  74 24					je      short VESAGetModeInfo
 E5C6  3C 03					cmp     al, 3
 E5C8  72 37					jb      short VESASetMode
 E5CA  74 4F					je      short VESAGetMode
 E5CC  B8 0100					mov     ax, 100h
 E5CF  EB E8					jmp     short exit

				; ---------------- VESA fn00
 E5D1				VESAGetInfo:
 E5D1  51					push    cx
 E5D2  57					push    di
 E5D3  BE E660 R				mov     si, offset VESAInfo
 E5D6  B9 000A					mov     cx, 10
 E5D9  F3/ 2E: A5				rep     movsw es:[di], cs:[si]
 E5DC  B1 76					mov     cl, 118     ; 236 bytes 0
 E5DE				VESASupportedClear:        
 E5DE  33 C0					xor     ax, ax
 E5E0  F3/ AB					rep     stosw
 E5E2  5F					pop     di
 E5E3  59					pop     cx     
 E5E4				VESASupported:
 E5E4  B4 00					mov     ah, 0       ; success    
 E5E6				VESASupportedErr:
 E5E6  B0 4F					mov     al, 4fh
 E5E8  EB CF					jmp     short exit

				; ---------------- VESA fn01
 E5EA				VESAGetModeInfo:
 E5EA  81 F9 0101				cmp     cx, 101h
 E5EE				VESAGetModeInfo1:        
 E5EE  B4 01					mov     ah, 1       ; error
 E5F0  75 F4					jne     short VESASupportedErr
 E5F2  51					push    cx
 E5F3  57					push    di
 E5F4  B9 0009					mov     cx, 9
 E5F7  BE E68B R				mov     si, offset VESAModeInfo
 E5FA  F3/ 2E: A5				rep     movsw es:[di], cs:[si]
 E5FD  B1 77					mov     cl, 119       
 E5FF  EB DD					jmp     short VESASupportedClear

				; ---------------- VESA fn02
 E601				VESASetMode:
 E601  6B C3 02					imul    ax, bx, 2
 E604  3D 0202					cmp     ax, 101h*2
 E607  75 0A					jne     short VESASetMode1      
 E609  8D 87 23FF				lea     ax, [bx+23ffh]
 E60D  86 E0					xchg    ah, al
 E60F  CD 10					int     10h
 E611  EB D1					jmp     short VESASupported   
 E613				VESASetMode1:
 E613  8A C3					mov     al, bl
 E615  B4 00					mov     ah, 0
 E617  CD 10					int     10h
 E619  EB C9					jmp     short VESASupported

				; ---------------- VESA fn03
 E61B				VESAGetMode:
 E61B  8A 3E 0087				mov     bh, EgaMiscInfo
 E61F  80 E7 80					and     bh, 80h
 E622  8A 1E 0049				mov     bl, ActiveVideoMode
 E626  80 FB 25					cmp     bl, 25h
 E629  74 06					je      short VESAGetMode1
 E62B  0A DF					or      bl, bh
 E62D  B7 00					mov     bh, 0
 E62F  EB B3					jmp     short VESASupported
 E631				VESAGetMode1:
 E631  81 C3 00DC				add     bx, 257-25h        
 E635  EB AD					jmp     short VESASupported

				; ---------------- VESA fn05
 E637				VESAMemControl:
				;        test    bx, not 101h                ; BX validation
				;        jnz     short VESAGetModeInfo1      ; error
 E637  0E					push    cs
 E638  68 E5E4 R				push    offset VESASupported
				;        call    VESAMemControlCB
				;        jmp     short VESASupported
 E63B				VESAMemControlCB:
 E63B  9C					pushf
 E63C  FA					cli
 E63D  50					push    ax
 E63E  52					push    dx
 E63F  8B C3					mov     ax, bx
 E641  83 E0 01					and     ax, 1
 E644  04 8A					add     al, 8ah
 E646  92					xchg    ax, dx
 E647  83 E0 07					and     ax, 7
 E64A  04 0A					add     al, 0ah
 E64C  84 FF					test    bh, bh
 E64E  75 05					jnz     getpageinfo
 E650  EF					out     dx, ax          
 E651  5A					pop     dx
 E652  58					pop     ax
 E653  9D					popf
 E654  CB					retf
 E655				getpageinfo:
 E655  ED					in      ax, dx
 E656  2C 0A					sub     al, 0ah
 E658  83 E0 07					and     ax, 7
 E65B  92					xchg    ax, dx
 E65C  58					pop     ax
 E65D  58					pop     ax                
 E65E  9D					popf
 E65F  CB					retf
				   
 E660 56 45 53 41		VESAInfo    db  'VESA'
 E664  0100 E674 R F000					dw  100h, VESAOEM, 0f000h, 2, 0, VESAModes, 0f000h, 8
       0002 0000 E687 R
       F000 0008
 E674 4E 69 63 6F 6C 61		VESAOEM     db  'Nicolae Dumitrache', 0
       65 20 44 75 6D 69
       74 72 61 63 68 65
       00
 E687 0101 FFFF			VESAModes   dw  101h, 0ffffh
 E68B				VESAModeInfo:
				;Bit(s)  Description - mode attributes 
				;0      mode supported by present hardware configuration
				;1      optional information available (must be =1 for VBE v1.2+)
				;2      BIOS output supported
				;3      set if color, clear if monochrome
				;4      set if graphics mode, clear if text mode
				;---VBE v2.0+ ---
				;5      mode is not VGA-compatible
				;6      bank-switched mode not supported
				;7      linear framebuffer mode supported
				;8      double-scan mode available (e.g. 320x200 and 320x240)
				;---VBE v3.0 ---
				;9      interlaced mode available
				;10     hardware supports triple buffering
				;11     hardware supports stereoscopic display
				;12     dual display start address support
				;13-15  reserved
 E68B  0099					dw  0000000010011001b       
				;Bit(s)  Description - window attributes
				;0      exists
				;1      readable
				;2      writable
				;3-7    reserved
 E68D  07 07					db  00000111b, 00000111b
 E68F  0040 0040 A000				dw  64, 64, 0a000h, 0b000h, VESAMemControlCB, 0f000h, 640
       B000 E63B R F000
       0280

 E69D 00			p3c0r10	db		0	; port 3c0h reg 10h mirror
				
 E69E				ModeTab:
				;           0     1     2     3     4     5     6     7     8     9     a     b     c     d     e     f     10    11    12    13    25
 E69E 5F 5F 5F 5F 2D 2D		crtc0   db 05fh, 05fh, 05fh, 05fh, 02dh, 02dh, 05fh, 05fh, 02dh, 02dh, 05fh, 05fh, 05fh, 02dh, 05fh, 05fh, 05fh, 05fh, 05fh, 05fh, 05fh ; horizontal total
       5F 5F 2D 2D 5F 5F
       5F 2D 5F 5F 5F 5F
       5F 5F 5F
 E6B3 4F 4F 4F 4F 27 27		crtc1   db  79,   79,   79,   79,   39,   39,   79,   79,   39,   39,   79,   79,   79,   39,   79,   79,   79,   79,   79,   79,   79  ; hde
       4F 4F 27 27 4F 4F
       4F 27 4F 4F 4F 4F
       4F 4F 4F
				;crtc2   db; hblank start
				;crtc3   db; hblank end
 E6C8 54 54 54 54 2B 2B		crtc4   db 054h, 054h, 054h, 054h, 02bh, 02bh, 054h, 054h, 02bh, 02bh, 054h, 054h, 054h, 02bh, 054h, 054h, 054h, 054h, 054h, 054h, 054h ; hsync start
       54 54 2B 2B 54 54
       54 2B 54 54 54 54
       54 54 54
				;crtc5   db ; hsync end
 E6DD BF BF BF BF DF DF		crtc6   db 0bfh, 0bfh, 0bfh, 0bfh, 0dfh, 0dfh, 0dfh, 0bfh, 0dfh, 0dfh, 0dfh, 0bfh, 0bfh, 0bfh, 0bfh, 0bfh, 0bfh, 008h, 008h, 0bfh, 008h ; vtotal
       DF BF DF DF DF BF
       BF BF BF BF BF 08
       08 BF 08
 E6F2 1F 1F 1F 1F 10 10		crtc7   db 01fh, 01fh, 01fh, 01fh, 010h, 010h, 010h, 01fh, 010h, 010h, 010h, 01fh, 01fh, 01fh, 01fh, 01fh, 01fh, 036h, 036h, 01fh, 036h ; overflow (vsync[9], vde[9], vtotal[9], lcr[8], vblank[8], vsync[8], vde[8], vtotal[8])
       10 1F 10 10 10 1F
       1F 1F 1F 1F 1F 36
       36 1F 36
 E707 4F 4F 4F 4F C0 C0		crtc9   db 04fh, 04fh, 04fh, 04fh, 0c0h, 0c0h, 0c0h, 04fh, 0c0h, 0c0h, 0c0h, 041h, 041h, 041h, 041h, 040h, 040h, 040h, 040h, 041h, 040h ; lcr[9], repln
       C0 4F C0 C0 C0 41
       41 41 41 40 40 40
       40 41 40
 E71C 9C 9C 9C 9C CE CE		crtc10  db 09ch, 09ch, 09ch, 09ch, 0ceh, 0ceh, 0ceh, 09ch, 0ceh, 0ceh, 0ceh, 09ch, 09ch, 09ch, 09ch, 09ch, 09ch, 0e1h, 0e1h, 09ch, 0e1h ; vsync start
       CE 9C CE CE CE 9C
       9C 9C 9C 9C 9C E1
       E1 9C E1
 E731 8F 8F 8F 8F C7 C7		crtc12  db 08fh, 08fh, 08fh, 08fh, 0c7h, 0c7h, 0c7h, 08fh, 0c7h, 0c7h, 0c7h, 08fh, 08fh, 08fh, 08fh, 05dh, 05dh, 0dfh, 0dfh, 08fh, 0dfh ; vde
       C7 8F C7 C7 C7 8F
       8F 8F 8F 5D 5D DF
       DF 8F DF
 E746 14 14 14 14 14 14		crtc13  db 014h, 014h, 014h, 014h, 014h, 014h, 014h, 028h, 028h, 028h, 028h, 028h, 028h, 014h, 028h, 028h, 028h, 028h, 028h, 028h, 050h ; offset
       14 28 28 28 28 28
       28 14 28 28 28 28
       28 28 50
 E75B 08 08 08 08 01 01		dac10   db 008h, 008h, 008h, 008h, 001h, 001h, 001h, 001h, 001h, 001h, 001h, 001h, 001h, 001h, 001h, 00bh, 001h, 00bh, 001h, 041h, 001h ; mode ctrl
       01 01 01 01 01 01
       01 01 01 0B 01 0B
       01 41 01
 E770 01 01 01 01 0B 0B		sc1     db 001h, 001h, 001h, 001h, 00bh, 00bh, 001h, 000h, 00bh, 00bh, 001h, 000h, 000h, 00bh, 001h, 001h, 001h, 001h, 001h, 001h, 001h ; clocking mode (half)
       01 00 0B 0B 01 00
       00 0B 01 01 01 01
       01 01 01
				
				; --------------- fn 00h, set video mode
 E785				setmode:
 E785  60					pusha
 E786  06					push    es
 E787  02 C0					add     al, al      ; CF = cls bit
 E789  D0 16 0087				rcl     byte ptr EgaMiscInfo, 1
 E78D  D0 0E 0087				ror     byte ptr EgaMiscInfo, 1

 E791  50					push	ax
 E792  BA 03D4					mov     dx,3d4h    ; CRTC
 E795  B8 0011					mov     ax,0011h   ; unset register protect
 E798  EF					out     dx,ax
 E799  B8 8317					mov     ax,8317h   ; mode control
 E79C  EF					out     dx,ax
 E79D  BA 03C4					mov		dx, 3c4h ; SC
 E7A0  B8 0F02					mov		ax, 0f02h
 E7A3  EF					out		dx, ax		; enable all write planes
 E7A4  B8 0C04					mov		ax, 0c04h
 E7A7  EF					out		dx, ax		; clear planar and odd/even mode
 E7A8  B2 CE					mov		dl, 0ceh	; GC
 E7AA  B8 0001					mov		ax, 0001h
 E7AD  EF					out		dx, ax		; disable set/reset
 E7AE  B0 03					mov		al, 03h
 E7B0  EF					out		dx, ax		; reset logical op and rotate count
 E7B1  B0 05					mov		al, 05h
 E7B3  EF					out		dx, ax		; set write mode to 00 (CPU access)
 E7B4  B8 FF07					mov		ax, 0ff07h
 E7B7  EF					out     dx, ax      ; set color don't care to 0Fh
 E7B8  40					inc     ax
 E7B9  EF					out		dx, ax		; set bitmask to CPU access
 E7BA  58					pop		ax

 E7BB  3C 06					cmp     al, 3*2
 E7BD  77 2B					ja      short setmode1
 E7BF  B0 B6					mov     al, 0b6h        ; reset sound generator
 E7C1  E6 43					out     43h, al
 E7C3  B0 00					mov     al, 0
 E7C5  E6 42					out     42h, al
 E7C7  E6 42					out     42h, al
 E7C9  B8 0806					mov     ax, 0806h   ; text mode (80x25, 16 colors), flash enabled
 E7CC  C7 06 004A 0050				mov     word ptr ScreenWidth, 80
 E7D2  C7 06 004C 1000				mov     word ptr RegenLength, 1000h
 E7D8  BB B800					mov     bx, 0b800h  ; segment
 E7DB  B9 4000					mov     cx, 4000h   ; video len/2
 E7DE  BE 0720					mov     si, 0720h   ; clear value
 E7E1  C7 06 0069 FBBC R			mov		word ptr PalOffset, offset PalVGA
 E7E7  E9 00DF					jmp     setmode2
 E7EA				setmode1:
						; CGA modes
 E7EA  3C 14					cmp     al,0ah*2
 E7EC  77 49					ja      setmode11
				
 E7EE  50					push    ax
 E7EF  BA 03D4					mov     dx, 3d4h    ; CRTC
 E7F2  3C 0C					cmp     al, 06h*2
 E7F4  77 04					ja      short setmode1_pcjr
 E7F6  B4 82					mov     ah, 82h
 E7F8  EB 02					jmp     short setmode1b
 E7FA				setmode1_pcjr:
 E7FA  B4 80					mov     ah, 80h
 E7FC				setmode1b:
 E7FC  B0 17					mov     al, 17h    ; mode control
 E7FE  EF					out     dx, ax
 E7FF  BA 03C4					mov     dx, 3c4h   ; SC
 E802  B8 0804					mov     ax, 0804h
 E805  EF					out     dx, ax     ; set odd/even mode
 E806  58					pop     ax
				
 E807  3C 0C					cmp     al,6*2
 E809  74 0E					je      setmode1a
 E80B  3C 14					cmp     al,0ah*2
 E80D  74 0A					je      setmode1a
 E80F  50					push    ax         ; save AL
 E810  B2 CE					mov     dl, 0ceh   ; GC
 E812  B8 3005					mov     ax, 3005h
 E815  EF					out     dx,ax      ; set shift-load
 E816  58					pop     ax         ; restore AL
 E817  B4 11					mov     ah, 11h    ; half -> 320x200x4(16)
 E819				setmode1a:
 E819  BB B800					mov     bx, 0b800h  ; segment
 E81C  B9 2000					mov     cx, 2000h   ; video len/2
 E81F  BE 0000					mov     si, 0000h   ; clear value
 E822  C7 06 004A 0050				mov     word ptr ScreenWidth, 80
 E828  C7 06 004C 1000				mov     word ptr RegenLength, 1000h
 E82E  C7 06 0069 FAEC R			mov     word ptr PalOffset, offset PalEGA
 E834  E9 0092					jmp     setmode2
 E837				setmode11:
 E837  3C 1A					cmp		al,	0dh*2
 E839  75 14					jne		short setmode12
 E83B  C7 06 004A 0028				mov     word ptr ScreenWidth, 40
 E841  C7 06 004C 2000				mov     word ptr RegenLength, 2000h
 E847  C7 06 0069 FAEC R			mov		word ptr PalOffset, offset PalEGA
 E84D  EB 32					jmp		short setmode121
 E84F				setmode12:
 E84F  3C 1C					cmp		al, 0eh*2	; 640x200x16
 E851  75 14					jne		short setmode122
 E853  C7 06 0069 FAEC R			mov		word ptr PalOffset, offset PalEGA
 E859				setmode1221:
 E859  C7 06 004A 0050				mov     word ptr ScreenWidth, 80
 E85F  C7 06 004C 4000				mov     word ptr RegenLength, 04000h
 E865  EB 1A					jmp		short setmode121
 E867				setmode122:
 E867  C7 06 0069 FBBC R			mov		word ptr PalOffset, offset PalVGA
 E86D  3C 20					cmp		al, 10h*2
 E86F  74 E8					je		short setmode1221	; 640x350x16
 E871  3C 24					cmp		al, 12h*2
 E873  75 1B					jne		short setmode13
 E875  C7 06 004A 0050				mov     word ptr ScreenWidth, 80
 E87B  C7 06 004C A000				mov     word ptr RegenLength, 0a000h
 E881				setmode121:
 E881  50					push	ax
 E882  BA 03C4					mov		dx, 3c4h	; SC
 E885  B8 FF02					mov		ax, 0ff02h
 E888  EF					out		dx, ax		; set write all planes
 E889  B8 0404					mov		ax, 0404h
 E88C  EF					out		dx, ax		; set planar mode
 E88D  58					pop		ax
 E88E  EB 31					jmp		short setmode21
 E890				setmode13:    
 E890  3C 26					cmp     al, 13h*2
 E892  75 14					jne     short setmode3
						; graphic mode, 320x200, 256 colors
 E894  C7 06 004A 0028				mov     word ptr ScreenWidth, 40
 E89A  C7 06 004C 0000				mov     word ptr RegenLength, 0000h
 E8A0  C7 06 0069 FA1C R			mov		word ptr PalOffset, offset Pal256
 E8A6  EB 19					jmp     short setmode21
 E8A8				setmode3:
 E8A8  3C 4A					cmp     al, 25h*2
 E8AA  74 03 E9 0114				jne		setmodeexit
 E8AF  C7 06 004A 0050				mov     word ptr ScreenWidth, 80
 E8B5  C7 06 004C 0000				mov     word ptr RegenLength, 0000h
 E8BB  C7 06 0069 FA1C R			mov		word ptr PalOffset, offset Pal256
 E8C1				setmode21:
 E8C1  BB A000					mov     bx, 0a000h  ; segment
 E8C4  B9 8000					mov     cx, 8000h   ; video len/2
 E8C7  33 F6					xor     si, si      ; clear value
 E8C9				setmode2:
 E8C9  D0 E8					shr     al, 1
 E8CB  A2 0049					mov     ActiveVideoMode, al
				
 E8CE  32 E4					xor     ah,ah
 E8D0  8B F8					mov     di,ax
 E8D2  83 FF 13					cmp     di,13h     ; video modes > 13h are mapped to 14h entry
 E8D5  76 03					jbe     setmode2a
 E8D7  BF 0014					mov     di,14h
 E8DA				setmode2a:
 E8DA  2E: 8A A5 E75B R				mov     ah, cs:dac10[di]
 E8DF  2E: 8A 85 E770 R				mov     al, cs:sc1[di]
 E8E4  50					push    ax
 E8E5  51					push    cx
 E8E6  BA 03D4					mov     dx, 3d4h   ; CRTC
 E8E9  2E: 8A A5 E69E R				mov     ah, cs:crtc0[di]
 E8EE  32 C0					xor     al, al
 E8F0  EF					out     dx, ax     ; htotal
 E8F1  2E: 8A A5 E6B3 R				mov     ah, cs:crtc1[di]
 E8F6  FE C0					inc     al
 E8F8  EF					out     dx, ax     ; hde
						;mov     ah, cs:crtc2[di]
 E8F9  FE C0					inc     al
						;out     dx, ax     ; hblank start
						;mov     ah, cs:crtc3[di]
 E8FB  FE C0					inc     al
						;out     dx, ax     ; hblank end
 E8FD  2E: 8A A5 E6C8 R				mov     ah, cs:crtc4[di]
 E902  FE C0					inc     al
 E904  EF					out     dx, ax     ; hsync start
						;mov     ah, cs:crtc5[di]
 E905  FE C0					inc     al
						;out     dx, ax     ; hsync end
 E907  2E: 8A A5 E6DD R				mov     ah, cs:crtc6[di]
 E90C  FE C0					inc     al
 E90E  EF					out     dx, ax     ; vtotal
 E90F  2E: 8A A5 E6F2 R				mov     ah, cs:crtc7[di]
 E914  FE C0					inc     al
 E916  EF					out     dx, ax     ; vtotal9, lcr8, vsync8, vde8, vtotal8
 E917  2E: 8A A5 E71C R				mov     ah, cs:crtc10[di]
 E91C  B0 10					mov     al, 10h
 E91E  EF					out     dx, ax     ; vsync start
 E91F  2E: 8A A5 E707 R				mov     ah, cs:crtc9[di]
 E924  B0 09					mov     al, 09h
 E926  EF					out     dx, ax     ; set repln, lcr9
 E927  2E: 8A A5 E731 R				mov     ah, cs:crtc12[di]
 E92C  B0 12					mov     al, 12h
 E92E  EF					out     dx, ax     ; vde
 E92F  2E: 8A A5 E746 R				mov     ah, cs:crtc13[di]
 E934  B0 13					mov     al, 13h
 E936  EF					out     dx, ax     ; offset
 E937  1E					push    ds
 E938  07					pop     es
 E939  B8 FF18					mov     ax, 0ff18h  ; lcr7..0
 E93C  EF					out     dx,ax
 E93D  33 C0					xor     ax, ax
 E93F  BF 0050					mov     di, offset CursorPos
 E942  B9 0008					mov     cx, 8
 E945  F3/ AB					rep     stosw           ; reset cursor position for all pages
 E947  B8 0500					mov     ax, 0500h
 E94A  CD 10					int     10h             ; set page0
 E94C  59					pop     cx
 E94D  F6 06 0087 80				test    byte ptr EgaMiscInfo, 80h
 E952  75 16					jnz     short setmode4    ; no clear video memory

 E954  8E C3					mov     es, bx
 E956				clearnext:
 E956  96					xchg    ax, si
 E957  33 FF					xor     di, di
 E959  51					push	cx
 E95A  F3/ AB					rep     stosw        
 E95C  59					pop		cx
 E95D  80 FF A0					cmp		bh, 0a0h
 E960  75 08					jnz		short clearok
 E962  96					xchg	ax, si
 E963  40					inc		ax
 E964  CD 10					int		10h
 E966  3C 08					cmp		al, 8
 E968  75 EC					jnz		short clearnext				
 E96A				clearok:

 E96A				setmode4:
 E96A  BA 03DA					mov     dx, 3dah
 E96D  EC					in      al, dx
 E96E  58					pop     ax
 E96F  50					push    ax
 E970  BA 03C0					mov     dx, 3c0h
 E973  B0 10					mov     al, 10h
 E975  EE					out     dx, al
 E976  8A C4					mov     al, ah      
 E978  EE					out     dx, al      ; set video mode
 E979  2E: A2 E69D R				mov     cs:p3c0r10, al
 E97D  B0 13					mov     al, 13h
 E97F  EE					out     dx, al
 E980  B0 00					mov     al, 0
 E982  EE					out     dx, al      ; 0 pan
 E983  58					pop     ax
 E984  8A E0					mov     ah, al    ; set half dot clock
 E986  BA 03C4					mov     dx, 3c4h    ; SC
 E989  B0 01					mov     al, 01h
 E98B  EF					out     dx, ax

 E98C  B8 1114					mov     ax, 1114h
 E98F  CD 10					int     10h         ; set 8x16 ROM font
 E991  B8 1123					mov     ax, 1123h
 E994  CD 10					int     10h         ; set ROM 8x8 font for graphics mode
 E996  B4 01					mov     ah, 1
 E998  B9 0607					mov		cx, 607h	; scanlines 13 and 14
 E99B  CD 10					int     10h         ; show cursor
 E99D  F6 06 0089 08				test    byte ptr VgaFlags, 8  ; test default palette loading
 E9A2  75 1F					jnz     short setmodeexit     ; no default palette
 E9A4  B8 1012					mov     ax, 1012h
 E9A7  33 DB					xor     bx, bx
 E9A9  B9 0040					mov     cx, 40h    
 E9AC  8B 16 0069				mov     dx, PalOffset
 E9B0  0E					push    cs
 E9B1  07					pop     es
 E9B2  CD 10					int     10h             ; set default palette
 E9B4  B0 02					mov		al, 02h
 E9B6  81 C2 00C0				add		dx, 40h*3
 E9BA  CD 10					int		10h				; set default palette EGA registers
 E9BC  B0 13					mov		al, 13h
 E9BE  BB 0001					mov		bx, 0001h		; select page0
 E9C1  CD 10					int		10h
 E9C3				setmodeexit:
 E9C3  BA 03D4					mov     dx,3d4h
 E9C6  B8 8011					mov     ax,8011h   ; set register protect
 E9C9  EF					out     dx,ax
 E9CA  BA 03D9					mov     dx,3d9h    ; CGA color select
 E9CD  B0 30					mov     al,030h    ; palette 1, hi-intensity, bg color=0
 E9CF  A2 0066					mov     CrtPalette, al
 E9D2  EE					out     dx,al
				
 E9D3  07					pop     es
 E9D4  61					popa
 E9D5				nullproc:
 E9D5  C3					ret        

				; --------------- fn 01h, set cursor shape and visibility
 E9D6				cursor:     ; CH = start line (0-7), CH bit 5 = 1  -> cursor off
							; CL = end line (0-7)
 E9D6  50					push    ax
 E9D7  52					push    dx
 E9D8  89 0E 0060				mov		[CursorShape], cx
 E9DC  F6 06 0085 10				test	byte ptr [ScanLinesChar], 10h
 E9E1  74 04					jz		short cursor8
 E9E3  03 C9					add		cx, cx
 E9E5  FE C5					inc		ch
 E9E7				cursor8:
 E9E7  BA 03D4					mov     dx, 3d4h
 E9EA  B0 0A					mov     al, 0ah
 E9EC  8A E5					mov		ah, ch
 E9EE  EF					out     dx, ax
 E9EF  40					inc		ax
 E9F0  8A E1					mov     ah, cl
 E9F2  EF					out     dx, ax
 E9F3  5A					pop     dx
 E9F4  58					pop     ax
 E9F5  C3					ret

				;---------------- fn 02h, set cursor pos
 E9F6				curpos:
 E9F6  50					push    ax
 E9F7  53					push    bx
 E9F8  8A C7					mov     al, bh
 E9FA  C1 EB 07					shr     bx, 7
 E9FD  83 E3 0E					and     bx, 0eh
 EA00  89 57 50					mov     CursorPos[bx], dx
 EA03  80 3E 0049 03				cmp     byte ptr ActiveVideoMode, 3
 EA08  75 1E					jne     short curpos1
 EA0A  3A 06 0062				cmp     al, ActivePage
 EA0E  75 18					jne     short curpos1
 EA10  52					push    dx
 EA11  33 C0					xor     ax, ax
 EA13  86 C6					xchg    al, dh        
 EA15  6B C0 50					imul    ax, 80
 EA18  03 C2					add     ax, dx
 EA1A  BA 03D4					mov     dx, 3d4h
 EA1D  50					push    ax
 EA1E  8A E0					mov 	ah, al
 EA20  B0 0F					mov		al, 0fh
 EA22  EF					out		dx, ax
 EA23  58					pop		ax
 EA24  B0 0E					mov		al, 0eh
 EA26  EF					out 	dx, ax
 EA27  5A					pop     dx
 EA28				curpos1:        
 EA28  5B					pop     bx
 EA29  58					pop     ax
 EA2A  C3					ret

				;---------------- fn 03h, get cursor pos
 EA2B				getcurpos:
 EA2B  53					push    bx
 EA2C  C1 EB 07					shr     bx, 7
 EA2F  83 E3 0E					and     bx, 0eh
 EA32  8B 57 50					mov     dx, CursorPos[bx]
 EA35  8B 0E 0060				mov     cx, CursorShape
 EA39  5B					pop     bx
 EA3A  C3					ret

				;---------------- fn 04h, light pen
 EA3B				lightpen:
 EA3B  B4 00					mov     ah, 0   ; not triggered
 EA3D  C3					ret

				;---------------- fn 05h, set active video page
 EA3E				apage:
 EA3E  60					pusha
 EA3F  24 07					and     al, 7
 EA41  8A F8					mov     bh, al
 EA43  A2 0062					mov     ActivePage, al
 EA46  A0 0049					mov     al, ActiveVideoMode
 EA49  3C 13					cmp     al, 13h
 EA4B  73 19					jae		short apage1
 EA4D  3C 03					cmp     al, 3
 EA4F  77 25					ja		short apage2
 EA51  B8 000A					mov     ax, 0ah
 EA54  E7 8A					out     8ah, ax
 EA56  40					inc     ax
 EA57  E7 8B					out     8bh, ax
 EA59  B4 03					mov     ah, 3
 EA5B  CD 10					int     10h        ; get cursor pos
 EA5D  B4 02					mov     ah, 2
 EA5F  CD 10					int     10h        ; set cursor pos
 EA61  B8 0400					mov		ax, 400h
 EA64  EB 13					jmp     short apage4
 EA66				apage1:	
 EA66  B8 000A					mov     ax, 0ah		; mode 13h and 25h
 EA69  02 C7					add     al, bh
 EA6B  E7 8A					out     8ah, ax
 EA6D  40					inc     ax
 EA6E  3C 12					cmp     al, 12h
 EA70  75 02					jne     short apage3
 EA72  B0 0A					mov     al, 0ah
 EA74				apage3: 
 EA74  E7 8B					out     8bh, ax
 EA76				apage2:
 EA76  A1 004C					mov	ax, RegenLength
 EA79				apage4:
 EA79  C1 EB 08					shr     bx, 8      ; page number
 EA7C  F7 E3					mul     bx
 EA7E  8B D8					mov     bx, ax     ; 1 means 4 bytes, or 2 characters
 EA80  C1 E0 02					shl     ax, 2	   ; 1 means 1 byte   
 EA83  A3 004E					mov     PageOffset, ax
 EA86  BA 03D4					mov     dx, 3d4h
 EA89  8A E3					mov		ah, bl
 EA8B  B0 0D					mov		al, 0dh
 EA8D  EF					out		dx, ax
 EA8E  8A E7					mov		ah, bh
 EA90  48					dec		ax
 EA91  EF					out		dx, ax
 EA92  61					popa
 EA93  C3					ret

				;---------------- fn 06h, scroll up / clr
 EA94				scrollup:
 EA94  60					pusha
 EA95  06					push    es
 EA96  87 CA					xchg    cx, dx
 EA98  2B CA					sub     cx, dx
 EA9A  41					inc     cx
 EA9B  E8 0047					call    scr_params
 EA9E				scrollup6:        
 EA9E  68 B800					push    0b800h          ; segment
 EAA1  07					pop     es
 EAA2  02 D2					add     dl, dl
 EAA4  03 FF					add     di, di
 EAA6  03 3E 004E				add     di, PageOffset  ; di = top left corner address
 EAAA  91					xchg    ax, cx          ; ah = 0
 EAAB  84 DB					test    bl, bl
 EAAD  74 13					jz      short scrollup3       ; clear
 EAAF  2A E3					sub     ah, bl
 EAB1  72 0F					jb      short scrollup3       ; clear
 EAB3  03 F7					add     si, di
 EAB5				scrollup4:        
 EAB5  8A C8					mov     cl, al
 EAB7  F3/ 26: A5				rep     movsw es:[si], es:[di]
 EABA  03 F2					add     si, dx
 EABC  03 FA					add     di, dx
 EABE  FE CC					dec     ah              
 EAC0  79 F3					jns     short scrollup4       ; ch = lines - 1
 EAC2				scrollup3:                      
 EAC2  02 E3					add     ah, bl          ; clear rectangle: DI=address, ah=lines, al=columns, bh=attribute
 EAC4  93					xchg    ax, bx
 EAC5  B0 20					mov     al, ' '
 EAC7				scrollup5:
 EAC7  8A CB					mov     cl, bl
 EAC9  F3/ AB					rep     stosw
 EACB  03 FA					add     di, dx
 EACD  FE CF					dec     bh
 EACF  79 F6					jns     short scrollup5       ; ch = lines - 1
 EAD1				scrollexit:
 EAD1  07					pop     es
 EAD2  61					popa
 EAD3  C3					ret

				;---------------- fn 07h, scroll dn / clr
 EAD4				scrolldn:
 EAD4  FD					std
 EAD5  60					pusha
 EAD6  06					push    es
 EAD7  F7 D9					neg     cx
 EAD9  03 CA					add     cx, dx
 EADB  41					inc     cx
 EADC  E8 0006					call    scr_params
 EADF  F7 DA					neg     dx
 EAE1  F7 DE					neg     si
 EAE3  EB B9					jmp     short scrollup6

 EAE5				scr_params:
 EAE5  8A D8					mov     bl, al          ; lines
 EAE7  33 C0					xor     ax, ax
 EAE9  86 C6					xchg    al, dh
 EAEB  6B F8 50					imul    di, ax, 80
 EAEE  03 FA					add     di, dx
 EAF0  B2 50					mov     dl, 80          ; dh = 0
 EAF2  2A D1					sub     dl, cl
 EAF4  8A C3					mov     al, bl
 EAF6  69 F0 00A0				imul    si, ax, 160
 EAFA  C3					ret
				;---------------- fn 08h, read char/attr
 EAFB				readchar:
 EAFB  53					push    bx
 EAFC  E8 0004					call    mode3chaddr
 EAFF  8B 07					mov     ax, [bx]
 EB01  5B					pop     bx
 EB02  C3					ret

 EB03				mode3chaddr:    ; returns current char address in mode3 in ds:bx. Input: bh=page, ds=40h 
 EB03  50					push    ax
 EB04  81 E3 0700				and     bx, 700h
 EB08  8D 87 B800				lea     ax, [bx+0b800h]
 EB0C  C1 EB 07					shr     bx, 7
 EB0F  8B 5F 50					mov     bx, CursorPos[bx]
 EB12  8E D8					mov     ds, ax
 EB14  33 C0					xor     ax, ax
 EB16  86 C7					xchg    al, bh
 EB18  6B C0 50					imul    ax, 80
 EB1B  03 D8					add     bx, ax
 EB1D  03 DB					add     bx, bx
 EB1F  58					pop     ax
 EB20  C3					ret

				;---------------- fn 09h, write char/attr
 EB21				writecharattr:
 EB21  50					push    ax
 EB22  06					push    es
 EB23  53					push    bx
 EB24  51					push    cx
 EB25  8A E3					mov     ah, bl
 EB27  E8 FFD9					call    mode3chaddr
 EB2A  1E					push    ds
 EB2B  07					pop     es
 EB2C  87 FB					xchg    di, bx
 EB2E  F3/ AB					rep     stosw
 EB30  87 FB					xchg    di, bx
 EB32  59					pop     cx
 EB33  5B					pop     bx
 EB34  07					pop     es
 EB35  58					pop     ax
 EB36  C3					ret

				;---------------- fn 0ah, write char
 EB37				writechar:
 EB37  E3 0E					jcxz    short writecharskip
 EB39  53					push    bx
 EB3A  51					push    cx
 EB3B  E8 FFC5					call    mode3chaddr
 EB3E				writechar3:        
 EB3E  88 07					mov     [bx], al
 EB40  83 C3 02					add     bx, 2
 EB43  E2 F9					loop    short writechar3
 EB45  59					pop     cx
 EB46  5B					pop     bx
 EB47				writecharskip:        
 EB47  C3					ret

				;---------------- fn 0bh,  Set Color Palette (CGA)
 EB48				setcolorpalette:
 EB48  52					push    dx
 EB49  1E					push    ds
 EB4A  6A 40					push    40h
 EB4C  1F					pop     ds
 EB4D  BA 03D9					mov     dx, 03d9h
 EB50  A0 0066					mov     al, CrtPalette
 EB53  0A FF					or      bh, bh
 EB55  75 09					jnz     setcolorpalette_pal
 EB57  24 20					and     al, 020h ; clear brightness and color
 EB59  80 E3 1F					and     bl, 01fh
 EB5C  0A C3					or      al, bl
 EB5E  EB 07					jmp short setcolorpalette_out
 EB60				setcolorpalette_pal:
 EB60  24 1F					and     al, 01fh ; clear palette bit
 EB62  C0 E3 05					shl     bl, 5
 EB65  0A C3					or      al, bl
 EB67				setcolorpalette_out:
 EB67  EE					out     dx,al
 EB68  A2 0066					mov     CrtPalette, al
 EB6B  1F					pop     ds
 EB6C  5A					pop     dx
 EB6D  C3					ret

				;---------------- fn 0eh, write char as TTY
 EB6E				writecharTTY:
 EB6E  50					push    ax
 EB6F  53					push    bx
 EB70  52					push    dx
 EB71  8A 1E 0062				mov     bl, ActivePage
 EB75  B7 00					mov     bh, 0
 EB77  03 DB					add     bx, bx
 EB79  8B 57 50					mov     dx, CursorPos[bx]
 EB7C  C1 E3 07					shl     bx, 7
 EB7F  B4 0A					mov     ah, 0ah
 EB81  E8 0008					call    tty
 EB84  B4 02					mov     ah, 2       ; set cursor pos
 EB86  CD 10					int     10h
 EB88  5A					pop     dx
 EB89  5B					pop     bx
 EB8A  58					pop     ax 
 EB8B  C3					ret        

 EB8C				tty:    ; dx=xy, bh=page, al=char, bl=attr, ah=0ah(no attr) or 09h(with attr)
 EB8C  F7 06 0018 0008				test    word ptr KbdFlags2, Pause
 EB92  75 F8					jnz     short tty
 EB94  51					push    cx
 EB95  3C 07					cmp     al, 7
 EB97  74 1A					je      short bell
 EB99  3C 08					cmp     al, 8
 EB9B  74 18					je      short bs
 EB9D  3C 0A					cmp     al, 0ah
 EB9F  74 22					je      short cr
 EBA1  3C 0D					cmp     al, 0dh
 EBA3  74 18					je      short lf
 EBA5  B9 0001					mov     cx, 1
 EBA8  CD 10					int     10h         ; write char at cursor
 EBAA  42					inc     dx
 EBAB  3A 16 004A				cmp     dl, ScreenWidth
 EBAF  73 10					jae     short crlf
 EBB1				tty1:
 EBB1  59					pop     cx
 EBB2  C3					ret
 EBB3				bell:
				; TODO bell code        
 EBB3  EB FC					jmp     short tty1
 EBB5				bs:
 EBB5  80 EA 01					sub     dl, 1
 EBB8  80 D2 00					adc     dl, 0      
 EBBB  EB F4					jmp     short tty1
 EBBD				lf:
 EBBD  B2 00					mov     dl, 0
 EBBF  EB F0					jmp     short tty1
 EBC1				crlf:
 EBC1  B2 00					mov     dl, 0        
 EBC3				cr:        
 EBC3  FE C6					inc     dh
 EBC5  3A 36 0084				cmp     dh, ScreenRows
 EBC9  76 E6					jbe     short tty1
 EBCB  FE CE					dec     dh
				;        mov     ah, 8
				;        int     10h         ; read attribute at cursor pos
 EBCD  53					push    bx          ; save active page in bh
 EBCE  52					push    dx
				;        xchg    ax, bx
 EBCF  B7 07					mov     bh, 7       ; default attribute
 EBD1  B8 0601					mov     ax, 601h    
 EBD4  8A 36 0084				mov     dh, ScreenRows
 EBD8  8A 16 004A				mov     dl, ScreenWidth
 EBDC  4A					dec     dx
 EBDD  33 C9					xor     cx, cx
 EBDF  CD 10					int     10h         ; scroll up
 EBE1  5A					pop     dx
 EBE2  5B					pop     bx          ; restore active page in bh         
 EBE3  EB CC					jmp     short tty1
						
				;---------------- fn 0fh, read video mode
 EBE5				readmode:
 EBE5  A0 0087					mov     al, EgaMiscInfo
 EBE8  24 80					and     al, 80h
 EBEA  0A 06 0049				or      al, ActiveVideoMode
 EBEE  8A 26 004A				mov     ah, ScreenWidth
 EBF2  8A 3E 0062				mov     bh, ActivePage
 EBF6  C3					ret


				;---------------- fn 10h, palette
 EBF7 EC3D R EC3C R EC4D R	paltable    dw  setonereg, palexit, setallreg, setblink, palexit, palexit, palexit, readonereg, readoverscan, readallreg, palexit, palexit, palexit, palexit, palexit, palexit
       EC61 R EC3C R EC3C R
       EC3C R EC8D R ECB9 R
       ECA2 R EC3C R EC3C R
       EC3C R EC3C R EC3C R
       EC3C R
 EC17  ECBC R EC3C R ECD2 R				dw  setoneDAC, palexit, setblockDAC, paging, palexit, readoneDAC, palexit, readblockDAC, setPELmask, getPELmask, getpaging, grayscale
       ECE3 R EC3C R ED13 R
       EC3C R ED2B R ED3C R
       ED45 R ED4E R ED64 R

 EC2F				pal:
 EC2F  3C 1B					cmp     al, 1bh
 EC31  77 09					ja      short palexit
 EC33  8B F0					mov     si, ax
 EC35  03 F6					add     si, si
 EC37  2E: FF 94 CBF7 R				call    cs:paltable[si-2000h]
 EC3C				palexit:
 EC3C  C3					ret

 EC3D				setonereg:
 EC3D  60					pusha
 EC3E  BA 03DA					mov		dx, 3dah
 EC41  EC					in		al, dx
 EC42  BA 03C0					mov		dx, 3c0h
 EC45  8A C3					mov		al, bl
 EC47  EE					out		dx, al
 EC48  8A C7					mov		al, bh
 EC4A  EE					out		dx, al
 EC4B  61					popa
 EC4C				setonereg1:        
 EC4C  C3					ret        

 EC4D				setallreg:
 EC4D  60					pusha
 EC4E  B0 00					mov     al, 0
 EC50  8B F2					mov     si, dx
 EC52  B3 0F					mov     bl, 15
 EC54				setallreg1:        
 EC54  26: 8A 7C 0F				mov     bh, es:[si+15]
 EC58  CD 10					int     10h
 EC5A  4E					dec     si
 EC5B  FE CB					dec     bl
 EC5D  79 F5					jns     short setallreg1
 EC5F  61					popa
 EC60  C3					ret

 EC61				setblink:
 EC61  60					pusha
 EC62  BA 03DA					mov		dx, 3dah
 EC65  EC					in		al, dx
 EC66  BA 03C0					mov     dx, 3c0h
 EC69  B0 10					mov     al, 10h
 EC6B  EE					out     dx, al
 EC6C  2E: A0 E69D R				mov		al, cs:p3c0r10      
 EC70  C0 E3 03					shl     bl, 3
 EC73  32 C3					xor		al, bl
 EC75  24 F7					and		al, not 8
 EC77  32 C3					xor		al, bl
 EC79  EE					out     dx, al          ; set blink flag
 EC7A  2E: A2 E69D R				mov		cs:p3c0r10, al
 EC7E  C0 E0 02					shl     al, 2
 EC81  32 06 0089				xor     al, VgaFlags
 EC85  24 20					and     al, 20h
 EC87  30 06 0089				xor     VgaFlags, al
 EC8B				setblink1:
 EC8B  61					popa
 EC8C  C3					ret

 EC8D				readonereg:
 EC8D  52					push	dx
 EC8E  50					push	ax
 EC8F  BA 03DA					mov		dx, 3dah
 EC92  EC					in		al, dx
 EC93  BA 03C0					mov		dx, 3c0h
 EC96  8A C3					mov		al, bl
 EC98  EE					out		dx, al
 EC99  42					inc		dx
 EC9A  EC					in		al, dx
 EC9B  4A					dec		dx
 EC9C  EE					out		dx, al
 EC9D  8A F8					mov		bh, al
 EC9F  58					pop		ax
 ECA0  5A					pop		dx
 ECA1  C3					ret

 ECA2				readallreg:
 ECA2  60					pusha
 ECA3  8B FA					mov     di, dx
 ECA5  B3 00					mov     bl, 0
 ECA7				readllreg1:
 ECA7  B0 07					mov     al, 7
 ECA9  CD 10					int     10h
 ECAB  8A C7					mov     al, bh
 ECAD  AA					stosb
 ECAE  43					inc     bx
 ECAF  80 FB 10					cmp     bl, 16
 ECB2  75 F3					jne     short readllreg1
 ECB4  B0 00					mov     al, 0   ; overscan color
 ECB6  AA					stosb
 ECB7  61					popa
 ECB8  C3					ret

 ECB9				readoverscan:
 ECB9  B7 00					mov     bh, 0
 ECBB  C3					ret

 ECBC				setoneDAC:
 ECBC  50					push    ax
 ECBD  52					push    dx
 ECBE  92					xchg    ax, dx
 ECBF  8A C3					mov     al, bl
 ECC1  BA 03C8					mov     dx, 3c8h
 ECC4  EE					out     dx, al
 ECC5  42					inc     dx
 ECC6  8A C4					mov     al, ah
 ECC8  EE					out     dx, al
 ECC9  8A C5					mov     al, ch
 ECCB  EE					out     dx, al
 ECCC  8A C1					mov     al, cl
 ECCE  EE					out     dx, al
 ECCF  5A					pop     dx
 ECD0  58					pop     ax
 ECD1  C3					ret

 ECD2				setblockDAC:
 ECD2  60					pusha
 ECD3  8B F2					mov     si, dx
 ECD5  BA 03C8					mov     dx, 3c8h
 ECD8  93					xchg    ax, bx
 ECD9  EE					out     dx, al
 ECDA  42					inc     dx
 ECDB  6B C9 03					imul    cx, 3
 ECDE  F3/ 26: 6E				rep     outsb dx, es:[si]
 ECE1  61					popa
 ECE2  C3					ret

 ECE3				paging:
 ECE3  60					pusha
 ECE4  BA 03DA					mov		dx, 3dah
 ECE7  EC					in		al, dx
 ECE8  BA 03C0					mov		dx, 3c0h
 ECEB  84 DB					test    bl, bl
 ECED  2E: A0 E69D R				mov		al, cs:p3c0r10
 ECF1  75 11					jnz     short paging1
 ECF3  02 C0					add		al, al
 ECF5  D0 CF					ror		bh, 1
 ECF7  D0 D8					rcr		al, 1
 ECF9  2E: A2 E69D R				mov		cs:p3c0r10, al
 ECFD  50					push	ax
 ECFE  B0 10					mov		al, 10h
 ED00  EE					out		dx, al
 ED01  58					pop		ax
 ED02  EB 0C					jmp     short paging2
 ED04				paging1:
 ED04  02 C0					add		al, al
 ED06  72 03					jc		paging3
 ED08  C0 E7 02					shl		bh, 2
 ED0B				paging3:
 ED0B  B0 14					mov		al, 14h
 ED0D  EE					out		dx, al
 ED0E  8A C7					mov		al, bh
 ED10				paging2:        
 ED10  EE					out		dx, al
 ED11  61					popa
 ED12  C3					ret

 ED13				readoneDAC:
 ED13  50					push    ax
 ED14  52					push    dx
 ED15  8A C3					mov     al, bl
 ED17  BA 03C7					mov     dx, 3c7h
 ED1A  EE					out     dx, al
 ED1B  42					inc     dx
 ED1C  42					inc     dx
 ED1D  EC					in      al, dx
 ED1E  8A E0					mov     ah, al
 ED20  EC					in      al, dx
 ED21  8A E8					mov     ch, al
 ED23  EC					in      al, dx
 ED24  8A C8					mov     cl, al
 ED26  5A					pop     dx
 ED27  8A F4					mov     dh, ah
 ED29  58					pop     ax             
 ED2A  C3					ret

 ED2B				readblockDAC:
 ED2B  60					pusha
 ED2C  8B FA					mov     di, dx
 ED2E  BA 03C7					mov     dx, 3c7h
 ED31  93					xchg    ax, bx
 ED32  EE					out     dx, al
 ED33  42					inc     dx
 ED34  42					inc     dx
 ED35  6B C9 03					imul    cx, 3
 ED38  F3/ 6C					rep     insb                
 ED3A  61					popa
 ED3B  C3					ret

 ED3C				setPELmask:
 ED3C  52					push    dx
 ED3D  93					xchg    ax, bx
 ED3E  BA 03C6					mov     dx, 3c6h
 ED41  EE					out     dx, al
 ED42  93					xchg    ax, bx
 ED43  5A					pop     dx
 ED44  C3					ret

 ED45				getPELmask:
 ED45  52					push    dx
 ED46  93					xchg    ax, bx
 ED47  BA 03C6					mov     dx, 3c6h
 ED4A  EC					in      al, dx
 ED4B  93					xchg    ax, bx
 ED4C  5A					pop     dx
 ED4D  C3					ret

 ED4E				getpaging:
 ED4E  B3 14					mov		bl, 14h
 ED50  E8 FF3A					call	readonereg	; returns BH
 ED53  2E: 8A 1E E69D R				mov		bl, cs:p3c0r10
 ED58  80 E7 0F					and		bh, 0fh
 ED5B  C0 EB 07					shr		bl, 7
 ED5E  75 03					jnz		short getpaging1
 ED60  C0 EF 02					shr		bh, 2
 ED63				getpaging1:
 ED63  C3					ret

 ED64				grayscale:
 ED64  E3 2B					jcxz    short grayscale2
 ED66  60					pusha
 ED67  8A F9					mov     bh, cl
 ED69				grayscale1:        
 ED69  B0 15					mov     al, 15h
 ED6B  CD 10					int     10h
 ED6D  C1 EA 08					shr     dx, 8
 ED70  6B F2 4D					imul    si, dx, 77
 ED73  8A D5					mov     dl, ch
 ED75  69 D2 0097				imul    dx, 151
 ED79  B5 00					mov     ch, 0
 ED7B  6B C9 1C					imul    cx, 28
 ED7E  03 D6					add     dx, si
 ED80  03 D1					add     dx, cx
 ED82  8A EE					mov     ch, dh
 ED84  8A CE					mov     cl, dh
 ED86  B0 10					mov     al, 10h
 ED88  CD 10					int     10h
 ED8A  FE C3					inc     bl
 ED8C  FE CF					dec     bh
 ED8E  75 D9					jne     short grayscale1        
 ED90  61					popa
 ED91				grayscale2:        
 ED91  C3					ret


				;---------------- fn 11h, character generator
 ED92				loadUDF:    ; CX=chars, DX=first char, BH=bytes/char, ES:BP=font
 ED92  60					pusha
 ED93  92					xchg    ax, dx
 ED94  87 CB					xchg    cx, bx
 ED96  C1 E9 10					shr     cx, 16 ; 8 when fonts are installed
 ED99  BA 03CB					mov     dx, 03cbh
 ED9C  8B F5					mov     si, bp
 ED9E				loadUDF1:
 ED9E  EF					out     dx, ax
 ED9F  51					push    cx
 EDA0  F3/ 26: 6E		        rep     outsb dx, es:[si]
 EDA3  59					pop     cx
 EDA4  40					inc     ax
 EDA5  4B					dec     bx
 EDA6  75 F6					jnz     short loadUDF1
 EDA8  61					popa
 EDA9  A8 10					test    al, 10h
 EDAB  74 31					jz      short loadUDFexit
 EDAD  6A 40					push    40h
 EDAF  1F					pop     ds
 EDB0  50					push    ax
 EDB1  B8 0190					mov     ax, 400 ; screen lines in text mode
 EDB4  F6 F7					div     bh
 EDB6  48					dec     ax
 EDB7  A2 0084					mov     ScreenRows, al
 EDBA  88 3E 0085				mov     byte ptr ScanLinesChar, bh
 EDBE  2E: A0 E69D R				mov		al, cs:p3c0r10		; set/reset half bit
 EDC2  32 C7					xor		al, bh		
 EDC4  0C 10					or		al, 10h
 EDC6  32 C7					xor		al, bh
 EDC8  A8 01					test	al, 1
 EDCA  75 11					jnz		short loadUDFexit1	; not in text mode
 EDCC  50					push	ax
 EDCD  BA 03DA					mov		dx, 3dah
 EDD0  EC					in		al, dx
 EDD1  BA 03C0					mov		dx, 3c0h
 EDD4  B0 10					mov		al, 10h
 EDD6  EE					out		dx, al
 EDD7  58					pop		ax
 EDD8  EE					out		dx, al
 EDD9  2E: A2 E69D R				mov		cs:p3c0r10, al
 EDDD				loadUDFexit1:
 EDDD  58					pop     ax 
 EDDE				loadUDFexit:        
 EDDE  C3					ret

 EDDF				chargen:
 EDDF  A8 EF					test    al, not 10h     ; test for 00h and 10h  ; UDF
 EDE1  74 AF					jz      short loadUDF
 EDE3  A8 EE					test    al, not 11h     ; test for 01h and 11h  ; 8x14
 EDE5  74 26					jz      short loadROMfont16
 EDE7  A8 ED					test    al, not 12h     ; test for 02h and 12h  ; 8x8
 EDE9  74 17					jz      short loadROMfont8
 EDEB  A8 EB					test    al, not 14h     ; test for 04h and 14h  ; 8x16
 EDED  74 1E					jz      short loadROMfont16
 EDEF  3C 20					cmp     al, 20h
 EDF1  72 EB					jb      loadUDFexit
 EDF3  74 30					je      short set1f
 EDF5  3C 21					cmp     al, 21h
 EDF7  74 37					je      short setgrUDF
 EDF9  3C 24					cmp     al, 24h
 EDFB  76 60					jbe     short setROMgrFont
 EDFD  3C 30					cmp     al, 30h
 EDFF  74 7A					je      short getfontinfo
 EE01  C3					ret

 EE02				loadROMFont8:
 EE02  60					pusha
 EE03  BB 0800					mov     bx, 0800h       ; 8x8 chars, block 0
 EE06  2E: 8B 2E EEAC R				mov     bp, cs:fontinfo[2]
 EE0B  EB 09					jmp     short loadROMFont161
					 
 EE0D				loadROMFont16:
 EE0D  60					pusha
 EE0E  BB 1000					mov     bx, 1000h       ; 8x16 chars, block 0
 EE11  2E: 8B 2E EEB2 R				mov     bp, cs:fontinfo[8]
 EE16				loadROMFont161:
 EE16  B9 0100					mov     cx, 100h        ; all chars
 EE19  33 D2					xor     dx, dx
 EE1B  06					push    es
 EE1C  0E					push    cs
 EE1D  07					pop     es
 EE1E  24 10					and     al, 10h
 EE20  CD 10					int     10h             ; loadUDF
 EE22  07					pop     es
 EE23  61					popa
 EE24  C3					ret

 EE25				set1f:
 EE25  33 F6					xor     si, si
 EE27  8E DE					mov     ds, si
 EE29  89 6C 7C					mov     [si+1fh*4], bp
 EE2C  8C 44 7E					mov     [si+1fh*4+2], es
 EE2F  C3					ret
						
 EE30				setgrUDF:
 EE30  60					pusha
 EE31  E3 AB					jcxz    short loadUDFexit
 EE33  1E					push    ds
 EE34  33 F6					xor     si, si
 EE36  8E DE					mov     ds, si
 EE38  89 AC 010C				mov     [si+43h*4], bp
 EE3C  8C 84 010E				mov     [si+43h*4+2], es
 EE40  1F					pop     ds
 EE41  B8 00C8					mov     ax, 200
 EE44  80 3E 0049 13				cmp     byte ptr ActiveVideoMode, 13h
 EE49  72 10					jb      short setgrUDFexit
 EE4B  74 03					je      short setgrUDF1
 EE4D  B8 01E0					mov     ax, 480         ; mode 25h, 480 lines
 EE50				setgrUDF1:
 EE50  89 0E 0085				mov     ScanLinesChar, cx
 EE54  99					cwd
 EE55  F7 F1					div     cx
 EE57  48					dec     ax
 EE58  A2 0084					mov     ScreenRows, al
 EE5B				setgrUDFexit:
 EE5B  61					popa
 EE5C  C3					ret

 EE5D				setROMgrFont:       
 EE5D  60					pusha
 EE5E  06					push    es
 EE5F  B9 0008					mov     cx, 8
 EE62  0E					push    cs
 EE63  07					pop     es
 EE64  BD D800 R				mov     bp, font8x8
 EE67  3C 23					cmp     al, 23h
 EE69  74 03					je      short setROMgrFont1
 EE6B  BD C800 R				mov     bp, offset font8x16
 EE6E				setROMgrFont1:        
 EE6E  B0 21					mov     al, 21h
 EE70  CD 10					int     10h     ; set graphic UDF
 EE72  48					dec     ax
 EE73  BD DC00 R				mov     bp, font8x8 + 128*8
 EE76  CD 10					int     10h     ; set INT 1fh
 EE78  07					pop     es
 EE79  61					popa
 EE7A  C3					ret
						
 EE7B				getfontinfo:
 EE7B  8B 0E 0085				mov     cx, ScanLinesChar
 EE7F  8A 16 0084				mov     dl, ScreenRows
 EE83  80 FF 01					cmp     bh, 1
 EE86  77 0E					ja      short getfontinfo1
 EE88  6A 00					push    0
 EE8A  1F					pop     ds
 EE8B  C4 2E 007C				les     bp, ds:[1fh*4] 
 EE8F  72 18					jb      short getfontinfoexit
 EE91  C4 2E 010C				les     bp, ds:[43h*4]
 EE95  C3					ret
 EE96				getfontinfo1:
 EE96  80 FF 07					cmp     bh, 7
 EE99  77 0E					ja      short getfontinfoexit
 EE9B  8B F3					mov     si, bx
 EE9D  C1 EE 08					shr     si, 8
 EEA0  03 F6					add     si, si
 EEA2  2E: 8B AC EEA6 R				mov     bp, cs:fontinfo[si-4]
 EEA7  0E					push    cs
 EEA8  07					pop     es                    
 EEA9				getfontinfoexit:
 EEA9  C3					ret

 EEAA BA00 R D800 R DC00 R	fontinfo    dw  font8x14, font8x8, font8x8+128*8, font8x14, font8x16, font8x16
       BA00 R C800 R C800 R

				;---------------- fn 12h, special functions
 EEB6				special:
 EEB6  80 FB 10					cmp     bl, 10h
 EEB9  75 0B					jne     short special1
 EEBB  8A 0E 0088				mov     cl, EgaMiscInfo2    ; cl = switch settings
 EEBF  83 E1 0F					and     cx, 15              ; ch <- 0 (feature bits)
 EEC2  BB 0003					mov     bx, 3               ; bh <- 0 (color mode), bl = video memory size
 EEC5  C3					ret
 EEC6				special1:
 EEC6  80 FB 31					cmp     bl, 31h
 EEC9  75 0F					jne     short special2
 EECB  F6 D8					neg     al
 EECD  32 06 0089				xor     al, VgaFlags
 EED1  24 08					and     al, 8       ; transfer palette loading bit to VgaFlags
 EED3  30 06 0089				xor     VgaFlags, al
 EED7  B0 12					mov     al, 12h     ; supported function
 EED9  C3					ret
 EEDA				special2:
 EEDA  B0 00					mov     al, 0       ; unsupported function
 EEDC  C3					ret


				;---------------- fn 13h, write string
 EEDD				writestr:
 EEDD  E3 31					jcxz    short wstrexit
 EEDF  60					pusha
 EEE0  8B F3					mov     si, bx
 EEE2  C1 EE 08					shr     si, 8
 EEE5  03 F6					add     si, si
 EEE7  FF 74 50					push    CursorPos[si]
 EEEA  B4 09					mov     ah, 9       ; write tty char/attribute
 EEEC				wstr1:        
 EEEC  50					push    ax
 EEED  A8 02					test    al, 2
 EEEF  26: 8A 46 00				mov     al, es:[bp]
 EEF3  74 05					jz      short noattr
 EEF5  45					inc     bp
 EEF6  26: 8A 5E 00				mov     bl, es:[bp]
 EEFA				noattr:
 EEFA  45					inc     bp
 EEFB  89 54 50					mov     CursorPos[si], dx
 EEFE  E8 FC8B					call    tty
 EF01  58					pop     ax
 EF02  E2 E8					loop    short wstr1
 EF04  8F 44 50					pop     CursorPos[si]
 EF07  A8 01					test    al, 1
 EF09  74 04					jz      short wstr2             
 EF0B  B4 02					mov     ah, 2       ; set cursor pos
 EF0D  CD 10					int     10h                
 EF0F				wstr2:        
 EF0F  61					popa
 EF10				wstrexit:        
 EF10  C3					ret

				;---------------- fn 1ah, get/set display combination code
 EF11				getdcc:
 EF11  3C 01					cmp     al, 1
 EF13  77 0C					ja      short getdccexit
 EF15  8A C4					mov     al, ah
 EF17  74 03					je      short setdcc
 EF19  BB 0008					mov     bx, 08h
 EF1C				dccval  label word        
 EF1C				setdcc:
 EF1C  2E: 89 1E EF1A R				mov     cs:[dccval-2], bx
 EF21				getdccexit:        
 EF21  C3					ret        

				;---------------- fn 1bh, query status
 EF22				querystatus:
 EF22  60					pusha
 EF23  B8 EF81 R				mov     ax, offset staticfunctable
 EF26  AB					stosw
 EF27  8C C8					mov     ax, cs
 EF29  AB					stosw
 EF2A  BE 0049					mov     si, offset ActiveVideoMode
 EF2D  80 3C 12					cmp     byte ptr [si], 12h
 EF30  B9 0021					mov     cx, 33          ; info copied from BDA        
 EF33  F3/ A4					rep     movsb
 EF35  B8 0008					mov     ax, 8
 EF38  AB					stosw                   ; display info (one VGA analog color monitor)
 EF39  BB 0208					mov     bx, 208h        ; 400 scan lines, 8 pages
 EF3C  B0 10					mov     al, 10h         ; 16 colors         
 EF3E  72 14					jb      short querystatus1	; mode03h
 EF40  BB 0302					mov		bx, 302h	; 480 scan lines, 2 pageS
 EF43  74 0F					je		short querystatus1	; mode12h 
 EF45  B7 00					mov     bh, 0           ; scan lines code (0=200, 1=350, 2=400, 3=480)
 EF47  B8 0100					mov     ax, 100h        ; 256 colors
 EF4A  80 3E 0049 13				cmp     byte ptr ActiveVideoMode, 13h
 EF4F  74 0D					je      short querystatus3     ; mode13h
 EF51  BB 0301					mov     bx, 301h        ; 480 scan lines, 1 page
 EF54				querystatus1:
 EF54  80 3E 0049 0D				cmp		byte ptr ActiveVideoMode, 0dh
 EF59  75 03					jne		short querystatus3
 EF5B  BB 0008					mov		bx, 0008h	; 200 scan lines, 8 pages
 EF5E				querystatus3:
 EF5E  AB					stosw
 EF5F  93					xchg    ax, bx
 EF60  AB					stosw
 EF61  33 C0					xor     ax, ax
 EF63  AB					stosw                   ; font block info (45)
 EF64  A0 0089					mov     al, VgaFlags
 EF67  24 2F					and     al, 00101111b
 EF69  AB					stosw        
 EF6A  AB					stosw
 EF6B  A0 0087					mov     al, EgaMiscInfo
 EF6E  C0 E8 04					shr     al, 4
 EF71  24 07					and     al, 7           ; video memory size
 EF73  AB					stosw
 EF74  B0 02					mov     al, 2
 EF76  AA					stosb                   ; color display attached
 EF77  B1 06					mov     cl, 6
 EF79  33 C0					xor     ax, ax
 EF7B  F3/ AB					rep     stosw           ; 12 reserved bytes
 EF7D  61					popa
 EF7E  8A C4					mov     al, ah          ; supported function
 EF80  C3					ret

 EF81 0C			staticfunctable db  00001100b   ; video modes 2h, 3h supported
 EF82  60							db  01100000b	; video mode 0dh, 0eh supported
 EF83  0D							db  00001101b   ; video modes 10h, 12h, 13h supported
 EF84  00							db  00000000b
 EF85  20							db  00100000b   ; video mode 25h supported
 EF86  00 00							db  0, 0
 EF88  04							db  00000100b   ; 400 scanline supported
 EF89  01							db  1           ; font blocks available in text mode
 EF8A  01							db  1           ; max active font blocks available in text mode

				;Bit(s)  Description
				;0      all modes on all displays function supported
				;1      gray summing function supported
				;2      character font loading function supported
				;3      default palette loading enable/disable supported
				;4      cursor emulation function supported
				;5      EGA palette present
				;6      color palette present
				;7      color-register paging function supported
				;8      light pen supported (see AH=04h)
				;9      save/restore state function 1Ch supported
				;10     intensity/blinking function supported (see AX=1003h)
				;11     Display Combination Code supported (see #00039)
				;12-15  unused (0)
 EF8B  EF					db  11101111b   ; miscellaneous function support flags 
 EF8C  0C					db  00001100b   ; miscellaneous function support flags
								 
 EF8D  00 00					db  0, 0        ; reserved
 EF8F  00					db  0           ; save pointer function flags
 EF90  00					db  0           ; reserved  

					   
 EF91 E785 R E9D6 R E9F6 R	vidtbl  dw  setmode, cursor, curpos, getcurpos, lightpen, apage, scrollup, scrolldn, readchar, writecharattr
       EA2B R EA3B R EA3E R
       EA94 R EAD4 R EAFB R
       EB21 R
 EFA5  EB37 R EB48 R E9D5 R			dw  writechar, setcolorpalette, nullproc, nullproc, writecharTTY, readmode
       E9D5 R EB6E R EBE5 R
 EFB1  EC2F R EDDF R EEB6 R			dw  pal, chargen, special, writestr, nullproc, nullproc, nullproc, nullproc, nullproc, nullproc, getdcc, querystatus, nullproc
       EEDD R E9D5 R E9D5 R
       E9D5 R E9D5 R E9D5 R
       E9D5 R EF11 R EF22 R
       E9D5 R
 EFCB				int10 endp

				; --------------------- INT 11h - Equipment ----------------
 = ds:[10h]			EquipmentWord       equ     <ds:[10h]>

 EFCB				int11   proc near
 EFCB  1E					push    ds
 EFCC  6A 40					push    40h
 EFCE  1F					pop     ds
 EFCF  A1 0010					mov     ax, EquipmentWord
 EFD2  1F					pop     ds
 EFD3  CF					iret
 EFD4				int11   endp

				; --------------------- INT 12h - Memory size ----------------
 = ds:[13h]			MemorySize       equ     <ds:[13h]>

 EFD4				int12   proc near
 EFD4  1E					push    ds
 EFD5  6A 40					push    40h
 EFD7  1F					pop     ds
 EFD8  A1 0013					mov     ax, MemorySize
 EFDB  1F					pop     ds
 EFDC  CF					iret        
 EFDD				int12   endp

				; --------------------- INT 13h - Disk services ----------------
 = ds:[74h]			HDLastError       equ     <ds:[74h]>
 = ds:[92h]			HDOpStarted       equ     <ds:[92h]>    ; bit 3: in INT13h (all other bits must be 0)
 = ds:[94h]			HDSize            equ     <ds:[94h]>

 EFDD				int13   proc near
 EFDD  1E					push    ds
 EFDE  55					push    bp
 EFDF  6A 40					push    40h
 EFE1  1F					pop     ds
 EFE2  80 36 0092 08				xor     byte ptr HDOpStarted, 8
 EFE7  74 13					jz      short inINT13
 EFE9  FB					sti                     
 EFEA  FC					cld
 EFEB  80 FC 1A					cmp     ah, 1ah
 EFEE  76 10					jbe     short Disk1
 EFF0  80 EC 26					sub     ah, 41h-1bh     ; extensions
 EFF3  80 FC 22					cmp     ah, 22h
 EFF6  76 08					jbe     short Disk1
 EFF8  B4 01					mov     ah, 1           ; bad command error
 EFFA  EB 14					jmp     short exit
 EFFC				inINT13:        
 EFFC  B4 AA					mov     ah, 0aah        ; drive not ready
 EFFE  EB 14					jmp     short exit2
 F000				Disk1:
 F000  8B E8					mov     bp, ax
 F002  C1 ED 07					shr     bp, 7
 F005  81 E5 01FE				and     bp, 1feh
 F009  1E					push    ds
 F00A  2E: FF 96 F028 R				call    cs:disktbl[bp]
 F00F  1F					pop     ds
 F010				exit:        
 F010  88 26 0074				mov     HDLastError, ah
 F014				exit2:
 F014  80 36 0092 08				xor     byte ptr HDOpStarted, 8
 F019  F6 DC					neg     ah              ; CF <- (AH != 0)
 F01B				exit1:
 F01B  8B EC					mov     bp, sp
 F01D  D0 5E 08					rcr     byte ptr [bp+8], 1
 F020  D0 46 08					rol     byte ptr [bp+8], 1  ; insert error CF on stack
 F023  F6 DC					neg     ah
 F025  5D					pop     bp
 F026  1F					pop     ds
 F027  CF					iret

 F028 F09C R F09F R F0AE R	disktbl dw      DiskReset, DiskGetStatus, DiskRead, DiskWrite, DiskVerify, DiskFormat, DiskFormat, DiskFormat, DiskGetParams, DiskInit, DiskRead, DiskWrite, DiskSeek, DiskRst, DiskReadSectBuffer, DiskWriteSectBuffer
       F0A9 R F0A4 R F0F8 R
       F0F8 R F0F8 R F107 R
       F0F8 R F0AE R F0A9 R
       F0F8 R F0F8 R F1C7 R
       F1C7 R
 F048  F0F8 R F0F8 R F0F8 R			dw      DiskReady, DiskRecalibrate, DiskDiag, DiskDiag, DiskDiag, DiskGetType, DiskChanged, DiskSetDASDType, DiskSetMediaType, DiskPark, DiskFormat,  DiskExtInstCheck, DiskExtRead, DiskExtWrite, DiskExtVerify, DiskExtLock
       F0F8 R F0F8 R F06E R
       F09C R F1C7 R F1C7 R
       F09C R F0F8 R F08E R
       F148 R F143 R F13E R
       F1C7 R
 F068  F1C7 R F0F8 R F17A R			dw      DiskExtEject, DiskExtSeek, DiskExtGetParams

 F06E				DiskGetType:
 F06E  80 FA 80					cmp     dl, 80h
 F071  75 29					jne     short DiskReset ; ah=0, drive not present
 F073  8B 0E 0094				mov     cx, HDSize      
 F077  8B D1					mov     dx, cx
 F079  85 C9					test    cx, cx
 F07B  74 1F					jz      short DiskReset ; ah=0, drive not present
 F07D  B4 FD					mov     ah, -3      ; HD present
 F07F  C1 E9 06					shr     cx, 6
 F082  C1 E2 0A					shl     dx, 10      ; CX:DX = HDSize * 1024
 F085				DiskGetTypeexit:        
 F085  1F					pop     ds          ; discard ret address
 F086  1F					pop     ds          ; discard DS
 F087  80 36 0092 08				xor     byte ptr HDOpStarted, 8     ; CF <- 0 
 F08C  EB 8D					jmp     short   exit1        

 F08E				DiskExtInstCheck:
 F08E  86 DF					xchg    bl, bh
 F090  B4 FF					mov     ah, -1
 F092  B9 0001					mov     cx, 1       ; extended disk access functions (AH=42h-44h,47h,48h) supported
 F095  80 FA 80					cmp     dl, 80h
 F098  75 6A					jne     short notready
 F09A  EB E9					jmp     short DiskGetTypeexit

 F09C				DiskReset:
 F09C				DiskChanged:
 F09C				DiskPark:
 F09C  B4 00					mov     ah, 0       ; success
 F09E  C3					ret

 F09F				DiskGetStatus:
 F09F  8A 26 0074				mov     ah, HDLastError
 F0A3  C3					ret
					  
 F0A4				DiskVerify:
 F0A4  BD F857 R				mov     bp, sdverify
 F0A7  EB 08					jmp     short   DiskRead1
 F0A9				DiskWrite:
 F0A9  BD F8D7 R				mov     bp, sdwrite
 F0AC  EB 03					jmp     short   DiskRead1
 F0AE				DiskRead:
 F0AE  BD F85C R				mov     bp, sdread
 F0B1				DiskRead1:        
 F0B1  84 C0					test    al, al
 F0B3  74 E7					jz      short DiskReset
 F0B5  80 FA 80					cmp     dl, 80h
 F0B8  75 4A					jne     short notready
 F0BA  B4 04					mov     ah, 4
 F0BC  F6 C1 3F					test    cl, 3fh
 F0BF  74 18					jz      short DiskReadend   ; bad sector 0
 F0C1  60					pusha
 F0C2  B4 00					mov     ah, 0
 F0C4  50					push    ax
 F0C5  E8 0012					call    HCStoLBA
 F0C8  59					pop     cx
 F0C9  51					push    cx        
 F0CA  FF D5					call    bp              ; DX:AX sector, ES:BX buffer, CX=sectors, returns AX=read sectors
 F0CC  59					pop     cx
 F0CD  2B C8					sub     cx, ax
 F0CF  F7 D9					neg     cx              ; CF=1 if cx != 0
 F0D1  C0 D4 03					rcl     ah, 3           ; AH = 4*CF (sector not found / read error)
 F0D4  8E D8					mov     ds, ax
 F0D6  61					popa
 F0D7  8C D8					mov     ax, ds
 F0D9				DiskReadend:
 F0D9  C3					ret

 F0DA				HCStoLBA:       ; CX = {cyl[7:0], cyl[9:8], sect[5:0]}, DH = head. Returns DX:AX LBA
 F0DA  8A C5					mov     al, ch
 F0DC  8A E1					mov     ah, cl
 F0DE  C0 EC 06					shr     ah, 6
 F0E1  C1 EA 08					shr     dx, 8
 F0E4  6B D2 3F					imul    dx, 63
 F0E7  83 E1 3F					and     cx, 3fh
 F0EA  03 CA					add     cx, dx
 F0EC  49					dec     cx
 F0ED  BA 3EC1					mov     dx, 255*63
 F0F0  F7 E2					mul     dx
 F0F2  03 C1					add     ax, cx
 F0F4  83 D2 00					adc     dx, 0
 F0F7  C3					ret       
				;    unsigned int s = cs & 0x3f;
				;    unsigned int c = ((cs & 0xc0) << 2) | (cs >> 8);
				;    return (c*255l + h)*63l + s - 1l;

 F0F8				DiskFormat:
 F0F8				DiskInit:
 F0F8				DiskSeek:
 F0F8				DiskRst:
 F0F8				DiskReady:
 F0F8				DiskRecalibrate:
 F0F8				DiskDiag:
 F0F8				DiskExtSeek:
 F0F8  83 3E 0094 00				cmp     word ptr HDSize, 0
 F0FD  74 05					je      short notready
 F0FF  80 FA 80					cmp     dl, 80h
 F102  74 98					je      short DiskReset
 F104				notready:        
 F104  B4 AA					mov     ah, 0aah        ; disk not ready
 F106  C3					ret

 F107				DiskGetParams:
 F107  80 FA 80					cmp     dl, 80h
 F10A  B4 07					mov     ah, 7
 F10C  75 CB					jne     short DiskReadend   ; ret
 F10E  B3 00					mov     bl, 0   ; ???
 F110  A1 0094					mov     ax, HDSize
 F113  8B D0					mov     dx, ax
 F115  C1 E0 0A					shl     ax, 10
 F118  C1 EA 06					shr     dx, 6
 F11B  83 E8 1E					sub     ax, 30
 F11E  83 DA 00					sbb     dx, 0
 F121  B9 3EC1					mov     cx, 63*255
 F124  F7 F1					div     cx
 F126  48					dec     ax
 F127  3D 03FE					cmp     ax, 3feh
 F12A  76 03					jbe     dgpok
 F12C  B8 03FE					mov     ax, 3feh
 F12F				dgpok:        
 F12F  86 C4					xchg    al, ah
 F131  C0 E0 06					shl     al, 6
 F134  0C 3F					or      al, 3fh
 F136  8B C8					mov     cx, ax
 F138  BA FE01					mov     dx, 0fe01h
 F13B  33 C0					xor     ax, ax
 F13D  C3					ret        

 F13E				DiskExtVerify:
 F13E  BD F857 R				mov     bp, sdverify
 F141  EB 08					jmp     short DiskExtRead1
 F143				DiskExtWrite:
 F143  BD F8D7 R				mov     bp, sdwrite
 F146  EB 03					jmp     short DiskExtRead1
 F148				DiskExtRead:
 F148  BD F85C R				mov     bp, sdread
 F14B				DiskExtRead1:
 F14B  80 FA 80					cmp     dl, 80h
 F14E  75 B4					jne     short notready
 F150  06					push    es
 F151  50					push    ax
 F152  60					pusha
 F153  8B DC					mov     bx, sp
 F155  36: 8E 5F 1A				mov     ds, ss:[bx+26]
 F159  8B 4C 02					mov     cx, [si+2]
 F15C  C4 5C 04					les     bx, [si+4]
 F15F  8B 44 08					mov     ax, [si+8]
 F162  8B 54 0A					mov     dx, [si+10]
 F165  1E					push    ds
 F166  56					push    si
 F167  FF D5					call    bp
 F169  5E					pop     si
 F16A  1F					pop     ds
 F16B  2B 44 02					sub     ax, [si+2]
 F16E  01 44 02					add     [si+2], ax
 F171  61					popa
 F172  58					pop     ax
 F173  1A E4					sbb     ah, ah
 F175  80 E4 04					and     ah, 4
 F178  07					pop     es
 F179  C3					ret

 F17A				DiskExtGetParams:
 F17A  80 FA 80					cmp     dl, 80h
 F17D  75 85					jne     short notready
 F17F  50					push    ax
 F180  A1 0094					mov     ax, HDSize   
 F183  8B EC					mov     bp, sp
 F185  8E 5E 08					mov     ds, [bp+8]
 F188  33 ED					xor     bp, bp
 F18A  C7 04 001A				mov     word ptr [si], 1ah      ; size
 F18E  C7 44 02 000B				mov     word ptr [si+2], 0bh    ; flags
 F193  C7 44 04 03FF				mov     word ptr [si+4], 1023   ; cylinders
 F198  89 6C 06					mov     word ptr [si+6], bp
 F19B  C7 44 08 00FF				mov     word ptr [si+8], 255    ; heads
 F1A0  89 6C 0A					mov     word ptr [si+10], bp
 F1A3  C7 44 0C 003F				mov     word ptr [si+12], 63     ; sectors/track
 F1A8  89 6C 0E					mov     word ptr [si+14], bp
 F1AB  89 44 10					mov     word ptr [si+16], ax
 F1AE  C1 64 10 0A				shl     word ptr [si+16], 10
 F1B2  C1 E8 06					shr     ax, 6
 F1B5  89 44 12					mov     word ptr [si+18], ax
 F1B8  89 6C 14					mov     word ptr [si+20], bp
 F1BB  89 6C 16					mov     word ptr [si+22], bp
 F1BE  C7 44 18 0200				mov     word ptr [si+24], 512   ; bytes/sector
 F1C3  58					pop     ax
 F1C4  B4 00					mov     ah, 0
 F1C6  C3					ret 

 F1C7				DiskReadSectBuffer:
 F1C7				DiskWriteSectBuffer:
 F1C7				DiskSetDASDType:
 F1C7				DiskSetMediaType:
 F1C7				DiskExtLock:
 F1C7				DiskExtEject:
 F1C7  B4 01					mov     ah, 1       ; unsupported fn
 F1C9  C3					ret

 F1CA				int13   endp


				OFFDX MACRO n
					IF n LE -3 OR n GE 3
						add		dx, n
					ENDIF
					IF n EQ -2
						dec		dx
					ENDIF 
					IF n EQ -1 or n EQ -2
						dec		dx
					ENDIF
					IF n EQ 1 or n EQ 2
						inc		dx
					ENDIF 
					IF n eq 2
						inc		dx
					ENDIF
				ENDM
				; --------------------- INT 14h - Serial port I/O ----------------
 = 0000				ComPort		equ		0
 = 0000				THR			equ		0	; Transmit holding buffer
 = 0000				RBR			equ		0	; Receive buffer
 = 0000				DLL			equ		0	; divisor latch low byte (DLAB = 1)
 = 0001				DLH			equ		1	; divisor latch high byte	(DLAB = 1)
 = 0001				IER			equ		1	; Interrupt enable register
 = 0003				LCR			equ		3	; line control register (DLAB, BrkEnable, PPP, S, LL)
 = 0005				LSR			equ		5	; line status register
 = 0006				MSR			equ		6	; Modem status register

				; AH=function number, AL=char sent or received, DX=zero based COM index. Preserve all registers except AX
 F1CA				int14 proc near
 F1CA  1E					push	ds
 F1CB  52					push	dx
 F1CC  56					push	si
 F1CD  6A 40					push	40h
 F1CF  1F					pop		ds
 F1D0  8B F2					mov		si, dx
 F1D2  03 F6					add		si, si
 F1D4  8B 14					mov		dx, ComPort[si]
						OFFDX	LCR
 F1D6  83 C2 03		     1			add		dx, LCR
 F1D9  8B F0					mov		si, ax
 F1DB  EC					in		al, dx
 F1DC  24 7F					and		al, 7fh		; clear DLAB bit
 F1DE  EE					out		dx, al
						OFFDX	LSR-LCR
 F1DF  42		     1			inc		dx
 F1E0  42		     1			inc		dx
 F1E1  8B C6					mov		ax, si
 F1E3  C1 EE 08					shr		si, 8
 F1E6  74 0D					jz		short SetCharFormat
 F1E8  4E					dec		si
 F1E9  74 43					jz		short STransmit
 F1EB  4E					dec		si
 F1EC  74 51					jz		short SReceive
 F1EE  4E					dec		si
 F1EF  74 33					jz		short GetPortStatus
				;		dec		si
				;		jz		short SetCharFormatExt
 F1F1				SExit:
 F1F1  5E					pop		si
 F1F2  5A					pop		dx
 F1F3  1F					pop		ds
 F1F4  CF					iret

				; ----- Set COM char format --------
				; AL = BBBPPSLL (BB=000..111 for baud 110,150,300,600,1200,2400,4800,9600)
				; returns LSR in AH and MSR in AL
 F1F5				SetCharFormat:		; DX = LSR
 F1F5  52					push	dx
 F1F6  51					push	cx
 F1F7  8A C8					mov		cl, al
 F1F9  8A E8					mov		ch, al
						OFFDX	LCR-LSR
 F1FB  4A		     1			dec		dx
 F1FC  4A		     1			dec		dx
 F1FD  EC					in		al, dx
 F1FE  0C 80					or		al, 80h		; set DLAB=1
 F200  EE					out		dx, al
 F201  C0 E9 05					shr		cl, 5
 F204  B8 0417					mov		ax, 417h
 F207  74 05					jz		short Baud110
 F209  B8 0300					mov		ax, 300h
 F20C  D3 E8					shr		ax, cl
 F20E				Baud110:
						OFFDX	DLL-LCR
 F20E  83 C2 FD		     1			add		dx, DLL-LCR
 F211  EE					out		dx, al		; set baud low
						OFFDX	DLH-DLL
 F212  42		     1			inc		dx
 F213  8A C4					mov		al, ah
 F215  EE					out		dx, al		; set baud high
						OFFDX	LCR-DLH
 F216  42		     1			inc		dx
 F217  42		     1			inc		dx
 F218  8A C5					mov		al, ch
 F21A  24 1F					and		al, 1fh
 F21C  EE					out		dx, al		; set format, DLAB=0

						OFFDX	IER-LCR
 F21D  4A		     1			dec		dx
 F21E  4A		     1			dec		dx
 F21F  32 C0					xor		al, al
 F221  EE					out		dx, al		; disable all interrupts
 F222  59					pop		cx
 F223  5A					pop		dx

				; ----- get COM port status --------
 F224				GetPortStatus:			; DX = LSR
						OFFDX	MSR-LSR
 F224  42		     1			inc		dx
 F225  EC					in		al, dx		; read modem status
						OFFDX	LSR-MSR
 F226  4A		     1			dec		dx
 F227				GetPortStatus1:
 F227  8A E0					mov		ah, al
 F229  EC					in		al, dx		; read line (port) status
 F22A  86 E0					xchg	ah, al
 F22C  EB C3					jmp		short SExit
						
				; ----- Transmit char to COM port --------
				; Waits for THRE(bit5 in LSR) and then sends AL. returns LSR in AH
 F22E				STransmit:			; DX = LSR
 F22E  52					push	dx
 F22F  8A E0					mov		ah, al
 F231				STr1:
 F231  EC					in		al, dx
 F232  A8 20					test	al, 20h
 F234  74 FB					jz		short STr1
						OFFDX	THR-LSR
 F236  83 C2 FB		     1			add		dx, THR-LSR
 F239  8A C4					mov		al, ah
 F23B  EE					out		dx, al
 F23C				STr2:
 F23C  5A					pop		dx
 F23D  EB E8					jmp		short GetPortStatus1

				; ----- receive char from COM port --------
				; Waits for RDA(bit0 in  LSR) and returns the received char in AL, and the LSR in AH
 F23F				SReceive:			; DX = LSR
 F23F  52					push	dx
 F240				SReceive1:
 F240  EC					in		al, dx
 F241  A8 01					test	al, 1
 F243  74 FB					jz		short SReceive1
						OFFDX	RBR-LSR
 F245  83 C2 FB		     1			add		dx, RBR-LSR
 F248  EC					in		al, dx
 F249  EB F1					jmp		short Str2


				; ----- Set COM char format extended --------
				;SetCharFormatExt:
 F24B				int14 endp

				; --------------------- INT 15h - Extended services ----------------
 = ds:[98h]			UFPtr           equ     <ds:[98h]>
 = ds:[9ch]			WaitCount       equ     <ds:[9ch]>
 = ds:[0a0h]			UWaitFlag       equ     <ds:[0a0h]>
 = ds:[0a1h]			HandlerPtr      equ     <ds:[0a1h]> ; 4 bytes
 = ds:[0a5h]			DataBuffer      equ     <ds:[0a5h]> ; 3 bytes
 = ds:[067h]			DataCounter     equ     <ds:[067h]> ; 1 byte
 = ds:[068h]			PacketSize      equ     <ds:[068h]> ; 1 byte, 0->3bytes, 1->4bytes
 = 7B60				FreeXMSKb       equ     RAMSize*64 - 640 - 512 - 32	;total - DOS - VGA - BIOS

				; ------------ MovExt
 F24B				IncSeg: ; DX = segment port address
 F24B  75 25					jnz     short SetSegExit
 F24D  ED					in      ax, dx
 F24E  25 01FF					and     ax, RAMSize - 1
 F251  40					inc     ax
 F252  83 F8 12					cmp     ax, 12h
 F255  75 02					jne     short IncSeg1
 F257  33 C0					xor     ax, ax
 F259				IncSeg1:
 F259  83 F8 0C					cmp     ax, 0ch
 F25C  75 0B					jne     short SetSeg2
 F25E				SetSeg: ; DX = segment port address, ax = logical segment (0..RAMSize-1)    
 F25E  25 01FF					and     ax, RAMSize - 1
 F261  83 F8 0C					cmp     ax, 0ch
 F264  72 0B					jb      short SetSeg1
 F266  83 C0 06					add     ax, 6
 F269				SetSeg2:        
 F269  3D 0200					cmp     ax, RAMSize
 F26C  72 03					jb      short SetSeg1
 F26E  2D 01F4					sub     ax, RAMSize - 0ch
 F271				SetSeg1:
 F271  EF					out     dx, ax          
 F272				SetSegExit:              
 F272  C3					ret

 = 0001				MovSeg  equ     01h
 F273 0000			savess  dw      0
 F275 F279 R 0000		savesp  dw      MovExt, 0 ; tmp stack
				; Log(idx) to Phy(val) segment map (RAMSize segs): 0,1,2,3,4,5,6,7,8,9,a,b,12h,13h,...,RAMSize-2,RAMSize-1,c,d,e,f,10h,11h, then wrap to 0,1,2,...
 F279				MovExt:
 F279  06					push    es
 F27A  1E					push    ds
 F27B  60					pusha
 F27C  FA					cli
 F27D  2E: 8C 16 F273 R				mov     cs:savess, ss
 F282  0E					push    cs
 F283  17					pop     ss
 F284  2E: 87 26 F275 R				xchg    sp, cs:savesp
 F289  BA 0082					mov     dx, 80h + MovSeg + 1
 F28C  E3 6C					jcxz    short MovExt_exit
 F28E  06					push    es
 F28F  1F					pop     ds
 F290  FC					cld
 F291  8A 44 1C					mov     al, [si+1ch]
 F294  8A 64 1F					mov     ah, [si+1fh]
 F297  8A 5C 14					mov     bl, [si+14h]
 F29A  8A 7C 17					mov     bh, [si+17h]
 F29D  8B 7C 1A					mov     di, [si+1ah]
 F2A0  8B 74 12					mov     si, [si+12h]
 F2A3  E8 FFB8					call    SetSeg      ; 02000h = destination, DX=82h
 F2A6  4A					dec     dx
 F2A7  93					xchg    ax, bx
 F2A8  E8 FFB3					call    SetSeg      ; 01000h = source, DX=81h
 F2AB  68 1000					push    MovSeg shl 12 
 F2AE  1F					pop     ds
 F2AF  68 2000					push    (MovSeg + 1) shl 12
 F2B2  07					pop     es
 F2B3  33 DB					xor     bx, bx
 F2B5  03 C9					add     cx, cx
 F2B7  13 DB					adc     bx, bx      ; BX:CX = bytes to transfer
				; move from 01000h:si to 02000h:di, 2*cx bytes
 F2B9				MovExtLoop:
 F2B9  42					inc     dx          ; 82h
 F2BA  8B C6					mov     ax, si
 F2BC  3B C7					cmp     ax, di
 F2BE  77 02					ja      short MovExt1
 F2C0  8B C7					mov     ax, di
 F2C2				MovExt1:
 F2C2  F7 D8					neg     ax
 F2C4  83 D3 FF					adc     bx, -1
 F2C7  2B C8					sub     cx, ax
 F2C9  83 DB 00					sbb     bx, 0
 F2CC  91					xchg    ax, cx      ; cx = bytes to move, bx:ax = bytes left for the next transfer
 F2CD  79 05					jns     short MovExt2   ; ax <= bx:cx     
 F2CF  03 C8					add     cx, ax
 F2D1  33 C0					xor     ax, ax
 F2D3  43					inc     bx
 F2D4				MovExt2:
 F2D4  A4					movsb               ; if CX = 0 transfer 10000h bytes
 F2D5  49					dec     cx
 F2D6  74 0F					jz      short MovExt_next
 F2D8  F7 C6 0001				test    si, 1       ; read align
 F2DC  74 02					jz      short raligned
 F2DE  A4					movsb
 F2DF  49					dec     cx
 F2E0				raligned:
 F2E0  D1 E9					shr     cx, 1
 F2E2  F3/ A5					rep     movsw
 F2E4  73 01					jnc     short MovExt_next
 F2E6  A4					movsb
 F2E7				MovExt_next:
 F2E7  8B C8					mov     cx, ax
 F2E9  0B C3					or      ax, bx
 F2EB  74 0D					jz      short MovExt_exit  ; finalized
 F2ED  85 FF					test    di, di
 F2EF  E8 FF59					call    incseg      ; does nothing if ZF == 0, dx = 8bh
 F2F2  4A					dec     dx          ; 81h
 F2F3  85 F6					test    si, si      
 F2F5  E8 FF53					call    incseg      ; dx = 81h
 F2F8  EB BF					jmp     short MovExtLoop
 F2FA				MovExt_exit:
 F2FA  B8 0002					mov     ax, MovSeg + 1
 F2FD  EF					out     dx, ax      ; 82h
 F2FE  48					dec     ax
 F2FF  4A					dec     dx
 F300  EF					out     dx, ax      ; 81h
 F301  2E: 8E 16 F273 R				mov     ss, cs:savess
 F306  2E: 87 26 F275 R				xchg    sp, cs:savesp
 F30B  61					popa
 F30C  1F					pop     ds
 F30D  07					pop     es
 F30E  32 E4					xor     ah, ah
 F310  EB 38					jmp     short exit_ax
 F312				MovExtProxy:
 F312  E9 FF64					jmp     MovExt        

 F315				int15:
 F315  80 FC 4F					cmp     ah, 4fh
 F318  74 34					je      short exit_iret
 F31A  86 C4					xchg    al, ah
 F31C  3C 80					cmp     al, 80h
 F31E  72 27					jb      short exit15; CF=1  for <80h
 F320  3C 83					cmp     al, 83h
 F322  72 22					jb      short done  ; no error for 80, 81, 82
 F324  74 29					je      short SetEventWait; 83
 F326  3C 86					cmp     al, 86h
 F328  72 1D					jb      short exit15; CF=1 for 84, 85
 F32A  74 58					je      short Wait1 ; 86
 F32C  3C 88					cmp     al, 88h
 F32E  72 E2					jb      short MovExtProxy ; 87
 F330  74 6B					je      short ExtSize     ; 88
 F332  3C 90					cmp     al, 90h
 F334  72 11					jb      short  exit15; CF=1 for 89..8f
 F336  3C 92					cmp     al, 92h
 F338  72 0C					jb      short done  ; no error for 90, 91
 F33A  3C C0					cmp     al, 0c0h
 F33C  72 09					jb      short exit15; CF=1 for 92..bf
 F33E  74 62					je      short GetConfig   ; c0
 F340  3C C2					cmp     al, 0c2h
 F342  72 03					jb      short exit15; CF=1 for c1
 F344  74 65					je      short Mouse ; c2
 F346				done:
 F346  F5					cmc                 ; CF=1 for >c2
 F347				exit15:
 F347  B8 8600					mov     ax, 8600h
 F34A				exit_ax:        
 F34A  FB					sti
 F34B  CA 0002					retf    2           ; discard flags (need to keep CF)
 F34E				exit_iret:
 F34E  CF					iret        

				; ------------ SetEventWait
 F34F				SetEventWait:
 F34F  1E					push    ds
 F350  6A 40					push    40h
 F352  1F					pop     ds
 F353  80 F4 01					xor     ah, 1
 F356  74 21					jz      short cancel
 F358  84 26 00A0				test    ah, byte ptr UWaitFlag ; ah=1
 F35C  75 22					jnz     short busy  ; CF=0
 F35E  B8 03E7					mov     ax, 1000-1  ; 1ms
 F361  E7 70					out     70h, ax     ; restart RTC timer
 F363  89 1E 0098				mov     UFPtr[0], bx
 F367  8C 06 009A				mov     UFPtr[2], es
 F36B  03 C2					add     ax, dx
 F36D  83 D1 00					adc     cx, 0
 F370  A3 009C					mov     WaitCount[0], ax
 F373  89 0E 009E				mov     WaitCount[2], cx
 F377  B4 01					mov     ah, 1       ; wait in progress
 F379				cancel:
 F379  88 26 00A0				mov     byte ptr UWaitFlag, ah   
 F37D  CD 70					int     70h
 F37F  F9					stc                 ; no error
 F380				busy:   
 F380  F5					cmc                 ; eror        
 F381				nowait:
 F381  1F					pop     ds
 F382  EB C3					jmp     short exit15

				; ------------ Wait
 F384				Wait1:
 F384  06					push    es
 F385  53					push    bx
 F386  B8 8300					mov     ax, 8300h
 F389  6A 4A					push    4ah
 F38B  07					pop     es
 F38C  33 DB					xor     bx, bx      ; user wait flag address=0040:00a0
 F38E  CD 15					int     15h         ; returns with IF = 1
 F390  72 07					jc      short wbusy
 F392				wloop:        
 F392  F4					hlt   
 F393  26: F6 07 80				test    byte ptr es:[bx], 80h
 F397  74 F9					jz      short wloop
 F399				wbusy:        
 F399  5B					pop     bx
 F39A  07					pop     es
 F39B  EB AA					jmp     short exit15
						

				; ------------ ExtSize
 F39D				ExtSize:
 F39D  B8 7B60					mov     ax, FreeXMSKb
 F3A0  EB A8					jmp     short exit_ax
						
				; ------------ GetConfig
 F3A2				GetConfig:
 F3A2  33 C0					xor     ax, ax
 F3A4  0E					push    cs
 F3A5  07					pop     es
 F3A6  BB F4C5 R				mov     bx, offset SysParams
 F3A9  EB 9F					jmp     short exit_ax
						
				; ------------ Mouse 
 F3AB				Mouse:
 F3AB  1E					push    ds
 F3AC  52					push    dx
 F3AD  6A 40					push    40h
 F3AF  1F					pop     ds
 F3B0  F6 06 0010 04				test    byte ptr EquipmentWord, 4 ; ps2 mouse equipement word
 F3B5  75 15					jnz     short mouse_present
 F3B7				if_err:
 F3B7  B8 03A7					mov     ax, 03a7h   ; interface error (no mouse present)
 F3BA  E6 64					out     64h, al     ; disable mouse
 F3BC				errexit:        
 F3BC  F9					stc                 ; error
 F3BD				exitok:        
 F3BD  9C					pushf               ; save CF
 F3BE  50					push    ax
 F3BF  E8 00D6					call    enablemouseinterrupt
 F3C2  58					pop     ax

 F3C3  E8 03B9					call    enableKbIfPresent
 F3C6  9D					popf
 F3C7  5A					pop     dx
 F3C8  1F					pop     ds
 F3C9  E9 FF7E					jmp     exit_ax
 F3CC				mouse_present:
 F3CC  8A C4					mov     al, ah                                  
 F3CE  B4 01					mov     ah, 1       ; invalid function
 F3D0  3C 07					cmp     al, 7
 F3D2  77 E8					ja      short errexit
 F3D4  50					push    ax

 F3D5  E8 00D3					call    disablemouseinterrupt

 F3D8  FB					sti                 ; allow interrupts for a short time, to flush possible pending KB/mouse requests
 F3D9  B0 AD					mov     al, 0adh
 F3DB  E6 64					out     64h, al     ; disable kb interface
 F3DD  58					pop     ax
 F3DE  3C 01					cmp     al, 1
 F3E0  FA					cli                 ; from now on we are working with ints disabled, as the following code is highly non re-entrant
 F3E1  72 1C					jb      short en_dis
 F3E3  74 33					je      short reset
 F3E5  3C 03					cmp     al, 3
 F3E7  72 40					jb      short sampling
 F3E9  74 5D					je      short resolution
 F3EB  3C 05					cmp     al, 5
 F3ED  72 63					jb      short gettype
 F3EF  74 27					je      short reset
 F3F1  3C 06					cmp     al, 6
 F3F3  74 75					je      short extend

				; ------------- set handler
 F3F5  89 1E 00A1				mov     HandlerPtr[0], bx
 F3F9  8C 06 00A3				mov     HandlerPtr[2], es
 F3FD  EB 15					jmp     short exit_success1        

				; ------------- enable/disable
 F3FF				en_dis:
 F3FF  B8 02F5					mov     ax, 02f5h   ; ah = invalid input
 F402  2A C7					sub     al, bh
 F404  38 E7					cmp     bh, ah
 F406  73 B4					jnc     short errexit
 F408  8A E0					mov     ah, al
 F40A  E8 0361					call    sendcmd     ; enable/disable data reporting (CF = 1)
 F40D				if_err1:        
 F40D  72 A8					jc      short if_err
 F40F				exit_success:
 F40F  C6 06 0067 00				mov     byte ptr DataCounter, 0
 F414				exit_success1:
 F414  32 E4					xor     ah, ah      ; success
 F416  EB A5					jmp     short exitok

				; ------------- reset
 F418				reset:
 F418  B4 F6					mov     ah, 0f6h    ; set defaults
 F41A  F9					stc                 ; mouse command
 F41B  E8 0350					call    sendcmd     
 F41E  72 97					jc      short if_err
 F420  BB 00AA					mov     bx, 00aah
 F423  88 3E 0068				mov     byte ptr PacketSize, bh ; 3bytes packet
 F427  EB E6					jmp     short exit_success

				; ------------- sampling
 F429				sampling:
 F429  80 FF 06					cmp     bh, 6
 F42C				badparam:
 F42C  B4 02					mov     ah, 2       ; invalid input
 F42E  77 8C					ja      short errexit
 F430  C1 EB 08					shr     bx, 8
 F433  2E: 8A A7 F4BE R				mov     ah, cs:sample_tbl[bx]
 F438  50					push    ax
 F439  B4 F3					mov     ah, 0f3h    ; st sample rate
 F43B				send2c:
 F43B  F9					stc
 F43C  E8 032F					call    sendcmd              
 F43F  58					pop     ax
 F440  72 CB					jc      short if_err1
 F442				send1c:
 F442  F9					stc
 F443  E8 0328					call    sendcmd
 F446  EB C5					jmp     short if_err1

				; ------------- resolution
 F448				resolution:
 F448  80 FF 03					cmp     bh, 3
 F44B  77 DF					ja      short badparam
 F44D  53					push    bx
 F44E  B4 E8					mov     ah, 0e8h    ; set resolution
 F450  EB E9					jmp     short send2c

				; ------------- gettype
 F452				gettype:
 F452  B4 F2					mov     ah, 0f2h
 F454  F9					stc
 F455  E8 0316					call    sendcmd
 F458  72 B3					jc      short if_err1
 F45A  E8 02F7					call    getps2byte
 F45D  72 AE					jc      short if_err1
 F45F  8A F8					mov     bh, al
 F461  F6 D8					neg     al          ; CF=1 if al != 0
 F463  12 C7					adc     al, bh
 F465  A2 0068					mov     byte ptr PacketSize, al ; 3 or 4 bytes packet
 F468  EB A5					jmp     short exit_success
						
				; ------------- extended commands
 F46A				extend:
 F46A  84 FF					test    bh, bh
 F46C  75 1F					jnz     short setscaling
 F46E  B4 E9					mov     ah, 0e9h    ; status request
 F470  F9					stc
 F471  E8 02FA					call    sendcmd
 F474  72 97					jc      short if_err1
 F476  E8 02DB					call    getps2byte
 F479  72 92					jc      short if_err1
 F47B  8A D8					mov     bl, al
 F47D  E8 02D4					call    getps2byte
 F480  72 8B					jc      short if_err1
 F482  8A C8					mov     cl, al
 F484  E8 02CD					call    getps2byte
 F487  72 84					jc      short if_err1
 F489  5A					pop     dx  
 F48A  50					push    ax          ; replace dx on stack
 F48B  EB 82					jmp     short exit_success
 F48D				setscaling:    
 F48D  80 FF 02					cmp     bh, 2
 F490  77 9A					ja      short badparam
 F492  B4 E5					mov     ah, 0e5h    ; set scaling 1:1 or 2:1
 F494  02 E7					add     ah, bh
 F496  EB AA					jmp     short send1c

 F498				enablemouseinterrupt:
 F498  B0 20					mov     al, 20h
 F49A  E6 64					out     064h, al
 F49C  E4 60					in      al, 060h    ; read 8042 config byte
 F49E  0C 02					or      al, 02h     ; set enable mouse interrupt
 F4A0  8A E0					mov     ah, al
 F4A2  B0 60					mov     al, 60h
 F4A4  E6 64					out     064h, al
 F4A6  8A C4					mov     al, ah
 F4A8  E6 60					out     060h, al    ; send 8042 config byte
 F4AA  C3					ret
 F4AB				disablemouseinterrupt:
 F4AB  B0 20					mov     al, 20h
 F4AD  E6 64					out     064h, al
 F4AF  E4 60					in      al, 060h    ; read 8042 config byte
 F4B1  24 FD					and     al, 0fdh     ; set disable mouse interrupt
 F4B3  8A E0					mov     ah, al
 F4B5  B0 60					mov     al, 60h
 F4B7  E6 64					out     064h, al
 F4B9  8A C4					mov     al, ah
 F4BB  E6 60					out     060h, al    ; send 8042 config byte
 F4BD  C3					ret

 F4BE 0A 14 28 3C 50 64		sample_tbl  db  10, 20, 40, 60, 80, 100, 200
       C8
 F4C5 08 00 FC 00 00		SysParams   db  8, 0, 0fch, 0, 0
				;--------------------------------------------------------------------------
				; Feature byte 1
				; b7: 1=DMA channel 3 used by hard disk
				; b6: 1=2 interrupt controllers present
				; b5: 1=RTC present
				; b4: 1=BIOS calls int 15h/4Fh every key
				; b3: 1=wait for extern event supported (Int 15h/41h)
				; b2: 1=extended BIOS data area used
				; b1: 0=AT or ESDI bus, 1=MicroChannel
				; b0: 1=Dual bus (MicroChannel + ISA)
				;--------------------------------------------------------------------------
 F4CA  10						db      10h
				;--------------------------------------------------------------------------
				; Feature byte 2
				; b7: 1=32-bit DMA supported
				; b6: 1=int16h, function 9 supported
				; b5: 1=int15h/C6h (get POS data) supported
				; b4: 1=int15h/C7h (get mem map info) supported
				; b3: 1=int15h/C8h (en/dis CPU) supported
				; b2: 1=non-8042 kb controller
				; b1: 1=data streaming supported
				; b0: reserved
				;--------------------------------------------------------------------------
 F4CB  44						db      44h
				;--------------------------------------------------------------------------
				; Feature byte 3
				; b7: not used
				; b6: reserved
				; b5: reserved
				; b4: POST supports ROM-to-RAM enable/disable
				; b3: SCSI on system board
				; b2: info panel installed
				; b1: Initial Machine Load (IML) system - BIOS on disk
				; b0: SCSI supported in IML
				;--------------------------------------------------------------------------
 F4CC  00						db      0
				;--------------------------------------------------------------------------
				; Feature byte 4
				; b7: IBM private
				; b6: EEPROM present
				; b5-3: ABIOS presence (011 = not supported)
				; b2: private
				; b1: memory split above 16Mb supported
				; b0: POSTEXT directly supported by POST
				;--------------------------------------------------------------------------
 F4CD  00						db      0
				;--------------------------------------------------------------------------
				; Feature byte 5 (IBM)
				; b1: enhanced mouse
				; b0: flash EPROM
				;--------------------------------------------------------------------------
 F4CE  00						db      0                                                


				; --------------------- INT 16h - keyboard interface ----------------
				;       AH      Description
				;       --      ------------------------------------------------
				;       00h     Get a key from the keyboard, return code in AX.
				;       01h     Test for available key, ZF=1 if none, ZF=0 and
				;               AX contains next key code if key available.
				;       02h     Get shift status. Returns shift key status in AL.
				;       03h     Set Autorepeat rate. BH=0,1,2,3 (delay time in quarter seconds), BL=0..1Fh for 30 char/sec to 2 char/sec repeat rate.
				;       05h     Store scan code (in CX) in the type ahead buffer.
				;       10h     Get a key (same as 00h in this implementation).
				;       11h     Test for key (same as 01h).
				;       12h     Get extended key status. Returns status in AX.

 = ds:[19h]			AltKpd          equ     <ds:[19h]>
 = ds:[1ah]			HeadPtr         equ     <ds:[1ah]>
 = ds:[1ch]			TailPtr         equ     <ds:[1ch]>
 = ds:[80h]			Buffer          equ     <ds:[80h]>;1eh
 = ds:[82h]			EndBuf          equ     <ds:[82h]>;3eh

 F4CF				int16 proc near
 F4CF  1E					push    ds
 F4D0  56					push    si
 F4D1  6A 40					push    40h
 F4D3  1F					pop     ds
 F4D4  86 C4					xchg    al, ah          ;shorter opcodes for al than ah
 F4D6  48					dec     ax
 F4D7  A8 EF					test    al, 0EFh        ;Check for 01h and 11h
 F4D9  74 3E					jz      short TestKey   ;TestKey does not need cld
 F4DB  40					inc     ax
 F4DC  FC					cld
 F4DD  A8 EF					test    al, 0EFh        ;Check for 0h and 10h
 F4DF  74 1C					jz      short GetKey
 F4E1  3C 03					cmp     al, 3           ;Check for 02h and 03h
 F4E3  72 78					jb      short GetStatus
 F4E5  74 7B					je      short SetAutoRpt   
 F4E7  3C 05					cmp     al, 5           ;Check for StoreKey function.
 F4E9  74 3D					je      short StoreKey
 F4EB  3C 09					cmp     al, 9           ;Get KB functionality
 F4ED  74 08					je      short kbfunc     
 F4EF  3C 12					cmp     al, 12h         ;Extended status call
 F4F1  74 56					je      short ExtStatus
 F4F3  3C 92					cmp     al, 92h         ;stupid keyb.com 
 F4F5  75 02					jne     short Exit
 F4F7				kbfunc:
 F4F7  B0 24					mov     al, 24h         ;AL=20h (fn 10h, 12h supported, set typematic supported)        
 F4F9				Exit:        
 F4F9  5E					pop     si
 F4FA  1F					pop     ds
 F4FB  CF					iret                    ; unknown function, Restores flags.

 F4FC				GetKey1:                        ; wait for interrupt
 F4FC  F4					hlt
 F4FD				GetKey: ; ----------- fn 00h, 10h
 F4FD  B4 11					mov     ah, 11h
 F4FF  CD 16					int     16h             ;See if key is available (IF becomes 1 after this int)
 F501  74 F9					jz      short GetKey1   ;Wait for keystroke.
 F503  FA					cli                     ;Critical region! Ints off.
 F504  8B 36 001A				mov     si, HeadPtr     ;Ptr to next character.
 F508  AD					lodsw                   ;Get the character, Bump up HeadPtr
 F509  3B 36 0082				cmp     si, EndBuf
 F50D  72 04					jb      short noWrap
 F50F  8B 36 0080				mov     si, Buffer
 F513				noWrap:             
 F513  89 36 001A				mov     HeadPtr, si
 F517  EB E0					jmp     short Exit

 F519				TestKey: ; ---------- fn 01h
 F519  8B 36 001A				mov     si, HeadPtr
 F51D  3B 36 001C				cmp     si, TailPtr     ;ZF=1, if empty buffer
 F521  AD					lodsw                   ;BIOS returns avail keycode.
 F522  FB					sti                     ;Ints back on.
 F523  5E					pop     si
 F524  1F					pop     ds
 F525  CA 0002					retf    2               ;Pop flags (ZF is important!)

 F528				StoreKey: ; ---------- fn 05h - Inserts the value in CX into the type ahead buffer.  
 F528  8B 36 001C				mov     si, TailPtr     ;Address where we can put next key code.
 F52C  89 0C					mov     [si], cx        ;Store the key code away
 F52E  46					inc     si
 F52F  46					inc     si              ;Move on to next entry in buf
 F530  3B 36 0082				cmp     si, EndBuf
 F534  72 04					jb      short NoWrap1
 F536  8B 36 0080				mov     si, Buffer
 F53A				 NoWrap1:
 F53A  B0 01					mov     al, 1           ;no room
 F53C  3B 36 001A				cmp     si, HeadPtr     ;Data overrun?
 F540  74 B7					je      short Exit      ;if so, ignore key entry.
 F542  89 36 001C				mov     TailPtr, si
 F546  48					dec     ax              ;al=0
 F547  EB B0					jmp     short Exit       

 F549				ExtStatus: ; ------- fn 12h - Retrieve the extended keyboard status and return it in AH, and the standard keyboard status in AL.    
 F549  A0 0018					mov     al, KbdFlags2
 F54C  24 77					and     al, 01110111b   ;Clear final sysreq field, and final right alt bit.
 F54E  A8 04					test    al, 100b        ;Test cur sysreq bit.
 F550  74 02					jz      short NoSysReq  ;Skip if it's zero.
 F552  2C 84					sub     al, 10000100b   ;Set final sysreq bit, clear final right ctl bit.
 F554				NoSysReq:
 F554  8A 26 0096				mov     ah, KbdFlags3
 F558  80 E4 0C					and     ah, 1100b       ;Grab rt alt/ctrl bits.
 F55B  0A E0					or      ah, al          ;Merge into AH.

 F55D				GetStatus: ; --------- fn 02h     
 F55D  A0 0017					mov     al, KbdFlags1   ;Just return Std Status.
 F560				Exit1:
 F560  EB 97					jmp     short Exit

 F562				SetAutoRpt: ; ------ fn 03h
 F562  80 FC 05					cmp     ah, 5
 F565  75 92					jne     short Exit
 F567  52					push    dx
 F568  C0 E7 05					shl     bh, 5
 F56B  80 E3 1F					and     bl, 1fh
 F56E  0A DF					or      bl, bh
 F570  80 E3 7F					and     bl, 7fh
 F573  B4 00					mov     ah, 0           ; wait LED update progress to finalize
 F575  E8 0028					call    WaitFlag        ; leaves with IF=0
 F578  72 23					jc      short timeout
 F57A  80 0E 0097 08				or      byte ptr KbdFlags4, SetRepeat    ; set auto repeat in progress
 F57F  B4 F3					mov     ah, 0f3h        ; set typematic rate and delay
 F581  53					push    bx
 F582  32 DB					xor     bl, bl          ; send to kb
 F584  E8 01A8					call    sendps2byte
 F587  5B					pop     bx
 F588  72 0E					jc      short timeout1  ; send timeout
 F58A  B4 18					mov     ah, SetRepeat or AckReceived ; test if ACK received
 F58C  E8 0011					call    WaitFlag
 F58F  72 07					jc      short timeout1
 F591  8A E3					mov     ah, bl
 F593  32 DB					xor     bl, bl          ; send to kb
 F595  E8 0197					call    sendps2byte     ; send data
 F598				timeout1:
 F598  80 26 0097 F7				and     byte ptr KbdFlags4, not SetRepeat   
 F59D				timeout:
 F59D  5A					pop     dx
 F59E  EB C0					jmp     short Exit1


 F5A0				WaitFlag:   ; ah = desired KbdFlags4 & (AckReceived | LEDUpdate | SetRepeat)
 F5A0  BA 03DA					mov     dx, 3dah
 F5A3  B7 C8					mov     bh, 8*25    ; wait for max 25 * VGA frame time
 F5A5				wf_loop:
 F5A5  FA					cli
 F5A6  A0 0097					mov     al, KbdFlags4
 F5A9  24 58					and     al, AckReceived or LEDUpdate or SetRepeat
 F5AB  38 E0					cmp     al, ah
 F5AD  74 0A					je      short wf_ok ; flag ok, CF=0
 F5AF  FB					sti
 F5B0  EC					in      al, dx      ; get vblank
 F5B1  32 C7					xor     al, bh
 F5B3  24 08					and     al, 8h
 F5B5  2A F8					sub     bh, al
 F5B7  73 EC					jnc     short wf_loop     ; IBF - buffer full, no timeout
 F5B9				wf_ok:
 F5B9  C3					ret
 F5BA				int16 endp

				; --------------------- INT 18h - BIOS Basic ------------------
 F5BA				int18 proc near
 F5BA  0E					push    cs
 F5BB  07					pop     es
 F5BC  BE F5EF R				mov     si, offset booterrmsg
 F5BF  E8 01E3					call    prts

				;-------------- RS232 bootstrap
 F5C2  B0 B4					mov     al, 0b4h
 F5C4  E6 43					out     43h, al
 F5C6  B8 F000					mov     ax, 0f000h
 F5C9  E6 42					out     42h, al
 F5CB  E6 42					out     42h, al      ; 18Hz PIT CH2
 F5CD  E7 01					out		1, ax		; disable auto flush on vblank (bit0)
 F5CF  8E D8					mov		ds,ax
 F5D1  8E C0					mov		es,ax

 F5D3  BE 0100					mov		si,100h
 F5D6  E8 012A					call	srecb
 F5D9  FA					cli
 F5DA  8A FC					mov		bh,ah
 F5DC  E8 0124					call	srecb
 F5DF  8A DC					mov		bl,ah
 F5E1				sloop:	
 F5E1  E8 011F					call	srecb
 F5E4  88 24					mov		[si],ah
 F5E6  46					inc		si
 F5E7  4B					dec		bx
 F5E8  75 F7					jnz		short sloop
 F5EA  EA					db		0eah
 F5EB  0100 F000				dw		100h,0f000h

 F5EF 4E 6F 20 62 6F 6F		booterrmsg db   'No boot device available, waiting on RS232 (115200bps, f000:100) ...', 13, 10, 0
       74 20 64 65 76 69
       63 65 20 61 76 61
       69 6C 61 62 6C 65
       2C 20 77 61 69 74
       69 6E 67 20 6F 6E
       20 52 53 32 33 32
       20 28 31 31 35 32
       30 30 62 70 73 2C
       20 66 30 30 30 3A
       31 30 30 29 20 2E
       2E 2E 0D 0A 00
 F636				int18 endp

				; --------------------- INT 19h - OS Bootstrap loader ------------------
 F636				int19 proc near
 F636  B8 0201					mov     ax, 201h
 F639  B9 0001					mov     cx, 1
 F63C  BA 0080					mov     dx, 80h
 F63F  6A 00					push    0
 F641  07					pop     es
 F642  BB 7C00					mov     bx, 7c00h
 F645  CD 13					int     13h
 F647  72 05					jc      int19err
 F649  EA					db      0eah
 F64A  7C00 0000				dw      7c00h, 0     ; jmp far 0000h:7c00h
 F64E				int19err:
 F64E  CD 18					int     18h
 F650				int19 endp


				; --------------------- INT 1ah - Get System Time ------------------
 F650				int1a proc near
 F650  1E					push    ds
 F651  6A 40					push    40h
 F653  1F					pop     ds
 F654  80 FC 01					cmp     ah, 1
 F657  77 12					ja      clockexit
 F659  74 16					je      setclock
 F65B  8B 16 006C				mov     dx, ds:[6ch]    ; read clock
 F65F  8B 0E 006E				mov     cx, ds:[6eh]
 F663  A0 0070					mov     al, ds:[70h]
 F666				clockexit1:
 F666  C6 06 0070 00				mov     byte ptr ds:[70h], 0
 F66B				clockexit:
 F66B  F5					cmc     ; CF = 1 on error
 F66C  1F					pop     ds
 F66D  FB					sti
 F66E  CA 0002					retf    2

 F671				setclock:
 F671  89 16 006C				mov     ds:[6ch], dx
 F675  89 0E 006E				mov     ds:[6eh], cx
 F679  F9					stc
 F67A  EB EA					jmp     short clockexit1    
 F67C				int1a endp


				; --------------------- INT 70h - RTC ------------------
 F67C				int70 proc near
 F67C  1E					push    ds
 F67D  6A 40					push    40h
 F67F  1F					pop     ds
 F680  F6 06 00A0 01				test    byte ptr UWaitFlag, 1    ; is wait in progress?
 F685  74 1B					jz      short exit1
 F687  81 2E 009C 03E8				sub     word ptr WaitCount[0], 1000
 F68D  83 1E 009E 00				sbb     word ptr WaitCount[2], 0
 F692  73 14					jnc     short exit
 F694  C6 06 00A0 00				mov     byte ptr UWaitFlag, 0
 F699  53					push    bx
 F69A  C5 1E 0098				lds     bx, UFPtr
 F69E  80 0F 80					or      byte ptr [bx], 80h
 F6A1  5B					pop     bx
 F6A2				exit1:
 F6A2  50					push	ax
 F6A3  33 C0					xor		ax, ax
 F6A5  E7 70					out		70h, ax	; stop RTC
 F6A7  58					pop		ax
 F6A8				exit: 
 F6A8  50					push    ax
 F6A9  B0 20					mov     al, 20h
 F6AB  E6 A0					out     0a0h, al
 F6AD  B0 20					mov     al, 20h
 F6AF  E6 20					out     20h, al
 F6B1  58					pop     ax
 F6B2  1F					pop     ds
 F6B3  CF					iret
 F6B4				int70 endp

						
				; --------------------- INT 74h - mouse ------------------
 F6B4				int74 proc near
 F6B4  FC					cld
 F6B5  60					pusha
 F6B6  1E					push    ds
 F6B7  6A 40					push    40h
 F6B9  1F					pop     ds
 F6BA  B4 00					mov     ah, 0
 F6BC  E4 60					in      al, 60h
 F6BE  8B D8					mov     bx, ax
 F6C0  FE 06 0067				inc     byte ptr DataCounter
 F6C4  A0 0067					mov     al, DataCounter
 F6C7  8B F0					mov     si, ax
 F6C9  2C 03					sub     al, 3
 F6CB  77 0C					ja      short docall
 F6CD  88 9C 00A4				mov     DataBuffer[si-1], bl
 F6D1  3A 06 0068				cmp     al, PacketSize
 F6D5  75 21					jne     short nocall
 F6D7  B3 00					mov     bl, 0
 F6D9				docall:
 F6D9  88 3E 0067				mov     byte ptr DataCounter, bh    ; BH=0
 F6DD  BE 00A3					mov     si, offset DataBuffer-2
 F6E0  AD					lodsw
 F6E1  0B 44 FC					or      ax, [si-4]
 F6E4  74 12					jz      short nocall
 F6E6  FB					sti
 F6E7  06					push    es
 F6E8  B4 00					mov     ah, 0
 F6EA  AC					lodsb
 F6EB  50					push    ax
 F6EC  AC					lodsb
 F6ED  50					push    ax
 F6EE  AC					lodsb
 F6EF  50					push    ax
 F6F0  53					push    bx
 F6F1  FF 5C F9					call    far ptr [si-7]
 F6F4  83 C4 08					add     sp, 8
 F6F7  07					pop     es
 F6F8				nocall:        
 F6F8  B0 20					mov     al, 20h
 F6FA  E6 A0					out     0a0h, al
 F6FC  B0 20					mov     al, 20h
 F6FE  E6 20					out     20h, al

 F700  1F					pop     ds
 F701  61					popa
 F702  CF					iret
 F703				int74 endp


				; ----------------  serial receive byte 115200 bps --------------
 F703  B4 80			srecb:  mov     ah, 80h
 F705  BA 03DA					mov     dx, 3dah
 F708  B9 FA52					mov     cx, -5aeh ; (half start bit)
 F70B  EC			srstb:  in      al, dx
 F70C  C0 E8 02					shr     al, 2
 F70F  72 FA					jc      short srstb
 F711  E4 42					in      al, 42h ; lo counter
 F713  02 E8					add     ch, al
 F715  E4 42					in      al, 42h ; hi counter, ignore
 F717				l1:
 F717  E8 0008					call    dlybit
 F71A  EC					in      al, dx
 F71B  C0 E8 02					shr     al, 2
 F71E  D0 DC					rcr     ah, 1
 F720  73 F5					jnc     short l1
 F722				dlybit:
 F722  81 E9 0A5B				sub     cx, 0a5bh  ;  (full bit)
 F726				dly1:
 F726  E4 42					in      al, 42h
 F728  38 E8					cmp     al, ch
 F72A  E4 42					in      al, 42h
 F72C  75 F8					jnz     short dly1
 F72E  C3					ret

				; -------------------- KB/Mouse access ----------------
 F72F				sendps2byte proc near   ; ah=data, bl!=0 for mouse, 0 for kb. returns cf=1 if timeout (al = 8)
				; changes BH, AL
 F72F  52					push    dx
 F730  BA 03DA					mov     dx, 3dah
 F733  B7 28					mov     bh, 8*5
 F735				sps2b2:
 F735  E4 64					in      al, 64h
 F737  A8 02					test    al, 2
 F739  74 0B					jz      short sps2b1; buffer empty
 F73B  EC					in      al, dx      ; get vblank
 F73C  32 C7					xor     al, bh
 F73E  24 08					and     al, 8h
 F740  2A F8					sub     bh, al
 F742  73 F1					jnc     short sps2b2; IBF - buffer full, no timeout
 F744  EB 0C					jmp     short exit  ; timeout, CF=1
 F746				sps2b1:
 F746  84 DB					test    bl, bl      ; CF=0
 F748  74 04					jz      short sps2_kb
 F74A  B0 D4					mov     al, 0d4h    ; next mouse
 F74C  E6 64					out     64h, al
 F74E				sps2_kb:
 F74E  8A C4					mov     al, ah
 F750  E6 60					out     60h, al     ; send byte
 F752				exit:        
 F752  5A					pop     dx
 F753  C3					ret
 F754				sendps2byte endp

 F754				getps2byte proc near    ; returns al=data, zf=0 for mouse, 1 for kb, cf=1 if timeout (al=8)
				; changes BH, DX, AL
 F754  BA 03DA					mov     dx, 3dah
 F757  B7 28					mov     bh, 8*5
 F759				gps2b2:
 F759  E4 64					in      al, 64h
 F75B  A8 01					test    al, 1
 F75D  75 0A					jnz     short gps2b1     ; OBF (buffer full), continue
 F75F  EC					in      al, dx     ; get vblank
 F760  32 C7					xor     al, bh
 F762  24 08					and     al, 8
 F764  2A F8					sub     bh, al
 F766  73 F1					jnc     short gps2b2     ; buffer empty, no timeout
 F768  C3					ret                ; timeout, CF=1
 F769				gps2b1:
 F769  A8 20					test    al, 20h    ; CF=0, ZF <- !MOBF
 F76B  E4 60					in      al, 60h    ; read byte (if IF=1, this data may be invalid)
 F76D  C3					ret
 F76E				getps2byte endp

 F76E				sendcmd proc near     ; ah = command, CF=1 for mouse, CF=0 for kb. returns CF=1 on error
 F76E  1A DB					sbb     bl, bl      ; bl <- CF
 F770  E8 FFBC					call    sendps2byte 
 F773  72 09					jc      short exit
 F775				retry:        
 F775  E8 FFDC					call    getps2byte
 F778  72 04					jc      short exit        
 F77A  3C FA					cmp     al, 0fah    ; ack (returns CF=1 on error, when al=8)
 F77C  75 F7					jne     short retry
 F77E				exit:
 F77E  C3					ret
 F77F				sendcmd endp

 F77F				enableKbIfPresent proc near ; input DS = 40h
				; modify AL, flags
 F77F  F6 06 0096 10				test    byte ptr KbdFlags3, 10h
 F784  74 04					jz      short noenablekb
 F786  B0 AE					mov     al, 0aeh
 F788  E6 64					out     64h, al     ; enable kb interface
 F78A				noenablekb:        
 F78A  C3					ret
 F78B				enableKbIfPresent endp

				; ----------------------- default interrupt handler ---------------
 F78B				defint  proc near
 F78B  CF					iret
 F78C				defint  endp             

				; ------------------------------- misc --------------------------
 F78C				dispAX: 
 F78C  52					push    dx
 F78D  33 D2					xor     dx, dx
 F78F  2E: F7 36 F7A3 R				div     word ptr cs:ten
 F794  85 C0					test    ax, ax
 F796  74 03					jz      dispAX1
 F798  E8 FFF1					call    dispAX
 F79B				dispAX1:
 F79B  92					xchg    ax, dx
 F79C  05 0E30					add     ax, 0e00h + '0'
 F79F  CD 10					int     10h
 F7A1  5A					pop     dx
 F7A2  C3					ret        
 F7A3 000A			ten     dw      10

 F7A5				prts:   ; es:si = string
 F7A5  B4 0E					mov     ah, 0eh    
 F7A7  26: AC					lodsb   es:[si]
 F7A9  0A C0					or      al, al
 F7AB  74 04					jz      short prtse
 F7AD  CD 10					int     10h
 F7AF  EB F4					jmp     short prts
 F7B1				prtse:
 F7B1  C3					ret



				;---------------------  read/write byte ----------------------
 F7B2  B0 FF			sdrb:   mov al,0ffh
 F7B4				sdsb:               ; in AL=byte, DX = 03dah, out AX=result
 F7B4  EE					out     dx, al
 F7B5  03 C0					add     ax, ax
 F7B7  EE					out     dx, al
 F7B8  03 C0					add     ax, ax
 F7BA  EE					out     dx, al
 F7BB  03 C0					add     ax, ax
 F7BD  EE					out     dx, al
 F7BE  03 C0					add     ax, ax
 F7C0  EE					out     dx, al
 F7C1  03 C0					add     ax, ax
 F7C3  EE					out     dx, al
 F7C4  03 C0					add     ax, ax
 F7C6  EE					out     dx, al
 F7C7  03 C0					add     ax, ax
 F7C9  EE					out     dx, al
 F7CA  ED					in      ax, dx
 F7CB  C3					ret

				;---------------------  write block ----------------------
 F7CC				sdwblk proc near              ; in SI=data ptr, DX=03dah, CX=size
 F7CC  D1 E9					shr     cx, 1
 F7CE				sdwblk1:
 F7CE  AC					lodsb
 F7CF  EE					out     dx, al
 F7D0  03 C0					add     ax, ax
 F7D2  EE					out     dx, al
 F7D3  03 C0					add     ax, ax
 F7D5  EE					out     dx, al
 F7D6  03 C0					add     ax, ax
 F7D8  EE					out     dx, al
 F7D9  03 C0					add     ax, ax
 F7DB  EE					out     dx, al
 F7DC  03 C0					add     ax, ax
 F7DE  EE					out     dx, al
 F7DF  03 C0					add     ax, ax
 F7E1  EE					out     dx, al
 F7E2  03 C0					add     ax, ax
 F7E4  EE					out     dx, al
 F7E5  AC					lodsb
 F7E6  EE					out     dx, al
 F7E7  03 C0					add     ax, ax
 F7E9  EE					out     dx, al
 F7EA  03 C0					add     ax, ax
 F7EC  EE					out     dx, al
 F7ED  03 C0					add     ax, ax
 F7EF  EE					out     dx, al
 F7F0  03 C0					add     ax, ax
 F7F2  EE					out     dx, al
 F7F3  03 C0					add     ax, ax
 F7F5  EE					out     dx, al
 F7F6  03 C0					add     ax, ax
 F7F8  EE					out     dx, al
 F7F9  03 C0					add     ax, ax
 F7FB  EE					out     dx, al
 F7FC  E2 D0					loop    short sdwblk1
 F7FE  C3					ret
 F7FF				sdwblk endp

				;---------------------  read block ----------------------
 F7FF				sdrblk proc near              ; in DI=data ptr, DX=03dah, CX=size. Returns CF = 0
 F7FF  B0 FF					mov     al, 0ffh
 F801  EE					out     dx, al
 F802  D1 E9					shr     cx, 1         ; CF = 0
 F804  EE					out     dx, al
 F805  EB 05					jmp     short sdrblk2 
 F807				sdrblk1:
 F807  EE					out     dx, al
 F808  88 25					mov     [di], ah
 F80A  EE					out     dx, al
 F80B  47					inc     di
 F80C				sdrblk2:
 F80C  EE					out     dx, al
 F80D  90					nop
 F80E  EE					out     dx, al
 F80F  90					nop
 F810  EE					out     dx, al
 F811  90					nop
 F812  EE					out     dx, al
 F813  90					nop
 F814  EE					out     dx, al
 F815  90					nop
 F816  EE					out     dx, al
 F817  ED					in      ax, dx
 F818  EE					out     dx, al
 F819  88 25					mov     [di], ah
 F81B  EE					out     dx, al
 F81C  47					inc     di
 F81D  EE					out     dx, al
 F81E  90					nop
 F81F  EE					out     dx, al
 F820  90					nop
 F821  EE					out     dx, al
 F822  90					nop
 F823  EE					out     dx, al
 F824  90					nop
 F825  EE					out     dx, al
 F826  90					nop
 F827  EE					out     dx, al
 F828  ED					in      ax, dx
 F829  E2 DC					loop    short sdrblk1
 F82B  88 25					mov     [di], ah
 F82D  47					inc     di
 F82E  C3					ret
 F82F				sdrblk endp

				;---------------------  verify block ----------------------
 F82F				sdvblk:              ; in DI=data ptr, DX=03dah, CX=size. Returns CF=1 on error
 F82F  53					push    bx
 F830  32 DB					xor     bl, bl
 F832				sdvblk1:
 F832  E8 FF7D					call    sdrb
 F835  2A 25					sub     ah, [di]
 F837  0A DC					or      bl, ah
 F839  47					inc     di
 F83A  E2 F6					loop    short sdvblk1
 F83C  F6 DB					neg     bl  ; CF=1 if BL != 0
 F83E  5B					pop     bx
 F83F  C3					ret

				;---------------------  write command ----------------------
 F840				sdcmd8T:
 F840  E8 FF6F					call    sdrb
 F843				sdcmd:              ; in SI=6 bytes cmd buffer, DX=03dah, out AH = 0ffh on error
 F843  B9 0006					mov     cx, 6
 F846  E8 FF83					call    sdwblk
 F849				sdresp:
 F849  33 F6					xor     si, si
 F84B				sdresp1:
 F84B  E8 FF64					call    sdrb
 F84E  46					inc     si
 F84F  74 05					jz      short sdcmd1
 F851  80 FC FF					cmp     ah, 0ffh
 F854  74 F5					je      short sdresp1
 F856  C3			sdcmd1: ret         

				;---------------------  read ----------------------
 F857				sdverify:
 F857  68 F82F R				push    sdvblk
 F85A  EB 03					jmp     short sdread1
 F85C				sdread:   ; DX:AX sector, ES:BX buffer, CX=sectors. returns AX=read sectors
 F85C  68 F7FF R				push    sdrblk   ; push proc address (read or verify) on stack
 F85F				sdread1:        
 F85F  50					push    ax
 F860  8A C2					mov     al, dl
 F862  50					push    ax
 F863  B2 51					mov     dl, 51h  ; CMD17
 F865  83 F9 01					cmp     cx, 1
 F868  74 01					je      short sdr1s
 F86A  42					inc     dx      ; CMD18 - multiple sectors
 F86B				sdr1s:
 F86B  52					push    dx
 F86C  8B F4					mov     si, sp 

 F86E  BA 03DA					mov     dx, 3dah
 F871  B4 01					mov     ah, 1
 F873  EF					out     dx, ax       ; CS on
 F874  8B FB					mov     di, bx
 F876  8B D9					mov     bx, cx
 F878  8B E9					mov     bp, cx       ; save sectors number
 F87A  16					push    ss
 F87B  1F					pop     ds
 F87C  C6 44 05 FF			mov	byte ptr [si+5], 0ffh ; checksum
 F880  E8 FFC0					call    sdcmd
 F883  83 C4 06					add     sp, 6
 F886  0A E4					or      ah, ah
 F888  75 41					jnz     short sdr11   ; error
 F88A  06					push    es
 F88B  1F					pop     ds
 F88C				sdrms:
 F88C  8B C7					mov     ax, di
 F88E  C1 E8 04					shr     ax, 4
 F891  8C DE					mov     si, ds
 F893  03 C6					add     ax, si
 F895  8E D8					mov     ds, ax
 F897  83 E7 0F					and     di, 15
 F89A  E8 FFAC					call    sdresp     ; wait for 0feh token
 F89D  80 FC FE					cmp     ah, 0feh
 F8A0  75 29					jne     short sdr11; read token error 
 F8A2  B5 02					mov     ch, 2      ; 512 byte sector
 F8A4  5E					pop     si
 F8A5  FF D6					call    si         ; sdrblk or sdvblk
 F8A7  56					push    si
 F8A8  9C					pushf
 F8A9  E8 FF06					call    sdrb       ; ignore CRC
 F8AC  E8 FF03					call    sdrb       ; ignore CRC
 F8AF  9D					popf
 F8B0  72 03					jc      short sdr3 ; verify error   
 F8B2  4B					dec     bx
 F8B3  75 D7					jnz     short sdrms; multiple sectors
 F8B5				sdr3:        
 F8B5  83 FD 01					cmp     bp, 1
 F8B8  74 11					je      short sdr11; single sector
 F8BA  BE FA04 R				mov     si, offset SD_CMD12 ; stop transfer
 F8BD  0E					push    cs
 F8BE  1F					pop     ds
 F8BF  E8 FF81					call    sdcmd
 F8C2				sdr2:
 F8C2  D0 EC					shr     ah, 1
 F8C4  73 05					jnc     short sdr11
 F8C6  E8 FEE9					call    sdrb
 F8C9  EB F7					jmp     short sdr2
 F8CB				sdr11:
 F8CB  58					pop     ax         ; remove proc address from stack
 F8CC				sdr1:       
 F8CC  33 C0					xor     ax, ax
 F8CE  EF					out     dx, ax
 F8CF  E8 FEE0					call    sdrb       ; 8T
 F8D2  8B C5					mov     ax, bp
 F8D4  2B C3					sub     ax, bx
 F8D6  C3					ret     

				;---------------------  write ----------------------
 F8D7				sdwrite:   ; DX:AX sector, ES:BX buffer, CX=sectors, returns AX=wrote sectors
 F8D7  50					push    ax
 F8D8  8A C2					mov     al, dl
 F8DA  50					push    ax
 F8DB  B2 58					mov     dl, 58h  ; CMD24
 F8DD  83 F9 01					cmp     cx, 1
 F8E0  74 01					je      short sdw1s
 F8E2  42					inc     dx      ; CMD25 - multiple sectors
 F8E3				sdw1s:
 F8E3  52					push    dx
 F8E4  8B F4					mov     si, sp 

 F8E6  BA 03DA					mov     dx, 3dah
 F8E9  B4 01					mov     ah, 1
 F8EB  EF					out     dx, ax       ; CS on
 F8EC  8B E9					mov     bp, cx       ; save sectors number
 F8EE  16					push    ss
 F8EF  1F					pop     ds
 F8F0  C6 44 05 FF			mov	byte ptr [si+5], 0ffh ; checksum
 F8F4  E8 FF4C					call    sdcmd
 F8F7  83 C4 06					add     sp, 6
 F8FA  8B F3					mov     si, bx
 F8FC  8B DD					mov     bx, bp
 F8FE  0A E4					or      ah, ah
 F900  75 CA					jnz     short sdr1   ; error
 F902  06					push    es
 F903  1F					pop     ds
 F904				sdwms:
 F904  8B C6					mov     ax, si
 F906  C1 E8 04					shr     ax, 4
 F909  8C DF					mov     di, ds
 F90B  03 C7					add     ax, di
 F90D  8E D8					mov     ds, ax
 F90F  83 E6 0F					and     si, 15
 F912  B0 FE					mov     al, 0feh      ; start token
 F914  83 FD 01					cmp     bp, 1
 F917  74 02					je      short sdw1s1
 F919  B0 FC					mov     al, 0fch   ; multiple sectors
 F91B				sdw1s1:        
 F91B  E8 FE96					call    sdsb     
 F91E  B5 02					mov     ch, 2      ; 512 byte sector
 F920  E8 FEA9					call    sdwblk
 F923  E8 FE8C					call    sdrb       ; ignore CRC
 F926  E8 FE89					call    sdrb       ; ignore CRC
 F929  E8 FE86					call    sdrb       ; read response byte xxx00101
 F92C  80 E4 0E					and     ah, 0eh
 F92F  80 FC 04					cmp     ah, 4
 F932  75 98					jne     short sdr1 ; write error
 F934				sdwwait:
 F934  E8 FE7B					call    sdrb
 F937  D0 EC					shr     ah, 1
 F939  73 F9					jnc     short sdwwait     ; wait write completion
 F93B  4B					dec     bx
 F93C  75 C6					jnz     short sdwms       ; multiple sectors

 F93E  83 FD 01					cmp     bp, 1
 F941  74 89					je      short sdr1
 F943  B0 FD					mov     al, 0fdh     ; multiple end transfer
 F945  E8 FE6C					call    sdsb 
 F948  E8 FE67					call	sdrb     
 F94B				sdwwait1:
 F94B  E8 FE64					call    sdrb
 F94E  D0 EC					shr     ah, 1
 F950  73 F9					jnc     short sdwwait1     ; wait write completion
 F952  E9 FF77					jmp     sdr1
						
				;---------------------  init SD ----------------------
 F955				sdinit  proc near       ; returns AX = num kilosectors
 F955  1E					push    ds
 F956  51					push    cx
 F957  52					push    dx
 F958  56					push    si
 F959  57					push    di
 F95A  BA 03DA					mov     dx, 3dah
 F95D  B9 000A					mov     cx, 10
 F960				sdinit1:                   ; send 80T
 F960  E8 FE4F					call    sdrb
 F963  E2 FB					loop    short sdinit1

 F965  B4 01					mov     ah, 1
 F967  EF					out     dx, ax       ; select SD

 F968  BE F9F2 R				mov     si, offset SD_CMD0
 F96B  0E					push    cs
 F96C  1F					pop     ds
 F96D  E8 FED3					call    sdcmd
 F970  FE CC					dec     ah
 F972  75 70					jnz     short sdexit ; error
						
 F974  BE F9F8 R				mov     si, offset SD_CMD8
 F977  E8 FEC6					call    sdcmd8T
 F97A  FE CC					dec     ah
 F97C  75 66					jnz     short sdexit ; error
 F97E  B1 04					mov     cl, 4
 F980  2B E1					sub     sp, cx
 F982  8B FC					mov     di, sp
 F984  16					push    ss
 F985  1F					pop     ds
 F986  E8 FE76					call    sdrblk
 F989  58					pop     ax
 F98A  58					pop     ax
 F98B  80 FC AA					cmp     ah, 0aah
 F98E  75 54					jne     short sdexit ; CMD8 error
 F990				repinit:        
 F990  BE FA10 R				mov     si, offset SD_CMD55
 F993  0E					push    cs
 F994  1F					pop     ds
 F995  E8 FEA8					call    sdcmd8T
 F998  E8 FE17					call    sdrb
 F99B  BE FA0A R				mov     si, offset SD_CMD41
 F99E  E8 FEA2					call    sdcmd
 F9A1  FE CC					dec     ah
 F9A3  74 EB					jz      short repinit
						
 F9A5  BE FA16 R				mov     si, offset SD_CMD58
 F9A8  E8 FE95					call    sdcmd8T
 F9AB  B1 04					mov     cl, 4
 F9AD  2B E1					sub     sp, cx
 F9AF  8B FC					mov     di, sp
 F9B1  16					push    ss
 F9B2  1F					pop     ds
 F9B3  E8 FE49					call    sdrblk
 F9B6  58					pop     ax
 F9B7  A8 40					test    al, 40h     ; test OCR bit 30 (CCS)
 F9B9  58					pop     ax
 F9BA  74 28					jz      short sdexit; no SDHC

 F9BC  BE F9FE R				mov     si, offset SD_CMD9 ; get size info
 F9BF  0E					push    cs
 F9C0  1F					pop     ds
 F9C1  E8 FE7C					call    sdcmd8T
 F9C4  0A E4					or      ah, ah
 F9C6  75 1C					jnz     short sdexit
 F9C8  E8 FE7E					call    sdresp     ; wait for 0feh token
 F9CB  80 FC FE					cmp     ah, 0feh
 F9CE  75 14					jne     short sdexit
 F9D0  B1 12					mov     cl, 18       ; 16bytes + 2bytes CRC
 F9D2  2B E1					sub     sp, cx
 F9D4  8B FC					mov     di, sp
 F9D6  16					push    ss
 F9D7  1F					pop     ds
 F9D8  E8 FE24					call    sdrblk
 F9DB  8B 4D F6					mov     cx, [di-10]
 F9DE  C1 C1 08					rol     cx, 8
 F9E1  41					inc     cx
 F9E2  8B E7					mov     sp, di
 F9E4				sdexit: 
 F9E4  33 C0					xor     ax, ax       ; raise CS
 F9E6  EF					out     dx, ax
 F9E7  E8 FDC8					call    sdrb
 F9EA  5F					pop     di
 F9EB  5E					pop     si
 F9EC  5A					pop     dx
 F9ED  8B C1					mov     ax, cx       
 F9EF  59					pop     cx
 F9F0  1F					pop     ds
 F9F1  C3					ret
 F9F2				sdinit endp
					
 F9F2 40 00 00 00 00 95		SD_CMD0     db  40h, 0, 0, 0, 0, 95h
 F9F8 48 00 00 01 AA 87		SD_CMD8     db  48h, 0, 0, 1, 0aah, 087h
 F9FE 49 00 00 00 00 FF		SD_CMD9     db  49h, 0, 0, 0, 0, 0ffh
 FA04 4C 00 00 00 00 FF		SD_CMD12    db  4ch, 0, 0, 0, 0, 0ffh
 FA0A 69 40 00 00 00 FF		SD_CMD41    db  69h, 40h, 0, 0, 0, 0ffh
 FA10 77 00 00 00 00 FF		SD_CMD55    db  77h, 0, 0, 0, 0, 0ffh
 FA16 7A 00 00 00 00 FF		SD_CMD58    db  7ah, 0, 0, 0, 0, 0ffh


 FA1C				Pal256:
 FA1C  00 00 00 00 00 2A			db  00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,15h,00h, 2ah,2ah,2ah 
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 15 00 2A 2A 2A
 FA34  15 15 15 15 15 3F			db  15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh 
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FA4C  00 00 00 05 05 05			db  00h,00h,00h, 05h,05h,05h, 08h,08h,08h, 0bh,0bh,0bh, 0eh,0eh,0eh, 11h,11h,11h, 14h,14h,14h, 18h,18h,18h 
       08 08 08 0B 0B 0B
       0E 0E 0E 11 11 11
       14 14 14 18 18 18
 FA64  1C 1C 1C 20 20 20			db  1ch,1ch,1ch, 20h,20h,20h, 24h,24h,24h, 28h,28h,28h, 2dh,2dh,2dh, 32h,32h,32h, 38h,38h,38h, 3fh,3fh,3fh 
       24 24 24 28 28 28
       2D 2D 2D 32 32 32
       38 38 38 3F 3F 3F
 FA7C  00 00 3F 10 00 3F			db  00h,00h,3fh, 10h,00h,3fh, 1fh,00h,3fh, 2fh,00h,3fh, 3fh,00h,3fh, 3fh,00h,2fh, 3fh,00h,1fh, 3fh,00h,10h 
       1F 00 3F 2F 00 3F
       3F 00 3F 3F 00 2F
       3F 00 1F 3F 00 10
 FA94  3F 00 00 3F 10 00			db  3fh,00h,00h, 3fh,10h,00h, 3fh,1fh,00h, 3fh,2fh,00h, 3fh,3fh,00h, 2fh,3fh,00h, 1fh,3fh,00h, 10h,3fh,00h 
       3F 1F 00 3F 2F 00
       3F 3F 00 2F 3F 00
       1F 3F 00 10 3F 00
 FAAC  00 3F 00 00 3F 10			db  00h,3fh,00h, 00h,3fh,10h, 00h,3fh,1fh, 00h,3fh,2fh, 00h,3fh,3fh, 00h,2fh,3fh, 00h,1fh,3fh, 00h,10h,3fh 
       00 3F 1F 00 3F 2F
       00 3F 3F 00 2F 3F
       00 1F 3F 00 10 3F
 FAC4  1F 1F 3F 27 1F 3F			db  1fh,1fh,3fh, 27h,1fh,3fh, 2fh,1fh,3fh, 37h,1fh,3fh, 3fh,1fh,3fh, 3fh,1fh,37h, 3fh,1fh,2fh, 3fh,1fh,27h
       2F 1F 3F 37 1F 3F
       3F 1F 3F 3F 1F 37
       3F 1F 2F 3F 1F 27
 FADC  00 01 02 03 04 05			db	00h, 01h, 02h, 03h, 04h, 05h, 06h, 07h, 08h, 09h, 0ah, 0bh, 0ch, 0dh, 0eh, 0fh	; EGA palette registers
       06 07 08 09 0A 0B
       0C 0D 0E 0F

				;		db  3fh,1fh,1fh, 3fh,27h,1fh, 3fh,2fh,1fh, 3fh,37h,1fh, 3fh,3fh,1fh, 37h,3fh,1fh, 2fh,3fh,1fh, 27h,3fh,1fh 
				;		db  1fh,3fh,1fh, 1fh,3fh,27h, 1fh,3fh,2fh, 1fh,3fh,37h, 1fh,3fh,3fh, 1fh,37h,3fh, 1fh,2fh,3fh, 1fh,27h,3fh 
				;		db  2dh,2dh,3fh, 31h,2dh,3fh, 36h,2dh,3fh, 3ah,2dh,3fh, 3fh,2dh,3fh, 3fh,2dh,3ah, 3fh,2dh,36h, 3fh,2dh,31h 
				;		db  3fh,2dh,2dh, 3fh,31h,2dh, 3fh,36h,2dh, 3fh,3ah,2dh, 3fh,3fh,2dh, 3ah,3fh,2dh, 36h,3fh,2dh, 31h,3fh,2dh 
				;		db  2dh,3fh,2dh, 2dh,3fh,31h, 2dh,3fh,36h, 2dh,3fh,3ah, 2dh,3fh,3fh, 2dh,3ah,3fh, 2dh,36h,3fh, 2dh,31h,3fh 
				;		db  00h,00h,1ch, 07h,00h,1ch, 0eh,00h,1ch, 15h,00h,1ch, 1ch,00h,1ch, 1ch,00h,15h, 1ch,00h,0eh, 1ch,00h,07h 
				;		db  1ch,00h,00h, 1ch,07h,00h, 1ch,0eh,00h, 1ch,15h,00h, 1ch,1ch,00h, 15h,1ch,00h, 0eh,1ch,00h, 07h,1ch,00h 
				;		db  00h,1ch,00h, 00h,1ch,07h, 00h,1ch,0eh, 00h,1ch,15h, 00h,1ch,1ch, 00h,15h,1ch, 00h,0eh,1ch, 00h,07h,1ch 

				;		db  0eh,0eh,1ch, 11h,0eh,1ch, 15h,0eh,1ch, 18h,0eh,1ch, 1ch,0eh,1ch, 1ch,0eh,18h, 1ch,0eh,15h, 1ch,0eh,11h 
				;		db  1ch,0eh,0eh, 1ch,11h,0eh, 1ch,15h,0eh, 1ch,18h,0eh, 1ch,1ch,0eh, 18h,1ch,0eh, 15h,1ch,0eh, 11h,1ch,0eh 
				;		db  0eh,1ch,0eh, 0eh,1ch,11h, 0eh,1ch,15h, 0eh,1ch,18h, 0eh,1ch,1ch, 0eh,18h,1ch, 0eh,15h,1ch, 0eh,11h,1ch 
				;		db  14h,14h,1ch, 16h,14h,1ch, 18h,14h,1ch, 1ah,14h,1ch, 1ch,14h,1ch, 1ch,14h,1ah, 1ch,14h,18h, 1ch,14h,16h 
				;		db  1ch,14h,14h, 1ch,16h,14h, 1ch,18h,14h, 1ch,1ah,14h, 1ch,1ch,14h, 1ah,1ch,14h, 18h,1ch,14h, 16h,1ch,14h 
				;		db  14h,1ch,14h, 14h,1ch,16h, 14h,1ch,18h, 14h,1ch,1ah, 14h,1ch,1ch, 14h,1ah,1ch, 14h,18h,1ch, 14h,16h,1ch 
				;		db  00h,00h,10h, 04h,00h,10h, 08h,00h,10h, 0ch,00h,10h, 10h,00h,10h, 10h,00h,0ch, 10h,00h,08h, 10h,00h,04h 
				;		db  10h,00h,00h, 10h,04h,00h, 10h,08h,00h, 10h,0ch,00h, 10h,10h,00h, 0ch,10h,00h, 08h,10h,00h, 04h,10h,00h 

				;		db  00h,10h,00h, 00h,10h,04h, 00h,10h,08h, 00h,10h,0ch, 00h,10h,10h, 00h,0ch,10h, 00h,08h,10h, 00h,04h,10h 
				;		db  08h,08h,10h, 0ah,08h,10h, 0ch,08h,10h, 0eh,08h,10h, 10h,08h,10h, 10h,08h,0eh, 10h,08h,0ch, 10h,08h,0ah 
				;		db  10h,08h,08h, 10h,0ah,08h, 10h,0ch,08h, 10h,0eh,08h, 10h,10h,08h, 0eh,10h,08h, 0ch,10h,08h, 0ah,10h,08h 
				;		db  08h,10h,08h, 08h,10h,0ah, 08h,10h,0ch, 08h,10h,0eh, 08h,10h,10h, 08h,0eh,10h, 08h,0ch,10h, 08h,0ah,10h 
				;		db  0bh,0bh,10h, 0ch,0bh,10h, 0dh,0bh,10h, 0fh,0bh,10h, 10h,0bh,10h, 10h,0bh,0fh, 10h,0bh,0dh, 10h,0bh,0ch 
				;		db  10h,0bh,0bh, 10h,0ch,0bh, 10h,0dh,0bh, 10h,0fh,0bh, 10h,10h,0bh, 0fh,10h,0bh, 0dh,10h,0bh, 0ch,10h,0bh 
				;		db  0bh,10h,0bh, 0bh,10h,0ch, 0bh,10h,0dh, 0bh,10h,0fh, 0bh,10h,10h, 0bh,0fh,10h, 0bh,0dh,10h, 0bh,0ch,10h 
				;		db  00h,00h,00h, 00h,00h,00h, 00h,00h,00h, 00h,00h,00h, 00h,00h,00h, 00h,00h,00h, 00h,00h,00h, 00h,00h,00h

 FAEC				PalEGA:
 FAEC  00 00 00 00 00 2A			db	00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,15h,00h, 2ah,2ah,2ah
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 15 00 2A 2A 2A
 FB04  00 00 00 00 00 2A			db	00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,15h,00h, 2ah,2ah,2ah
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 15 00 2A 2A 2A
 FB1C  15 15 15 15 15 3F			db	15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FB34  15 15 15 15 15 3F			db	15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FB4C  00 00 00 00 00 2A			db	00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,15h,00h, 2ah,2ah,2ah
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 15 00 2A 2A 2A
 FB64  00 00 00 00 00 2A			db	00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,15h,00h, 2ah,2ah,2ah
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 15 00 2A 2A 2A
 FB7C  15 15 15 15 15 3F			db	15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FB94  15 15 15 15 15 3F			db	15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FBAC  00 01 02 03 04 05			db	00h, 01h, 02h, 03h, 04h, 05h, 06h, 07h, 10h, 11h, 12h, 13h, 14h, 15h, 16h, 17h	; EGA palette registers
       06 07 10 11 12 13
       14 15 16 17

 FBBC				PalVGA:
 FBBC  00 00 00 00 00 2A			db	00h,00h,00h, 00h,00h,2ah, 00h,2ah,00h, 00h,2ah,2ah, 2ah,00h,00h, 2ah,00h,2ah, 2ah,2ah,00h, 2ah,2ah,2ah
       00 2A 00 00 2A 2A
       2A 00 00 2A 00 2A
       2A 2A 00 2A 2A 2A
 FBD4  00 00 15 00 00 3F			db	00h,00h,15h, 00h,00h,3fh, 00h,2ah,15h, 00h,2ah,3fh, 2ah,00h,15h, 2ah,00h,3fh, 2ah,2ah,15h, 2ah,2ah,3fh
       00 2A 15 00 2A 3F
       2A 00 15 2A 00 3F
       2A 2A 15 2A 2A 3F
 FBEC  00 15 00 00 15 2A			db	00h,15h,00h, 00h,15h,2ah, 00h,3fh,00h, 00h,3fh,2ah, 2ah,15h,00h, 2ah,15h,2ah, 2ah,3fh,00h, 2ah,3fh,2ah
       00 3F 00 00 3F 2A
       2A 15 00 2A 15 2A
       2A 3F 00 2A 3F 2A
 FC04  00 15 15 00 15 3F			db	00h,15h,15h, 00h,15h,3fh, 00h,3fh,15h, 00h,3fh,3fh, 2ah,15h,15h, 2ah,15h,3fh, 2ah,3fh,15h, 2ah,3fh,3fh
       00 3F 15 00 3F 3F
       2A 15 15 2A 15 3F
       2A 3F 15 2A 3F 3F
 FC1C  15 00 00 15 00 2A			db	15h,00h,00h, 15h,00h,2ah, 15h,2ah,00h, 15h,2ah,2ah, 3fh,00h,00h, 3fh,00h,2ah, 3fh,2ah,00h, 3fh,2ah,2ah
       15 2A 00 15 2A 2A
       3F 00 00 3F 00 2A
       3F 2A 00 3F 2A 2A
 FC34  15 00 15 15 00 3F			db	15h,00h,15h, 15h,00h,3fh, 15h,2ah,15h, 15h,2ah,3fh, 3fh,00h,15h, 3fh,00h,3fh, 3fh,2ah,15h, 3fh,2ah,3fh
       15 2A 15 15 2A 3F
       3F 00 15 3F 00 3F
       3F 2A 15 3F 2A 3F
 FC4C  15 15 00 15 15 2A			db	15h,15h,00h, 15h,15h,2ah, 15h,3fh,00h, 15h,3fh,2ah, 3fh,15h,00h, 3fh,15h,2ah, 3fh,3fh,00h, 3fh,3fh,2ah
       15 3F 00 15 3F 2A
       3F 15 00 3F 15 2A
       3F 3F 00 3F 3F 2A
 FC64  15 15 15 15 15 3F			db	15h,15h,15h, 15h,15h,3fh, 15h,3fh,15h, 15h,3fh,3fh, 3fh,15h,15h, 3fh,15h,3fh, 3fh,3fh,15h, 3fh,3fh,3fh
       15 3F 15 15 3F 3F
       3F 15 15 3F 15 3F
       3F 3F 15 3F 3F 3F
 FC7C  00 01 02 03 04 05			db	00h, 01h, 02h, 03h, 04h, 05h, 14h, 07h, 38h, 39h, 3ah, 3bh, 3ch, 3dh, 3eh, 3fh	; EGA palette registers
       14 07 38 39 3A 3B
       3C 3D 3E 3F

				IFDEF SCANCODE1 ; use SCANCODE1
 FC8C				KeyIndex:
 FC8C  00 52 31 32 34 33			db	0, 82, 49, 50, 52, 51, 54, 55    ;0-7
       36 37
 FC94  38 39 3C 3B 41 44			db 56, 57, 60, 59, 65, 68, 72, 47    ;8-f
       48 2F
 FC9C  01 05 09 0D 0C 12			db	1,  5,  9, 13, 12, 18, 21, 23    ;10-17
       15 17
 FCA4  18 1A 43 46 45 00			db 24, 26, 67, 70, 69,  0,  4,  3    ;18-1f
       04 03
 FCAC  08 0B 11 10 14 16			db	8, 11, 17, 16, 20, 22, 25, 64    ;20-27
       19 40
 FCB4  42 30 00 47 02 07			db 66, 48,  0, 71,  2,  7,  6, 10    ;28-2f
       06 0A
 FCBC  0F 0E 13 3A 3D 3E			db 15, 14, 19, 58, 61, 62,  0, 87    ;30-37
       00 57
 FCC4  00 35 00 28 29 27			db	0, 53,  0, 40, 41, 39, 46, 38    ;38-3f
       2E 26
 FCCC  2D 5A 2C 4F 2B 00			db 45, 90, 44, 79, 43,  0, 89, 29    ;40-47
       59 1D
 FCD4  22 24 56 1C 25 21			db 34, 36, 86, 28, 37, 33, 84, 27    ;48-4f
       54 1B
 FCDC  20 23 1E 1F 00 00			db 32, 35, 30, 31,  0,  0,	0, 83    ;50-57  
       00 53
 FCE4  2A					db 42
 FCE5				E0KeyList:
 FCE5  35 1C 4F 4B 47 52		db	35h, 1ch, 4fh, 4bh, 47h, 52h, 53h, 50h, 4dh, 48h, 51h, 49h 
       53 50 4D 48 51 49

				ELSE    ; use SCANCODE2
				ENDIF

 FCF1				E0KeyIndex:
 FCF1  3F 45 49 4A 4B 4C		db	63,  69,  73,  74,  75,  76,  77,  78,  80,  81,  85,  88
       4D 4E 50 51 55 58

 FCFD				KeyCode:	  
				; Keys affected by CapsLock
				;		norm   shft   ctrl   alt
 FCFD  0000 0000 0000				dw	0000h, 0000h, 0000h, 0000h ;17 - <0>
       0000
 FD05  1071 1051 1011				dw	1071h, 1051h, 1011h, 1000h ;15 - Q, (E0)PrevTrack <1>
       1000
 FD0D  2C7A 2C5A 2C1A				dw	2c7ah, 2c5ah, 2c1ah, 2c00h ;1a - Z <2>
       2C00
 FD15  1F73 1F53 1F13				dw	1f73h, 1f53h, 1f13h, 1f00h ;1b - S <3>
       1F00
 FD1D  1E61 1E41 1E01				dw	1e61h, 1e41h, 1e01h, 1e00h ;1c - A <4>
       1E00
 FD25  1177 1157 1117				dw	1177h, 1157h, 1117h, 1100h ;1d - W <5>
       1100
 FD2D  2E63 2E43 2E03				dw	2e63h, 2e43h, 2e03h, 2e00h ;21 - C, (E0)Volume Down <6>
       2E00
 FD35  2D78 2D58 2D18				dw	2d78h, 2d58h, 2d18h, 2d00h ;22 - X <7>
       2D00
 FD3D  2064 2044 2004				dw	2064h, 2044h, 2004h, 2000h ;23 - D, (E0)Mute <8>
       2000
 FD45  1265 1245 1205				dw	1265h, 1245h, 1205h, 1200h ;24 - E <9>
       1200
 FD4D  2F76 2F56 2F16				dw	2f76h, 2f56h, 2f16h, 2f00h ;2a - V <10>
       2F00
 FD55  2166 2146 2106				dw	2166h, 2146h, 2106h, 2100h ;2b - F, (E0)Calculator <11>
       2100
 FD5D  1474 1454 1414				dw	1474h, 1454h, 1414h, 1400h ;2c - T <12>
       1400
 FD65  1372 1352 1312				dw	1372h, 1352h, 1312h, 1300h ;2d - R <13>
       1300
 FD6D  316E 314E 310E				dw	316eh, 314eh, 310eh, 3100h ;31 - N <14>
       3100
 FD75  3062 3042 3002				dw	3062h, 3042h, 3002h, 3000h ;32 - B, (E0)Volume Up <15>
       3000
 FD7D  2368 2348 2308				dw	2368h, 2348h, 2308h, 2300h ;33 - H <16>
       2300
 FD85  2267 2247 2207				dw	2267h, 2247h, 2207h, 2200h ;34 - G, (E0)Play/Pause <17>
       2200
 FD8D  1579 1559 1519				dw	1579h, 1559h, 1519h, 1500h ;35 - Y <18>
       1500
 FD95  326D 324D 320D				dw	326dh, 324dh, 320dh, 3200h ;3a - M, (E0)WWW Home <19>
       3200
 FD9D  246A 244A 240A				dw	246ah, 244ah, 240ah, 2400h ;3b - J, (E0)Stop <20>
       2400
 FDA5  1675 1655 1615				dw	1675h, 1655h, 1615h, 1600h ;3c - U <21>
       1600
 FDAD  256B 254B 250B				dw	256bh, 254bh, 250bh, 2500h ;42 - K <22>
       2500
 FDB5  1769 1749 1709				dw	1769h, 1749h, 1709h, 1700h ;43 - I <23>
       1700
 FDBD  186F 184F 180F				dw	186fh, 184fh, 180fh, 1800h ;44 - O <24>
       1800
 FDC5  266C 264C 260C				dw	266ch, 264ch, 260ch, 2600h ;4b - L <25>
       2600
 FDCD  1970 1950 1910				dw	1970h, 1950h, 1910h, 1900h ;4d - P, (E0)Next Track <26>
       1900
				; keys affected by NumLock	
 FDD5  4F00 4F31 7500				dw	4f00h, 4f31h, 7500h, 0002h ;69 - KP1 <27>
       0002
 FDDD  4B00 4B34 7300				dw	4b00h, 4b34h, 7300h, 0005h ;6b - KP4 <28>
       0005
 FDE5  4700 4737 7700				dw	4700h, 4737h, 7700h, 0008h ;6c - KP7 <29>
       0008
 FDED  5200 5230 9200				dw	5200h, 5230h, 9200h, 0001h ;70 - KP0 <30>
       0001
 FDF5  5300 532E 9300				dw	5300h, 532eh, 9300h, 0000h ;71 - KP. <31>
       0000
 FDFD  5000 5032 9100				dw	5000h, 5032h, 9100h, 0003h ;72 - KP2 <32>
       0003
 FE05  4D00 4D36 7400				dw	4d00h, 4d36h, 7400h, 0007h ;74 - KP6 <33>
       0007
 FE0D  4800 4838 8D00				dw	4800h, 4838h, 8d00h, 0009h ;75 - KP8 <34>
       0009
 FE15  5100 5133 7600				dw	5100h, 5133h, 7600h, 0004h ;7a - KP3 <35>
       0004
 FE1D  4900 4939 8400				dw	4900h, 4939h, 8400h, 000ah ;7d - KP9 <36>
       000A
 FE25  4C00 4C35 8F00				dw	4c00h, 4c35h, 8f00h, 0006h ;73 - KP5 --- on VMWare, it does not send 4c00 <37>
       0006
				; keys unaffected by CapsLock or N
 FE2D  3F00 5800 6200				dw	3f00h, 5800h, 6200h, 6c00h ;03 - F5 <38>
       6C00
 FE35  3D00 5600 6000				dw	3d00h, 5600h, 6000h, 6a00h ;04 - F3 <39>
       6A00
 FE3D  3B00 5400 5E00				dw	3b00h, 5400h, 5e00h, 6800h ;05 - F1 <40>
       6800
 FE45  3C00 5500 5F00				dw	3c00h, 5500h, 5f00h, 6900h ;06 - F2 <41>
       6900
 FE4D  8600 8800 8A00				dw	8600h, 8800h, 8a00h, 8c00h ;07 - F12 <42>	
       8C00
 FE55  4400 5D00 6700				dw	4400h, 5d00h, 6700h, 7100h ;09 - F10 <43>
       7100
 FE5D  4200 5B00 6500				dw	4200h, 5b00h, 6500h, 6f00h ;0a - F8 <44>
       6F00
 FE65  4000 5900 6300				dw	4000h, 5900h, 6300h, 6d00h ;0b - F6 <45>
       6D00
 FE6D  3E00 5700 6100				dw	3e00h, 5700h, 6100h, 6b00h ;0c - F4 <46>
       6B00
 FE75  0F09 0F00 9400				dw	0f09h, 0f00h, 9400h, 0000h ;0d - TAB <47>	
       0000
 FE7D  2960 297E 0000				dw	2960h, 297eh, 0000h, 2900h ;0e - ` ~ <48>	
       2900
 FE85  0231 0221 0000				dw	0231h, 0221h, 0000h, 7800h ;16 - 1 ! <49>	
       7800
 FE8D  0332 0340 0300				dw	0332h, 0340h, 0300h, 7900h ;1e - 2 @ <50>	
       7900
 FE95  0534 0524 0000				dw	0534h, 0524h, 0000h, 7b00h ;25 - 4 $ <51>
       7B00
 FE9D  0433 0423 0000				dw	0433h, 0423h, 0000h, 7a00h ;26 - 3 # <52>
       7A00
 FEA5  3920 3920 3920				dw	3920h, 3920h, 3920h, 3920h ;29 - SPC <53>	
       3920
 FEAD  0635 0625 0000				dw	0635h, 0625h, 0000h, 7c00h ;2e - 5 % <54>
       7C00
 FEB5  0736 075E 071E				dw	0736h, 075eh, 071eh, 7d00h ;36 - 6 ^ <55>
       7D00
 FEBD  0837 0826 0000				dw	0837h, 0826h, 0000h, 7e00h ;3d - 7 & <56>
       7E00
 FEC5  0938 092A 0000				dw	0938h, 092ah, 0000h, 7f00h ;3e - 8 * <57>
       7F00
 FECD  332C 333C 0000				dw	332ch, 333ch, 0000h, 3300h ;41 - , < <58>
       3300
 FED5  0B30 0B29 0000				dw	0b30h, 0b29h, 0000h, 8100h ;45 - 0 ) <59>
       8100
 FEDD  0A39 0A28 0000				dw	0a39h, 0a28h, 0000h, 8000h ;46 - 9 ( <60>
       8000
 FEE5  342E 343E 0000				dw	342eh, 343eh, 0000h, 3400h ;49 - . > <61>
       3400
 FEED  352F 353F 0000				dw	352fh, 353fh, 0000h, 3500h ;4a - / ? <62>
       3500
 FEF5  E02F E02F 9500				dw	0e02fh, 0e02fh, 9500h, 0a400h ;4a - (e0)KP/ <63>
       A400
 FEFD  273B 273A 0000				dw	273bh, 273ah, 0000h, 2700h ;4c - ; : <64>
       2700
 FF05  0C2D 0C5F 0C1F				dw	0c2dh, 0c5fh, 0c1fh, 8200h ;4e - - _ <65>
       8200
 FF0D  2827 2822 0000				dw	2827h, 2822h, 0000h, 2800h ;52 -   <66>
       2800
 FF15  1A5B 1A7B 1A1B				dw	1a5bh, 1a7bh, 1a1bh, 1a00h ;54 - [ { <67>
       1A00
 FF1D  0D3D 0D2B 0000				dw	0d3dh, 0d2bh, 0000h, 8300h ;55 - = + <68>	
       8300
 FF25  1C0D 1C0D 1C0A				dw	1c0dh, 1c0dh, 1c0ah, 1c00h ;5a - Enter, (E0)KPEnter <69>
       1C00
 FF2D  1B5D 1B7D 1B1D				dw	1b5dh, 1b7dh, 1b1dh, 1b00h ;5b - ] } <70>
       1B00
 FF35  2B5C 2B7C 2B1C				dw	2b5ch, 2b7ch, 2b1ch, 2b00h ;5d - \ | <71>
       2B00
 FF3D  0E08 0E08 0E7F				dw	0e08h, 0e08h, 0e7fh, 0e00h ;66 - BKSP <72>
       0E00
 FF45  4F00 4F00 7500				dw	4f00h, 4f00h, 7500h, 9f00h ;69 - (E0)END <73>
       9F00
 FF4D  4B00 4B00 7300				dw	4b00h, 4b00h, 7300h, 9b00h ;6b - (E0)LEFT <74>
       9B00
 FF55  4700 4700 7700				dw	4700h, 4700h, 7700h, 9700h ;6c - (E0)HOME <75>
       9700
 FF5D  5200 5200 9200				dw	5200h, 5200h, 9200h, 0a200h ;70 - (E0)INS <76>
       A200
 FF65  5300 5300 9300				dw	5300h, 5300h, 9300h, 0a300h ;71 - (E0)DEL <77>
       A300
 FF6D  5000 5000 9100				dw	5000h, 5000h, 9100h, 0a000h ;72 - (E0)DOWN <78>
       A000
 FF75  4300 5C00 6600				dw	4300h, 5c00h, 6600h, 7000h ;01 - F9 <79>
       7000
 FF7D  4D00 4D00 7400				dw	4d00h, 4d00h, 7400h, 9d00h ;74 - (E0)RIGHT <80>
       9D00
 FF85  4800 4800 8D00				dw	4800h, 4800h, 8d00h, 9800h ;75 - (E0)UP <81>
       9800
 FF8D  011B 011B 011B				dw	011bh, 011bh, 011bh, 0100h ;76 - ESC <82>
       0100
 FF95  8500 8700 8900				dw	8500h, 8700h, 8900h, 8b00h ;78 - F11 <83>
       8B00
 FF9D  4E2B 4E2B 9000				dw	4e2bh, 4e2bh, 9000h, 4e00h ;79 - KP+ <84>
       4E00
 FFA5  5100 5100 7600				dw	5100h, 5100h, 7600h, 0a100h ;7a - (E0)PGDN <85>
       A100
 FFAD  4A2D 4A2D 8E00				dw	4a2dh, 4a2dh, 8e00h, 4a00h ;7b - KP- <86>
       4A00
 FFB5  372A 372A 9600				dw	372ah, 372ah, 9600h, 3700h ;7c - KP* --- on VMWare, it does not send 3710h with CTL <87>
       3700
 FFBD  4900 4900 8400				dw	4900h, 4900h, 8400h, 9900h ;7d - (E0)PGUP <88>
       9900
 FFC5  4600 4600 4600				dw	4600h, 4600h, 4600h, 4600h ;7e - SCRL <89>
       4600
 FFCD  4100 5A00 6400				dw	4100h, 5a00h, 6400h, 6e00h ;83 - F7 <90>
       6E00

				; ------------------------- POWER ON RESET -----------------------
						org     0fff0h
						
 FFF0  EA					db      0eah
 FFF1  E05B R F000				dw      coldboot, 0f000h
 FFF5  30 39 2F 31 30 2F			db      '09/10/17'
       31 37
 FFFD  FF FF 00					db      0ffh, 0ffh, 0
				end bios
Microsoft (R) Macro Assembler Version 6.14.8444		    04/08/22 23:25:16
BIOS_Next186.asm					     Symbols 2 - 1




Macros:

                N a m e                 Type

OFFDX  . . . . . . . . . . . . .	Proc


Segments and Groups:

                N a m e                 Size     Length   Align   Combine Class

DGROUP . . . . . . . . . . . . .	GROUP
_TEXT  . . . . . . . . . . . . .	16 Bit	 00010000 Word	  Public  'CODE'	
_DATA  . . . . . . . . . . . . .	16 Bit	 0000	  Word	  Public  'DATA'	


Procedures,  parameters and locals:

                N a m e                 Type     Value    Attr

KeyLock  . . . . . . . . . . . .	P Near	 E584	  _TEXT	Length= 0016 Public
  s2 . . . . . . . . . . . . . .	L Near	 E591	  _TEXT	
  exit . . . . . . . . . . . . .	L Near	 E599	  _TEXT	
defint . . . . . . . . . . . . .	P Near	 F78B	  _TEXT	Length= 0001 Public
enableKbIfPresent  . . . . . . .	P Near	 F77F	  _TEXT	Length= 000C Public
  noenablekb . . . . . . . . . .	L Near	 F78A	  _TEXT	
getps2byte . . . . . . . . . . .	P Near	 F754	  _TEXT	Length= 001A Public
  gps2b2 . . . . . . . . . . . .	L Near	 F759	  _TEXT	
  gps2b1 . . . . . . . . . . . .	L Near	 F769	  _TEXT	
int07  . . . . . . . . . . . . .	P Near	 E2F1	  _TEXT	Length= 0030 Public
  int07_pfx  . . . . . . . . . .	L Near	 E2FA	  _TEXT	
  int072 . . . . . . . . . . . .	L Near	 E313	  _TEXT	
int08  . . . . . . . . . . . . .	P Near	 E321	  _TEXT	Length= 0056 Public
  int08_nodec  . . . . . . . . .	L Near	 E330	  _TEXT	
  int081 . . . . . . . . . . . .	L Near	 E359	  _TEXT	
  kloop  . . . . . . . . . . . .	L Near	 E35F	  _TEXT	
  kbdata . . . . . . . . . . . .	L Near	 E371	  _TEXT	
  nokey  . . . . . . . . . . . .	L Near	 E373	  _TEXT	
int09  . . . . . . . . . . . . .	P Near	 E377	  _TEXT	Length= 020D Public
  SecondACK  . . . . . . . . . .	L Near	 E3A1	  _TEXT	
  ToggleACK  . . . . . . . . . .	L Near	 E3A4	  _TEXT	
  SetFlags1  . . . . . . . . . .	L Near	 E3A7	  _TEXT	
  noACK  . . . . . . . . . . . .	L Near	 E3AA	  _TEXT	
  noE0 . . . . . . . . . . . . .	L Near	 E3BD	  _TEXT	
  noE1 . . . . . . . . . . . . .	L Near	 E3C6	  _TEXT	
  noDEL  . . . . . . . . . . . .	L Near	 E3E2	  _TEXT	
  noLSDown . . . . . . . . . . .	L Near	 E3F0	  _TEXT	
  noLSUp . . . . . . . . . . . .	L Near	 E3F9	  _TEXT	
  noRSDown . . . . . . . . . . .	L Near	 E402	  _TEXT	
  noRSUp . . . . . . . . . . . .	L Near	 E40B	  _TEXT	
  LALTDn . . . . . . . . . . . .	L Near	 E41C	  _TEXT	
  noALTDown  . . . . . . . . . .	L Near	 E422	  _TEXT	
  LALTUp . . . . . . . . . . . .	L Near	 E433	  _TEXT	
  ALTUp  . . . . . . . . . . . .	L Near	 E437	  _TEXT	
  noALTUp  . . . . . . . . . . .	L Near	 E444	  _TEXT	
  SetFlagsKey2 . . . . . . . . .	L Near	 E453	  _TEXT	
  LCTLDn . . . . . . . . . . . .	L Near	 E455	  _TEXT	
  noCTLDown  . . . . . . . . . .	L Near	 E45B	  _TEXT	
  LCTLUp . . . . . . . . . . . .	L Near	 E46C	  _TEXT	
  noCTLUp  . . . . . . . . . . .	L Near	 E472	  _TEXT	
  noScrLock  . . . . . . . . . .	L Near	 E4A5	  _TEXT	
  testINS  . . . . . . . . . . .	L Near	 E4B4	  _TEXT	
  noIns  . . . . . . . . . . . .	L Near	 E4BA	  _TEXT	
  SetFlagsKey1 . . . . . . . . .	L Near	 E4CE	  _TEXT	
  E0Key  . . . . . . . . . . . .	L Near	 E4D1	  _TEXT	
  NormalKey  . . . . . . . . . .	L Near	 E4E6	  _TEXT	
  KeyDown  . . . . . . . . . . .	L Near	 E4FA	  _TEXT	
  noShift  . . . . . . . . . . .	L Near	 E503	  _TEXT	
  noCaps . . . . . . . . . . . .	L Near	 E511	  _TEXT	
  NumDown  . . . . . . . . . . .	L Near	 E51C	  _TEXT	
  noNum  . . . . . . . . . . . .	L Near	 E51F	  _TEXT	
  noCtrl . . . . . . . . . . . .	L Near	 E526	  _TEXT	
  noAlt  . . . . . . . . . . . .	L Near	 E52D	  _TEXT	
  pushKey  . . . . . . . . . . .	L Near	 E54B	  _TEXT	
  SetFlagsKey  . . . . . . . . .	L Near	 E556	  _TEXT	
  SetFlags . . . . . . . . . . .	L Near	 E559	  _TEXT	
  SF1  . . . . . . . . . . . . .	L Near	 E574	  _TEXT	
  int09Exit  . . . . . . . . . .	L Near	 E57C	  _TEXT	
int10  . . . . . . . . . . . . .	P Near	 E59A	  _TEXT	Length= 0A31 Public
  exit . . . . . . . . . . . . .	L Near	 E5B9	  _TEXT	
  svga . . . . . . . . . . . . .	L Near	 E5BC	  _TEXT	
  VESAGetInfo  . . . . . . . . .	L Near	 E5D1	  _TEXT	
  VESASupportedClear . . . . . .	L Near	 E5DE	  _TEXT	
  VESASupported  . . . . . . . .	L Near	 E5E4	  _TEXT	
  VESASupportedErr . . . . . . .	L Near	 E5E6	  _TEXT	
  VESAGetModeInfo  . . . . . . .	L Near	 E5EA	  _TEXT	
  VESAGetModeInfo1 . . . . . . .	L Near	 E5EE	  _TEXT	
  VESASetMode  . . . . . . . . .	L Near	 E601	  _TEXT	
  VESASetMode1 . . . . . . . . .	L Near	 E613	  _TEXT	
  VESAGetMode  . . . . . . . . .	L Near	 E61B	  _TEXT	
  VESAGetMode1 . . . . . . . . .	L Near	 E631	  _TEXT	
  VESAMemControl . . . . . . . .	L Near	 E637	  _TEXT	
  VESAMemControlCB . . . . . . .	L Near	 E63B	  _TEXT	
  getpageinfo  . . . . . . . . .	L Near	 E655	  _TEXT	
  VESAModeInfo . . . . . . . . .	L Near	 E68B	  _TEXT	
  ModeTab  . . . . . . . . . . .	L Near	 E69E	  _TEXT	
  setmode  . . . . . . . . . . .	L Near	 E785	  _TEXT	
  setmode1 . . . . . . . . . . .	L Near	 E7EA	  _TEXT	
  setmode1_pcjr  . . . . . . . .	L Near	 E7FA	  _TEXT	
  setmode1b  . . . . . . . . . .	L Near	 E7FC	  _TEXT	
  setmode1a  . . . . . . . . . .	L Near	 E819	  _TEXT	
  setmode11  . . . . . . . . . .	L Near	 E837	  _TEXT	
  setmode12  . . . . . . . . . .	L Near	 E84F	  _TEXT	
  setmode1221  . . . . . . . . .	L Near	 E859	  _TEXT	
  setmode122 . . . . . . . . . .	L Near	 E867	  _TEXT	
  setmode121 . . . . . . . . . .	L Near	 E881	  _TEXT	
  setmode13  . . . . . . . . . .	L Near	 E890	  _TEXT	
  setmode3 . . . . . . . . . . .	L Near	 E8A8	  _TEXT	
  setmode21  . . . . . . . . . .	L Near	 E8C1	  _TEXT	
  setmode2 . . . . . . . . . . .	L Near	 E8C9	  _TEXT	
  setmode2a  . . . . . . . . . .	L Near	 E8DA	  _TEXT	
  clearnext  . . . . . . . . . .	L Near	 E956	  _TEXT	
  clearok  . . . . . . . . . . .	L Near	 E96A	  _TEXT	
  setmode4 . . . . . . . . . . .	L Near	 E96A	  _TEXT	
  setmodeexit  . . . . . . . . .	L Near	 E9C3	  _TEXT	
  nullproc . . . . . . . . . . .	L Near	 E9D5	  _TEXT	
  cursor . . . . . . . . . . . .	L Near	 E9D6	  _TEXT	
  cursor8  . . . . . . . . . . .	L Near	 E9E7	  _TEXT	
  curpos . . . . . . . . . . . .	L Near	 E9F6	  _TEXT	
  curpos1  . . . . . . . . . . .	L Near	 EA28	  _TEXT	
  getcurpos  . . . . . . . . . .	L Near	 EA2B	  _TEXT	
  lightpen . . . . . . . . . . .	L Near	 EA3B	  _TEXT	
  apage  . . . . . . . . . . . .	L Near	 EA3E	  _TEXT	
  apage1 . . . . . . . . . . . .	L Near	 EA66	  _TEXT	
  apage3 . . . . . . . . . . . .	L Near	 EA74	  _TEXT	
  apage2 . . . . . . . . . . . .	L Near	 EA76	  _TEXT	
  apage4 . . . . . . . . . . . .	L Near	 EA79	  _TEXT	
  scrollup . . . . . . . . . . .	L Near	 EA94	  _TEXT	
  scrollup6  . . . . . . . . . .	L Near	 EA9E	  _TEXT	
  scrollup4  . . . . . . . . . .	L Near	 EAB5	  _TEXT	
  scrollup3  . . . . . . . . . .	L Near	 EAC2	  _TEXT	
  scrollup5  . . . . . . . . . .	L Near	 EAC7	  _TEXT	
  scrollexit . . . . . . . . . .	L Near	 EAD1	  _TEXT	
  scrolldn . . . . . . . . . . .	L Near	 EAD4	  _TEXT	
  scr_params . . . . . . . . . .	L Near	 EAE5	  _TEXT	
  readchar . . . . . . . . . . .	L Near	 EAFB	  _TEXT	
  mode3chaddr  . . . . . . . . .	L Near	 EB03	  _TEXT	
  writecharattr  . . . . . . . .	L Near	 EB21	  _TEXT	
  writechar  . . . . . . . . . .	L Near	 EB37	  _TEXT	
  writechar3 . . . . . . . . . .	L Near	 EB3E	  _TEXT	
  writecharskip  . . . . . . . .	L Near	 EB47	  _TEXT	
  setcolorpalette  . . . . . . .	L Near	 EB48	  _TEXT	
  setcolorpalette_pal  . . . . .	L Near	 EB60	  _TEXT	
  setcolorpalette_out  . . . . .	L Near	 EB67	  _TEXT	
  writecharTTY . . . . . . . . .	L Near	 EB6E	  _TEXT	
  tty  . . . . . . . . . . . . .	L Near	 EB8C	  _TEXT	
  tty1 . . . . . . . . . . . . .	L Near	 EBB1	  _TEXT	
  bell . . . . . . . . . . . . .	L Near	 EBB3	  _TEXT	
  bs . . . . . . . . . . . . . .	L Near	 EBB5	  _TEXT	
  lf . . . . . . . . . . . . . .	L Near	 EBBD	  _TEXT	
  crlf . . . . . . . . . . . . .	L Near	 EBC1	  _TEXT	
  cr . . . . . . . . . . . . . .	L Near	 EBC3	  _TEXT	
  readmode . . . . . . . . . . .	L Near	 EBE5	  _TEXT	
  pal  . . . . . . . . . . . . .	L Near	 EC2F	  _TEXT	
  palexit  . . . . . . . . . . .	L Near	 EC3C	  _TEXT	
  setonereg  . . . . . . . . . .	L Near	 EC3D	  _TEXT	
  setonereg1 . . . . . . . . . .	L Near	 EC4C	  _TEXT	
  setallreg  . . . . . . . . . .	L Near	 EC4D	  _TEXT	
  setallreg1 . . . . . . . . . .	L Near	 EC54	  _TEXT	
  setblink . . . . . . . . . . .	L Near	 EC61	  _TEXT	
  setblink1  . . . . . . . . . .	L Near	 EC8B	  _TEXT	
  readonereg . . . . . . . . . .	L Near	 EC8D	  _TEXT	
  readallreg . . . . . . . . . .	L Near	 ECA2	  _TEXT	
  readllreg1 . . . . . . . . . .	L Near	 ECA7	  _TEXT	
  readoverscan . . . . . . . . .	L Near	 ECB9	  _TEXT	
  setoneDAC  . . . . . . . . . .	L Near	 ECBC	  _TEXT	
  setblockDAC  . . . . . . . . .	L Near	 ECD2	  _TEXT	
  paging . . . . . . . . . . . .	L Near	 ECE3	  _TEXT	
  paging1  . . . . . . . . . . .	L Near	 ED04	  _TEXT	
  paging3  . . . . . . . . . . .	L Near	 ED0B	  _TEXT	
  paging2  . . . . . . . . . . .	L Near	 ED10	  _TEXT	
  readoneDAC . . . . . . . . . .	L Near	 ED13	  _TEXT	
  readblockDAC . . . . . . . . .	L Near	 ED2B	  _TEXT	
  setPELmask . . . . . . . . . .	L Near	 ED3C	  _TEXT	
  getPELmask . . . . . . . . . .	L Near	 ED45	  _TEXT	
  getpaging  . . . . . . . . . .	L Near	 ED4E	  _TEXT	
  getpaging1 . . . . . . . . . .	L Near	 ED63	  _TEXT	
  grayscale  . . . . . . . . . .	L Near	 ED64	  _TEXT	
  grayscale1 . . . . . . . . . .	L Near	 ED69	  _TEXT	
  grayscale2 . . . . . . . . . .	L Near	 ED91	  _TEXT	
  loadUDF  . . . . . . . . . . .	L Near	 ED92	  _TEXT	
  loadUDF1 . . . . . . . . . . .	L Near	 ED9E	  _TEXT	
  loadUDFexit1 . . . . . . . . .	L Near	 EDDD	  _TEXT	
  loadUDFexit  . . . . . . . . .	L Near	 EDDE	  _TEXT	
  chargen  . . . . . . . . . . .	L Near	 EDDF	  _TEXT	
  loadROMFont8 . . . . . . . . .	L Near	 EE02	  _TEXT	
  loadROMFont16  . . . . . . . .	L Near	 EE0D	  _TEXT	
  loadROMFont161 . . . . . . . .	L Near	 EE16	  _TEXT	
  set1f  . . . . . . . . . . . .	L Near	 EE25	  _TEXT	
  setgrUDF . . . . . . . . . . .	L Near	 EE30	  _TEXT	
  setgrUDF1  . . . . . . . . . .	L Near	 EE50	  _TEXT	
  setgrUDFexit . . . . . . . . .	L Near	 EE5B	  _TEXT	
  setROMgrFont . . . . . . . . .	L Near	 EE5D	  _TEXT	
  setROMgrFont1  . . . . . . . .	L Near	 EE6E	  _TEXT	
  getfontinfo  . . . . . . . . .	L Near	 EE7B	  _TEXT	
  getfontinfo1 . . . . . . . . .	L Near	 EE96	  _TEXT	
  getfontinfoexit  . . . . . . .	L Near	 EEA9	  _TEXT	
  special  . . . . . . . . . . .	L Near	 EEB6	  _TEXT	
  special1 . . . . . . . . . . .	L Near	 EEC6	  _TEXT	
  special2 . . . . . . . . . . .	L Near	 EEDA	  _TEXT	
  writestr . . . . . . . . . . .	L Near	 EEDD	  _TEXT	
  wstr1  . . . . . . . . . . . .	L Near	 EEEC	  _TEXT	
  noattr . . . . . . . . . . . .	L Near	 EEFA	  _TEXT	
  wstr2  . . . . . . . . . . . .	L Near	 EF0F	  _TEXT	
  wstrexit . . . . . . . . . . .	L Near	 EF10	  _TEXT	
  getdcc . . . . . . . . . . . .	L Near	 EF11	  _TEXT	
  setdcc . . . . . . . . . . . .	L Near	 EF1C	  _TEXT	
  getdccexit . . . . . . . . . .	L Near	 EF21	  _TEXT	
  querystatus  . . . . . . . . .	L Near	 EF22	  _TEXT	
  querystatus1 . . . . . . . . .	L Near	 EF54	  _TEXT	
  querystatus3 . . . . . . . . .	L Near	 EF5E	  _TEXT	
int11  . . . . . . . . . . . . .	P Near	 EFCB	  _TEXT	Length= 0009 Public
int12  . . . . . . . . . . . . .	P Near	 EFD4	  _TEXT	Length= 0009 Public
int13  . . . . . . . . . . . . .	P Near	 EFDD	  _TEXT	Length= 01ED Public
  inINT13  . . . . . . . . . . .	L Near	 EFFC	  _TEXT	
  Disk1  . . . . . . . . . . . .	L Near	 F000	  _TEXT	
  exit . . . . . . . . . . . . .	L Near	 F010	  _TEXT	
  exit2  . . . . . . . . . . . .	L Near	 F014	  _TEXT	
  exit1  . . . . . . . . . . . .	L Near	 F01B	  _TEXT	
  DiskGetType  . . . . . . . . .	L Near	 F06E	  _TEXT	
  DiskGetTypeexit  . . . . . . .	L Near	 F085	  _TEXT	
  DiskExtInstCheck . . . . . . .	L Near	 F08E	  _TEXT	
  DiskReset  . . . . . . . . . .	L Near	 F09C	  _TEXT	
  DiskChanged  . . . . . . . . .	L Near	 F09C	  _TEXT	
  DiskPark . . . . . . . . . . .	L Near	 F09C	  _TEXT	
  DiskGetStatus  . . . . . . . .	L Near	 F09F	  _TEXT	
  DiskVerify . . . . . . . . . .	L Near	 F0A4	  _TEXT	
  DiskWrite  . . . . . . . . . .	L Near	 F0A9	  _TEXT	
  DiskRead . . . . . . . . . . .	L Near	 F0AE	  _TEXT	
  DiskRead1  . . . . . . . . . .	L Near	 F0B1	  _TEXT	
  DiskReadend  . . . . . . . . .	L Near	 F0D9	  _TEXT	
  HCStoLBA . . . . . . . . . . .	L Near	 F0DA	  _TEXT	
  DiskFormat . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskInit . . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskSeek . . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskRst  . . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskReady  . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskRecalibrate  . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskDiag . . . . . . . . . . .	L Near	 F0F8	  _TEXT	
  DiskExtSeek  . . . . . . . . .	L Near	 F0F8	  _TEXT	
  notready . . . . . . . . . . .	L Near	 F104	  _TEXT	
  DiskGetParams  . . . . . . . .	L Near	 F107	  _TEXT	
  dgpok  . . . . . . . . . . . .	L Near	 F12F	  _TEXT	
  DiskExtVerify  . . . . . . . .	L Near	 F13E	  _TEXT	
  DiskExtWrite . . . . . . . . .	L Near	 F143	  _TEXT	
  DiskExtRead  . . . . . . . . .	L Near	 F148	  _TEXT	
  DiskExtRead1 . . . . . . . . .	L Near	 F14B	  _TEXT	
  DiskExtGetParams . . . . . . .	L Near	 F17A	  _TEXT	
  DiskReadSectBuffer . . . . . .	L Near	 F1C7	  _TEXT	
  DiskWriteSectBuffer  . . . . .	L Near	 F1C7	  _TEXT	
  DiskSetDASDType  . . . . . . .	L Near	 F1C7	  _TEXT	
  DiskSetMediaType . . . . . . .	L Near	 F1C7	  _TEXT	
  DiskExtLock  . . . . . . . . .	L Near	 F1C7	  _TEXT	
  DiskExtEject . . . . . . . . .	L Near	 F1C7	  _TEXT	
int14  . . . . . . . . . . . . .	P Near	 F1CA	  _TEXT	Length= 0081 Public
  SExit  . . . . . . . . . . . .	L Near	 F1F1	  _TEXT	
  SetCharFormat  . . . . . . . .	L Near	 F1F5	  _TEXT	
  Baud110  . . . . . . . . . . .	L Near	 F20E	  _TEXT	
  GetPortStatus  . . . . . . . .	L Near	 F224	  _TEXT	
  GetPortStatus1 . . . . . . . .	L Near	 F227	  _TEXT	
  STransmit  . . . . . . . . . .	L Near	 F22E	  _TEXT	
  STr1 . . . . . . . . . . . . .	L Near	 F231	  _TEXT	
  STr2 . . . . . . . . . . . . .	L Near	 F23C	  _TEXT	
  SReceive . . . . . . . . . . .	L Near	 F23F	  _TEXT	
  SReceive1  . . . . . . . . . .	L Near	 F240	  _TEXT	
int16  . . . . . . . . . . . . .	P Near	 F4CF	  _TEXT	Length= 00EB Public
  kbfunc . . . . . . . . . . . .	L Near	 F4F7	  _TEXT	
  Exit . . . . . . . . . . . . .	L Near	 F4F9	  _TEXT	
  GetKey1  . . . . . . . . . . .	L Near	 F4FC	  _TEXT	
  GetKey . . . . . . . . . . . .	L Near	 F4FD	  _TEXT	
  noWrap . . . . . . . . . . . .	L Near	 F513	  _TEXT	
  TestKey  . . . . . . . . . . .	L Near	 F519	  _TEXT	
  StoreKey . . . . . . . . . . .	L Near	 F528	  _TEXT	
  NoWrap1  . . . . . . . . . . .	L Near	 F53A	  _TEXT	
  ExtStatus  . . . . . . . . . .	L Near	 F549	  _TEXT	
  NoSysReq . . . . . . . . . . .	L Near	 F554	  _TEXT	
  GetStatus  . . . . . . . . . .	L Near	 F55D	  _TEXT	
  Exit1  . . . . . . . . . . . .	L Near	 F560	  _TEXT	
  SetAutoRpt . . . . . . . . . .	L Near	 F562	  _TEXT	
  timeout1 . . . . . . . . . . .	L Near	 F598	  _TEXT	
  timeout  . . . . . . . . . . .	L Near	 F59D	  _TEXT	
  WaitFlag . . . . . . . . . . .	L Near	 F5A0	  _TEXT	
  wf_loop  . . . . . . . . . . .	L Near	 F5A5	  _TEXT	
  wf_ok  . . . . . . . . . . . .	L Near	 F5B9	  _TEXT	
int18  . . . . . . . . . . . . .	P Near	 F5BA	  _TEXT	Length= 007C Public
  sloop  . . . . . . . . . . . .	L Near	 F5E1	  _TEXT	
int19  . . . . . . . . . . . . .	P Near	 F636	  _TEXT	Length= 001A Public
  int19err . . . . . . . . . . .	L Near	 F64E	  _TEXT	
int1a  . . . . . . . . . . . . .	P Near	 F650	  _TEXT	Length= 002C Public
  clockexit1 . . . . . . . . . .	L Near	 F666	  _TEXT	
  clockexit  . . . . . . . . . .	L Near	 F66B	  _TEXT	
  setclock . . . . . . . . . . .	L Near	 F671	  _TEXT	
int70  . . . . . . . . . . . . .	P Near	 F67C	  _TEXT	Length= 0038 Public
  exit1  . . . . . . . . . . . .	L Near	 F6A2	  _TEXT	
  exit . . . . . . . . . . . . .	L Near	 F6A8	  _TEXT	
int74  . . . . . . . . . . . . .	P Near	 F6B4	  _TEXT	Length= 004F Public
  docall . . . . . . . . . . . .	L Near	 F6D9	  _TEXT	
  nocall . . . . . . . . . . . .	L Near	 F6F8	  _TEXT	
sdinit . . . . . . . . . . . . .	P Near	 F955	  _TEXT	Length= 009D Public
  sdinit1  . . . . . . . . . . .	L Near	 F960	  _TEXT	
  repinit  . . . . . . . . . . .	L Near	 F990	  _TEXT	
  sdexit . . . . . . . . . . . .	L Near	 F9E4	  _TEXT	
sdrblk . . . . . . . . . . . . .	P Near	 F7FF	  _TEXT	Length= 0030 Public
  sdrblk1  . . . . . . . . . . .	L Near	 F807	  _TEXT	
  sdrblk2  . . . . . . . . . . .	L Near	 F80C	  _TEXT	
sdwblk . . . . . . . . . . . . .	P Near	 F7CC	  _TEXT	Length= 0033 Public
  sdwblk1  . . . . . . . . . . .	L Near	 F7CE	  _TEXT	
sendcmd  . . . . . . . . . . . .	P Near	 F76E	  _TEXT	Length= 0011 Public
  retry  . . . . . . . . . . . .	L Near	 F775	  _TEXT	
  exit . . . . . . . . . . . . .	L Near	 F77E	  _TEXT	
sendps2byte  . . . . . . . . . .	P Near	 F72F	  _TEXT	Length= 0025 Public
  sps2b2 . . . . . . . . . . . .	L Near	 F735	  _TEXT	
  sps2b1 . . . . . . . . . . . .	L Near	 F746	  _TEXT	
  sps2_kb  . . . . . . . . . . .	L Near	 F74E	  _TEXT	
  exit . . . . . . . . . . . . .	L Near	 F752	  _TEXT	


Symbols:

                N a m e                 Type     Value    Attr

@CodeSize  . . . . . . . . . . .	Number	 0000h	 
@DataSize  . . . . . . . . . . .	Number	 0000h	 
@Interface . . . . . . . . . . .	Number	 0000h	 
@Model . . . . . . . . . . . . .	Number	 0001h	 
@code  . . . . . . . . . . . . .	Text   	 DGROUP
@data  . . . . . . . . . . . . .	Text   	 DGROUP
@fardata?  . . . . . . . . . . .	Text   	 FAR_BSS
@fardata . . . . . . . . . . . .	Text   	 FAR_DATA
@stack . . . . . . . . . . . . .	Text   	 DGROUP
AckReceived  . . . . . . . . . .	Number	 0010h	 
ActivePage . . . . . . . . . . .	Text   	 ds:[62h]
ActiveVideoMode  . . . . . . . .	Text   	 ds:[49h]
AltDown  . . . . . . . . . . . .	Number	 0008h	 
AltKpd . . . . . . . . . . . . .	Text   	 ds:[19h]
Buffer . . . . . . . . . . . . .	Text   	 ds:[80h]
COMFlush . . . . . . . . . . . .	L Near	 E20E	  _TEXT	
CapsLockDown . . . . . . . . . .	Number	 0040h	 
CapsLockLED  . . . . . . . . . .	Number	 0004h	 
CapsLock . . . . . . . . . . . .	Number	 0040h	 
ComPort  . . . . . . . . . . . .	Number	 0000h	 
CrtMode  . . . . . . . . . . . .	Text   	 ds:[65h]
CrtPalette . . . . . . . . . . .	Text   	 ds:[66h]
CtrlBreak  . . . . . . . . . . .	Text   	 ds:[71h]
CtrlDown . . . . . . . . . . . .	Number	 0004h	 
CursorPos  . . . . . . . . . . .	Text   	 ds:[50h]
CursorShape  . . . . . . . . . .	Text   	 ds:[60h]
DLH  . . . . . . . . . . . . . .	Number	 0001h	 
DLL  . . . . . . . . . . . . . .	Number	 0000h	 
DataBuffer . . . . . . . . . . .	Text   	 ds:[0a5h]
DataCounter  . . . . . . . . . .	Text   	 ds:[067h]
E0KeyIndex . . . . . . . . . . .	L Near	 FCF1	  _TEXT	
E0KeyList  . . . . . . . . . . .	L Near	 FCE5	  _TEXT	
EgaMiscInfo2 . . . . . . . . . .	Text   	 ds:[88h]
EgaMiscInfo  . . . . . . . . . .	Text   	 ds:[87h]
EndBuf . . . . . . . . . . . . .	Text   	 ds:[82h]
EquipmentWord  . . . . . . . . .	Text   	 ds:[10h]
ExtSize  . . . . . . . . . . . .	L Near	 F39D	  _TEXT	
FreeXMSKb  . . . . . . . . . . .	Number	 7B60h	 
GetConfig  . . . . . . . . . . .	L Near	 F3A2	  _TEXT	
HDLastError  . . . . . . . . . .	Text   	 ds:[74h]
HDOpStarted  . . . . . . . . . .	Text   	 ds:[92h]
HDSize . . . . . . . . . . . . .	Text   	 ds:[94h]
HandlerPtr . . . . . . . . . . .	Text   	 ds:[0a1h]
HeadPtr  . . . . . . . . . . . .	Text   	 ds:[1ah]
IER  . . . . . . . . . . . . . .	Number	 0001h	 
IncSeg1  . . . . . . . . . . . .	L Near	 F259	  _TEXT	
IncSeg . . . . . . . . . . . . .	L Near	 F24B	  _TEXT	
InsDown  . . . . . . . . . . . .	Number	 0080h	 
Insert . . . . . . . . . . . . .	Number	 0080h	 
KbdFlags1  . . . . . . . . . . .	Text   	 ds:[17h]
KbdFlags2  . . . . . . . . . . .	Text   	 ds:[18h]
KbdFlags3  . . . . . . . . . . .	Text   	 ds:[96h]
KbdFlags4  . . . . . . . . . . .	Text   	 ds:[97h]
KeyCode  . . . . . . . . . . . .	L Near	 FCFD	  _TEXT	
KeyIndex . . . . . . . . . . . .	L Near	 FC8C	  _TEXT	
LAltDown . . . . . . . . . . . .	Number	 0002h	 
LCR  . . . . . . . . . . . . . .	Number	 0003h	 
LCtrDown . . . . . . . . . . . .	Number	 0001h	 
LEDUpdate  . . . . . . . . . . .	Number	 0040h	 
LSR  . . . . . . . . . . . . . .	Number	 0005h	 
LShfDown . . . . . . . . . . . .	Number	 0002h	 
LastE0 . . . . . . . . . . . . .	Number	 0002h	 
LastE1 . . . . . . . . . . . . .	Number	 0001h	 
LastF0 . . . . . . . . . . . . .	Number	 0020h	 
MSR  . . . . . . . . . . . . . .	Number	 0006h	 
MemorySize . . . . . . . . . . .	Text   	 ds:[13h]
Mouse  . . . . . . . . . . . . .	L Near	 F3AB	  _TEXT	
MovExt1  . . . . . . . . . . . .	L Near	 F2C2	  _TEXT	
MovExt2  . . . . . . . . . . . .	L Near	 F2D4	  _TEXT	
MovExtLoop . . . . . . . . . . .	L Near	 F2B9	  _TEXT	
MovExtProxy  . . . . . . . . . .	L Near	 F312	  _TEXT	
MovExt_exit  . . . . . . . . . .	L Near	 F2FA	  _TEXT	
MovExt_next  . . . . . . . . . .	L Near	 F2E7	  _TEXT	
MovExt . . . . . . . . . . . . .	L Near	 F279	  _TEXT	
MovSeg . . . . . . . . . . . . .	Number	 0001h	 
NumLockDown  . . . . . . . . . .	Number	 0020h	 
NumLockLED . . . . . . . . . . .	Number	 0002h	 
NumLock  . . . . . . . . . . . .	Number	 0020h	 
PacketSize . . . . . . . . . . .	Text   	 ds:[068h]
PageOffset . . . . . . . . . . .	Text   	 ds:[4eh]
Pal256 . . . . . . . . . . . . .	L Near	 FA1C	  _TEXT	
PalEGA . . . . . . . . . . . . .	L Near	 FAEC	  _TEXT	
PalOffset  . . . . . . . . . . .	Text   	 ds:[69h]
PalVGA . . . . . . . . . . . . .	L Near	 FBBC	  _TEXT	
Pause  . . . . . . . . . . . . .	Number	 0008h	 
PortAddress  . . . . . . . . . .	Text   	 ds:[63h]
RAMSize  . . . . . . . . . . . .	Number	 0200h	 
RAltDown . . . . . . . . . . . .	Number	 0008h	 
RBR  . . . . . . . . . . . . . .	Number	 0000h	 
RCtrDown . . . . . . . . . . . .	Number	 0004h	 
RShfDown . . . . . . . . . . . .	Number	 0001h	 
RegenLength  . . . . . . . . . .	Text   	 ds:[4ch]
SCANCODE1  . . . . . . . . . . .	Number	 0001h	 
SD_CMD0  . . . . . . . . . . . .	Byte	 F9F2	  _TEXT	
SD_CMD12 . . . . . . . . . . . .	Byte	 FA04	  _TEXT	
SD_CMD41 . . . . . . . . . . . .	Byte	 FA0A	  _TEXT	
SD_CMD55 . . . . . . . . . . . .	Byte	 FA10	  _TEXT	
SD_CMD58 . . . . . . . . . . . .	Byte	 FA16	  _TEXT	
SD_CMD8  . . . . . . . . . . . .	Byte	 F9F8	  _TEXT	
SD_CMD9  . . . . . . . . . . . .	Byte	 F9FE	  _TEXT	
ScanLinesChar  . . . . . . . . .	Text   	 ds:[85h]
ScrLockDown  . . . . . . . . . .	Number	 0010h	 
ScrLockLED . . . . . . . . . . .	Number	 0001h	 
ScrLock  . . . . . . . . . . . .	Number	 0010h	 
ScreenRows . . . . . . . . . . .	Text   	 ds:[84h]
ScreenWidth  . . . . . . . . . .	Text   	 ds:[4ah]
SetEventWait . . . . . . . . . .	L Near	 F34F	  _TEXT	
SetRepeat  . . . . . . . . . . .	Number	 0008h	 
SetSeg1  . . . . . . . . . . . .	L Near	 F271	  _TEXT	
SetSeg2  . . . . . . . . . . . .	L Near	 F269	  _TEXT	
SetSegExit . . . . . . . . . . .	L Near	 F272	  _TEXT	
SetSeg . . . . . . . . . . . . .	L Near	 F25E	  _TEXT	
SysParams  . . . . . . . . . . .	Byte	 F4C5	  _TEXT	
SysReqDown . . . . . . . . . . .	Number	 0004h	 
THR  . . . . . . . . . . . . . .	Number	 0000h	 
TailPtr  . . . . . . . . . . . .	Text   	 ds:[1ch]
UFPtr  . . . . . . . . . . . . .	Text   	 ds:[98h]
UWaitFlag  . . . . . . . . . . .	Text   	 ds:[0a0h]
VESAInfo . . . . . . . . . . . .	Byte	 E660	  _TEXT	
VESAModes  . . . . . . . . . . .	Word	 E687	  _TEXT	
VESAOEM  . . . . . . . . . . . .	Byte	 E674	  _TEXT	
VgaFlags2  . . . . . . . . . . .	Text   	 ds:[8ah]
VgaFlags . . . . . . . . . . . .	Text   	 ds:[89h]
Wait1  . . . . . . . . . . . . .	L Near	 F384	  _TEXT	
WaitCount  . . . . . . . . . . .	Text   	 ds:[9ch]
badparam . . . . . . . . . . . .	L Near	 F42C	  _TEXT	
bioscont . . . . . . . . . . . .	Byte	 E275	  _TEXT	
biosmsg  . . . . . . . . . . . .	Byte	 E000	  _TEXT	
bios . . . . . . . . . . . . . .	L Near	 E000	  _TEXT	
booterrmsg . . . . . . . . . . .	Byte	 F5EF	  _TEXT	
busy . . . . . . . . . . . . . .	L Near	 F380	  _TEXT	
cancel . . . . . . . . . . . . .	L Near	 F379	  _TEXT	
coldboot . . . . . . . . . . . .	L Near	 E05B	  _TEXT	
crtc0  . . . . . . . . . . . . .	Byte	 E69E	  _TEXT	
crtc10 . . . . . . . . . . . . .	Byte	 E71C	  _TEXT	
crtc12 . . . . . . . . . . . . .	Byte	 E731	  _TEXT	
crtc13 . . . . . . . . . . . . .	Byte	 E746	  _TEXT	
crtc1  . . . . . . . . . . . . .	Byte	 E6B3	  _TEXT	
crtc4  . . . . . . . . . . . . .	Byte	 E6C8	  _TEXT	
crtc6  . . . . . . . . . . . . .	Byte	 E6DD	  _TEXT	
crtc7  . . . . . . . . . . . . .	Byte	 E6F2	  _TEXT	
crtc9  . . . . . . . . . . . . .	Byte	 E707	  _TEXT	
dac10  . . . . . . . . . . . . .	Byte	 E75B	  _TEXT	
dccval . . . . . . . . . . . . .	Word	 EF1C	  _TEXT	
disablemouseinterrupt  . . . . .	L Near	 F4AB	  _TEXT	
disktbl  . . . . . . . . . . . .	Word	 F028	  _TEXT	
dispAX1  . . . . . . . . . . . .	L Near	 F79B	  _TEXT	
dispAX . . . . . . . . . . . . .	L Near	 F78C	  _TEXT	
dly1 . . . . . . . . . . . . . .	L Near	 F726	  _TEXT	
dlybit . . . . . . . . . . . . .	L Near	 F722	  _TEXT	
done . . . . . . . . . . . . . .	L Near	 F346	  _TEXT	
en_dis . . . . . . . . . . . . .	L Near	 F3FF	  _TEXT	
enablemouseinterrupt . . . . . .	L Near	 F498	  _TEXT	
errexit  . . . . . . . . . . . .	L Near	 F3BC	  _TEXT	
exit15 . . . . . . . . . . . . .	L Near	 F347	  _TEXT	
exit_ax  . . . . . . . . . . . .	L Near	 F34A	  _TEXT	
exit_iret  . . . . . . . . . . .	L Near	 F34E	  _TEXT	
exit_success1  . . . . . . . . .	L Near	 F414	  _TEXT	
exit_success . . . . . . . . . .	L Near	 F40F	  _TEXT	
exitok . . . . . . . . . . . . .	L Near	 F3BD	  _TEXT	
extend . . . . . . . . . . . . .	L Near	 F46A	  _TEXT	
font8x14 . . . . . . . . . . . .	Text   	 font8x16 - 0e00h
font8x16 . . . . . . . . . . . .	Text   	 font8x8 - 1000h
font8x8  . . . . . . . . . . . .	Text   	 bios - 800h
fontinfo . . . . . . . . . . . .	Word	 EEAA	  _TEXT	
gettype  . . . . . . . . . . . .	L Near	 F452	  _TEXT	
if_err1  . . . . . . . . . . . .	L Near	 F40D	  _TEXT	
if_err . . . . . . . . . . . . .	L Near	 F3B7	  _TEXT	
int15  . . . . . . . . . . . . .	L Near	 F315	  _TEXT	
kbi1 . . . . . . . . . . . . . .	L Near	 E174	  _TEXT	
kbi2 . . . . . . . . . . . . . .	L Near	 E183	  _TEXT	
kbok . . . . . . . . . . . . . .	L Near	 E1B7	  _TEXT	
l1 . . . . . . . . . . . . . . .	L Near	 F717	  _TEXT	
mapi1  . . . . . . . . . . . . .	L Near	 E0A2	  _TEXT	
mapi . . . . . . . . . . . . . .	L Near	 E099	  _TEXT	
mouse_present  . . . . . . . . .	L Near	 F3CC	  _TEXT	
mousei0  . . . . . . . . . . . .	L Near	 E1BF	  _TEXT	
mousei1  . . . . . . . . . . . .	L Near	 E1CD	  _TEXT	
mouseok  . . . . . . . . . . . .	L Near	 E1E9	  _TEXT	
msgkb  . . . . . . . . . . . . .	Byte	 E042	  _TEXT	
msgmb  . . . . . . . . . . . . .	Byte	 E035	  _TEXT	
msgmouse . . . . . . . . . . . .	Byte	 E260	  _TEXT	
nokbmsg  . . . . . . . . . . . .	L Near	 E245	  _TEXT	
nokb . . . . . . . . . . . . . .	L Near	 E1B2	  _TEXT	
nomousemsg . . . . . . . . . . .	L Near	 E252	  _TEXT	
nomouse  . . . . . . . . . . . .	L Near	 E1E0	  _TEXT	
nowait . . . . . . . . . . . . .	L Near	 F381	  _TEXT	
p3c0r10  . . . . . . . . . . . .	Byte	 E69D	  _TEXT	
paltable . . . . . . . . . . . .	Word	 EBF7	  _TEXT	
prtse  . . . . . . . . . . . . .	L Near	 F7B1	  _TEXT	
prts . . . . . . . . . . . . . .	L Near	 F7A5	  _TEXT	
raligned . . . . . . . . . . . .	L Near	 F2E0	  _TEXT	
reset  . . . . . . . . . . . . .	L Near	 F418	  _TEXT	
resolution . . . . . . . . . . .	L Near	 F448	  _TEXT	
sample_tbl . . . . . . . . . . .	Byte	 F4BE	  _TEXT	
sampling . . . . . . . . . . . .	L Near	 F429	  _TEXT	
savesp . . . . . . . . . . . . .	Word	 F275	  _TEXT	
savess . . . . . . . . . . . . .	Word	 F273	  _TEXT	
sc1  . . . . . . . . . . . . . .	Byte	 E770	  _TEXT	
sdcmd1 . . . . . . . . . . . . .	L Near	 F856	  _TEXT	
sdcmd8T  . . . . . . . . . . . .	L Near	 F840	  _TEXT	
sdcmd  . . . . . . . . . . . . .	L Near	 F843	  _TEXT	
sdr11  . . . . . . . . . . . . .	L Near	 F8CB	  _TEXT	
sdr1s  . . . . . . . . . . . . .	L Near	 F86B	  _TEXT	
sdr1 . . . . . . . . . . . . . .	L Near	 F8CC	  _TEXT	
sdr2 . . . . . . . . . . . . . .	L Near	 F8C2	  _TEXT	
sdr3 . . . . . . . . . . . . . .	L Near	 F8B5	  _TEXT	
sdrb . . . . . . . . . . . . . .	L Near	 F7B2	  _TEXT	
sdread1  . . . . . . . . . . . .	L Near	 F85F	  _TEXT	
sdread . . . . . . . . . . . . .	L Near	 F85C	  _TEXT	
sdresp1  . . . . . . . . . . . .	L Near	 F84B	  _TEXT	
sdresp . . . . . . . . . . . . .	L Near	 F849	  _TEXT	
sdrms  . . . . . . . . . . . . .	L Near	 F88C	  _TEXT	
sdsb . . . . . . . . . . . . . .	L Near	 F7B4	  _TEXT	
sdvblk1  . . . . . . . . . . . .	L Near	 F832	  _TEXT	
sdvblk . . . . . . . . . . . . .	L Near	 F82F	  _TEXT	
sdverify . . . . . . . . . . . .	L Near	 F857	  _TEXT	
sdw1s1 . . . . . . . . . . . . .	L Near	 F91B	  _TEXT	
sdw1s  . . . . . . . . . . . . .	L Near	 F8E3	  _TEXT	
sdwms  . . . . . . . . . . . . .	L Near	 F904	  _TEXT	
sdwrite  . . . . . . . . . . . .	L Near	 F8D7	  _TEXT	
sdwwait1 . . . . . . . . . . . .	L Near	 F94B	  _TEXT	
sdwwait  . . . . . . . . . . . .	L Near	 F934	  _TEXT	
send1c . . . . . . . . . . . . .	L Near	 F442	  _TEXT	
send2c . . . . . . . . . . . . .	L Near	 F43B	  _TEXT	
setscaling . . . . . . . . . . .	L Near	 F48D	  _TEXT	
srecb  . . . . . . . . . . . . .	L Near	 F703	  _TEXT	
srstb  . . . . . . . . . . . . .	L Near	 F70B	  _TEXT	
staticfunctable  . . . . . . . .	Byte	 EF81	  _TEXT	
ten  . . . . . . . . . . . . . .	Word	 F7A3	  _TEXT	
vidtbl . . . . . . . . . . . . .	Word	 EF91	  _TEXT	
warmboot . . . . . . . . . . . .	L Near	 E05B	  _TEXT	
wbusy  . . . . . . . . . . . . .	L Near	 F399	  _TEXT	
wloop  . . . . . . . . . . . . .	L Near	 F392	  _TEXT	

	   0 Warnings
	   0 Errors
